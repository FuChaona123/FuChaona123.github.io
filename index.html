<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼è±†å›¾çº¸ç”Ÿæˆå™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .header { background: rgba(255,255,255,0.95); padding: 12px 20px; text-align: center; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.2rem; color: #4a5568; }
        
        .ad-banner { background: rgba(255,255,255,0.9); border: 2px dashed #cbd5e0; margin: 10px; padding: 18px; text-align: center; color: #718096; border-radius: 8px; font-size: 13px; }
        
        .main-container { max-width: 1500px; margin: 0 auto; padding: 10px; display: flex; gap: 12px; flex-wrap: wrap; }
        
        .panel { background: rgba(255,255,255,0.98); border-radius: 12px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .control-panel { width: 280px; flex-shrink: 0; }
        .preview-panel { flex: 1; min-width: 300px; }
        .stats-panel { width: 280px; flex-shrink: 0; display: none; }
        
        .section { margin-bottom: 16px; }
        .section-title { font-weight: 700; color: #2d3748; margin-bottom: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .section-title::before { content: ''; width: 3px; height: 14px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 2px; }
        
        .upload-area { border: 2px dashed #e2e8f0; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f7fafc; }
        .upload-area input { display: none; }
        .upload-area .icon { font-size: 32px; margin-bottom: 5px; }
        
        select { width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; background: white; }
        
        .slider-group { margin: 10px 0; }
        .slider-label { display: flex; justify-content: space-between; font-size: 12px; color: #4a5568; margin-bottom: 4px; }
        .slider-label span:last-child { color: #667eea; font-weight: 600; }
        input[type="range"] { width: 100%; height: 5px; border-radius: 3px; background: #e2e8f0; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); }
        
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #4a5568; }
        .checkbox-item input { width: 14px; height: 14px; accent-color: #667eea; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; display: none; }
        .btn-outline { background: white; border: 2px solid #667eea; color: #667eea; }
        .btn-outline:hover { background: #667eea; color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        
        .preview-area { background: #f7fafc; border-radius: 8px; min-height: 350px; display: flex; align-items: center; justify-content: center; overflow: auto; }
        #canvasWrapper { margin: 12px; }
        canvas { display: block; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        
        .placeholder { text-align: center; color: #a0aec0; }
        .placeholder .icon { font-size: 50px; margin-bottom: 8px; opacity: 0.5; }
        
        .zoom-bar { display: flex; gap: 6px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .zoom-btn { padding: 6px 12px; background: white; border: 1px solid #e2e8f0; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .zoom-btn:hover { border-color: #667eea; }
        
        .stats-header { margin-bottom: 10px; }
        .stats-header h3 { font-size: 14px; color: #2d3748; }
        .stats-summary { background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; }
        .stats-summary p { margin: 3px 0; color: #4a5568; }
        .stats-summary strong { color: #667eea; }
        
        .stats-table-wrap { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            margin-bottom: 10px;
        }
        .stats-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 11px; 
            table-layout: fixed;
        }
        .stats-table th { 
            background: #667eea; 
            color: white; 
            padding: 8px 5px; 
            position: sticky; 
            top: 0; 
            text-align: center;
        }
        .stats-table td { 
            padding: 6px 5px; 
            border-bottom: 1px solid #f0f0f0; 
            text-align: center; 
            word-break: break-word;
        }
        .stats-table tr:hover { background: #f7fafc; }
        .color-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 3px; 
            border: 1px solid #ddd; 
            display: inline-block; 
            vertical-align: middle; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            margin: 0 auto;
        }
        .color-dot.selected { transform: scale(1.2); box-shadow: 0 0 0 2px #667eea, 0 0 8px rgba(102,126,234,0.6); }
        .color-dot:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 20px; max-width: 95%; max-height: 90%; overflow: auto; }
        .modal-content h3 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .modal-tab { padding: 8px 16px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .modal-tab.active { background: #667eea; color: white; border-color: #667eea; }
        .modal-img-wrap { text-align: center; }
        .modal-img-wrap img { max-width: 100%; max-height: 55vh; border: 1px solid #ddd; border-radius: 4px; }
        .modal-img-wrap p { color: #666; font-size: 14px; margin-top: 10px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .modal-btn-primary { background: #667eea; color: white; }
        .modal-btn-success { background: #48bb78; color: white; }
        .modal-btn-close { background: #e2e8f0; color: #333; }
        
        .color-replace-section { display: none; margin-top: 15px; }
        .color-replace-section.show { display: block; }
        
        .selected-color-info { background: #f7fafc; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .selected-color-info p { margin: 5px 0; font-size: 12px; color: #4a5568; }
        .selected-color-info strong { color: #2d3748; }
        
        .replace-options { background: #f7fafc; border-radius: 8px; padding: 12px; }
        .replace-search { margin-bottom: 10px; }
        .replace-search input { width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 12px; }
        
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .palette-color { display: flex; flex-direction: column; align-items: center; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; }
        .palette-color:hover { border-color: #667eea; background: #f7fafc; transform: translateY(-2px); }
        .palette-color.selected { border-color: #667eea; background: #ebf4ff; box-shadow: 0 2px 8px rgba(102,126,234,0.3); }
        .palette-dot { width: 32px; height: 32px; border-radius: 4px; border: 2px solid #e2e8f0; margin-bottom: 5px; }
        .palette-id { font-size: 11px; font-weight: 600; color: #2d3748; }
        .palette-rgb { font-size: 9px; color: #718096; }
        
        .replace-buttons { display: flex; gap: 8px; margin-top: 12px; }
        .replace-buttons .btn { margin: 0; flex: 1; }
        
        @media (max-width: 900px) {
            .main-container { 
                flex-direction: column; 
                gap: 15px;
            }
            .control-panel, .stats-panel { 
                width: 100%; 
                max-width: 100%;
            }
            .stats-panel { 
                order: 3; 
                margin-top: 15px;
                min-height: auto;
            }
            .palette-grid { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
            
            .stats-table-wrap {
                max-height: 500px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                background: white;
            }
            
            .stats-table {
                font-size: 12px;
                width: 100%;
                min-width: 300px;
            }
            
            .stats-table th {
                padding: 10px 6px;
                font-size: 12px;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .stats-table td {
                padding: 8px 6px;
                border-bottom: 1px solid #f0f0f0;
                text-align: center;
                vertical-align: middle;
            }
            
            .stats-table th:nth-child(1),
            .stats-table td:nth-child(1) {
                width: 25%;
                text-align: center;
            }
            
            .stats-table th:nth-child(2),
            .stats-table td:nth-child(2) {
                width: 20%;
            }
            
            .stats-table th:nth-child(3),
            .stats-table td:nth-child(3) {
                width: 25%;
            }
            
            .stats-table th:nth-child(4),
            .stats-table td:nth-child(4) {
                width: 30%;
            }
            
            .color-dot {
                display: block;
                margin: 0 auto;
            }
            
            .panel {
                margin-bottom: 0;
                padding-bottom: 20px;
            }
            
            .stats-summary {
                margin-bottom: 15px;
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-table {
                font-size: 11px;
            }
            
            .stats-table th,
            .stats-table td {
                padding: 6px 4px;
            }
            
            .color-dot {
                width: 14px;
                height: 14px;
            }
            
            .stats-summary {
                font-size: 11px;
                padding: 10px;
            }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #f56565;
        }
        
        .toast.info {
            background: #4299e1;
        }
        
        .toast.warning {
            background: #ed8936;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
        }
        
        .loading.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-options {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .download-options.show {
            display: flex;
        }
        
        .download-options-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .download-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .download-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .download-option-icon {
            font-size: 24px;
            margin-right: 12px;
            width: 40px;
            text-align: center;
        }
        
        .download-option-text {
            flex: 1;
            text-align: left;
        }
        
        .download-option-title {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }
        
        .download-option-desc {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }
        
        .download-options-title {
            margin-bottom: 20px;
            font-size: 16px;
            color: #2d3748;
        }
        
        .remember-option {
            margin-top: 15px;
            text-align: left;
            font-size: 13px;
        }
        
        .remember-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #4a5568;
        }
        
        .remember-option input {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }
        
        .mobile-download-guide {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            z-index: 4000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .mobile-download-guide.show {
            display: block;
        }
        
        .mobile-download-guide h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            text-align: center;
        }
        
        .mobile-download-guide ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .mobile-download-guide li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }
        
        .mobile-download-guide .tip {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 13px;
            color: #856404;
        }
        
        .guide-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .guide-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .guide-retry {
            background: #667eea;
            color: white;
        }
        
        .guide-close {
            background: #e2e8f0;
            color: #333;
        }
        
        .download-progress {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 4000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .download-progress.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
        }
        
        .stats-panel.auto-height .stats-table-wrap {
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .stats-panel:after {
            content: '';
            display: table;
            clear: both;
        }
    </style>
</head>
<body>
<div class="header"><h1>ğŸ¨ æ‹¼è±†å›¾çº¸ç”Ÿæˆå™¨</h1></div>
<div class="ad-banner">ğŸ“¢ å¹¿å‘Šä½ 1 (728Ã—90)</div>
<div class="main-container">
    <div class="panel control-panel">
        <div class="section">
            <div class="section-title">ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="icon">ğŸ“</div>
                <p style="font-size:13px;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div id="fileName" style="margin-top:6px;font-size:11px;color:#718096;"></div>
        </div>
        <div class="section">
            <div class="section-title">å›¾çº¸è®¾ç½®</div>
            <div class="slider-group">
                <div class="slider-label"><span>å®½åº¦</span><span id="widthVal">50 æ ¼</span></div>
                <input type="range" id="widthSlider" min="20" max="150" value="50" oninput="document.getElementById('widthVal').textContent=this.value+' æ ¼'">
            </div>
        </div>
        <div class="section">
            <div class="section-title">è‰²æ¿é€‰æ‹©</div>
            <select id="paletteSelect">
                <optgroup label="MARD ç³»åˆ—"><option value="mard_full">MARD å…¨è‰²ç³» (200+è‰²)</option><option value="mard_120">MARD 120è‰²</option><option value="mard_72">MARD 72è‰²</option><option value="mard_48">MARD 48è‰²</option></optgroup>
                <optgroup label="Perler ç³»åˆ—"><option value="perler">Perler å…¨è‰² (60+è‰²)</option></optgroup>
                <optgroup label="Artkal ç³»åˆ—"><option value="artkal_a">Artkal Aç³»åˆ—</option><option value="artkal_c">Artkal Cç³»åˆ—</option></optgroup>
                <optgroup label="å…¶ä»–"><option value="hama">Hama å…¨è‰²ç³»</option></optgroup>
            </select>
        </div>
        <div class="section">
            <div class="section-title">æ˜¾ç¤ºé€‰é¡¹</div>
            <div class="checkbox-grid">
                <label class="checkbox-item"><input type="checkbox" id="showGrid" checked> ç½‘æ ¼çº¿</label>
                <label class="checkbox-item"><input type="checkbox" id="showCode" checked> è‰²å·</label>
                <label class="checkbox-item"><input type="checkbox" id="showLegend" checked> è‰²å¡</label>
                <label class="checkbox-item"><input type="checkbox" id="showRuler" checked> åæ ‡</label>
            </div>
        </div>
        <button class="btn btn-primary" onclick="generatePattern()">âœ¨ ç”Ÿæˆå›¾çº¸</button>
        <button class="btn btn-success" id="downloadBtn" onclick="openDownloadModal()">ğŸ’¾ ä¿å­˜ä¸‹è½½</button>
        
        <div class="color-replace-section" id="colorReplaceSection">
            <div class="section-title">ğŸ¨ è‰²å·æ›¿æ¢</div>
            <div class="selected-color-info" id="selectedColorInfo">
                <p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>
            </div>
            <div class="replace-options" id="replaceOptions" style="display:none;">
                <div class="replace-search">
                    <input type="text" id="paletteSearch" placeholder="æœç´¢è‰²å·æˆ–é¢œè‰²..." oninput="searchPalette()">
                </div>
                <div class="palette-grid" id="paletteGrid"></div>
                <div class="replace-buttons">
                    <button class="btn btn-primary" onclick="replaceColor()">âœ… æ›¿æ¢é¢œè‰²</button>
                    <button class="btn btn-outline" onclick="cancelReplace()">å–æ¶ˆ</button>
                </div>
            </div>
            <button class="btn btn-warning" onclick="resetAllColors()" style="margin-top:10px;">ğŸ”„ é‡ç½®æ‰€æœ‰é¢œè‰²</button>
        </div>
        
        <div class="ad-banner" style="margin-top:12px;padding:25px 10px;">ğŸ“¢ å¹¿å‘Šä½ 2</div>
    </div>
    <div class="panel preview-panel">
        <div class="preview-area" id="previewArea">
            <div class="placeholder" id="placeholder"><div class="icon">ğŸ–¼ï¸</div><p>ä¸Šä¼ å›¾ç‰‡åç‚¹å‡»ç”Ÿæˆ</p></div>
            <div id="canvasWrapper" style="display:none;"><canvas id="mainCanvas"></canvas></div>
        </div>
        <div class="zoom-bar" id="zoomBar" style="display:none;">
            <button class="zoom-btn" onclick="zoomCanvas(-0.15)">â– ç¼©å°</button>
            <button class="zoom-btn" onclick="fitToScreen()">ğŸ“ é€‚åº”</button>
            <button class="zoom-btn" onclick="zoomCanvas(0.15)">â• æ”¾å¤§</button>
        </div>
    </div>
    <div class="panel stats-panel" id="statsPanel">
        <div class="stats-header"><h3>ğŸ“Š è‰²å·ç»Ÿè®¡</h3></div>
        <div class="stats-summary" id="statsSummary"></div>
        <div class="stats-table-wrap">
            <table class="stats-table"><thead><tr><th>è‰²å·</th><th>é¢œè‰²</th><th>æ•°é‡</th><th>å æ¯”</th></tr></thead><tbody id="statsBody"></tbody></table>
        </div>
    </div>
</div>
<div class="modal" id="downloadModal">
    <div class="modal-content">
        <h3>ğŸ“¥ ä¿å­˜å›¾çº¸ä¸ç»Ÿè®¡</h3>
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchTab(this,'pattern')">æ‹¼è±†å›¾çº¸</button>
            <button class="modal-tab" onclick="switchTab(this,'stats')">ç»Ÿè®¡è¡¨æ ¼</button>
        </div>
        <div id="tabPattern" class="modal-img-wrap">
            <img id="downloadImage" src="" alt="æ‹¼è±†å›¾çº¸" crossorigin="anonymous">
            <p id="downloadHint" style="color:#666;font-size:14px;margin-top:10px;"></p>
        </div>
        <div id="tabStats" class="modal-img-wrap" style="display:none;">
            <img id="downloadStatsImage" src="" alt="ç»Ÿè®¡è¡¨æ ¼" crossorigin="anonymous">
            <p id="downloadStatsHint" style="color:#666;font-size:14px;margin-top:10px;"></p>
        </div>
        <div class="modal-btns">
            <button class="modal-btn modal-btn-primary" onclick="showDownloadOptions('pattern')">ğŸ’¾ ä¸‹è½½å›¾çº¸</button>
            <button class="modal-btn modal-btn-success" onclick="showDownloadOptions('stats')">ğŸ“Š ä¸‹è½½ç»Ÿè®¡</button>
            <button class="modal-btn modal-btn-close" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>
</div>

<div id="downloadOptions" class="download-options">
    <div class="download-options-content">
        <div class="download-options-title">é€‰æ‹©ä¿å­˜æ–¹å¼</div>
        <div class="download-option" onclick="saveToBrowser()">
            <div class="download-option-icon">ğŸ“</div>
            <div class="download-option-text">
                <div class="download-option-title">ä¿å­˜åˆ°æµè§ˆå™¨é»˜è®¤ä½ç½®</div>
                <div class="download-option-desc">ç›´æ¥ä¸‹è½½åˆ°æ‰‹æœºä¸‹è½½æ–‡ä»¶å¤¹</div>
            </div>
        </div>
        <div class="download-option" onclick="saveToPhotoAlbum()">
            <div class="download-option-icon">ğŸ“±</div>
            <div class="download-option-text">
                <div class="download-option-title">ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œ</div>
                <div class="download-option-desc">ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ä¿å­˜åˆ°ç›¸å†Œ</div>
            </div>
        </div>
        <div class="download-option" onclick="manualSave()">
            <div class="download-option-icon">ğŸ‘†</div>
            <div class="download-option-text">
                <div class="download-option-title">æ‰‹åŠ¨ä¿å­˜</div>
                <div class="download-option-desc">é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</div>
            </div>
        </div>
        <div class="remember-option">
            <label>
                <input type="checkbox" id="rememberChoice">
                è®°ä½æˆ‘çš„é€‰æ‹©ï¼Œä¸‹æ¬¡ä¸å†è¯¢é—®
            </label>
        </div>
        <button class="modal-btn modal-btn-close" onclick="hideDownloadOptions()" style="margin-top:15px;">å–æ¶ˆ</button>
    </div>
</div>

<canvas id="highResCanvas" style="display:none;"></canvas>
<canvas id="statsCanvas" style="display:none;"></canvas>
<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p id="loadingText">æ­£åœ¨å¤„ç†...</p>
</div>
<div id="toast" class="toast"></div>

<div id="mobileDownloadGuide" class="mobile-download-guide">
    <h4>ğŸ“± æ‰‹æœºä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—</h4>
    <ol>
        <li>ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹ä¸‹è½½"æŒ‰é’®</li>
        <li>ç­‰å¾…å›¾ç‰‡ä¸‹è½½å®Œæˆ</li>
        <li>åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°ä¸‹è½½çš„å›¾ç‰‡</li>
        <li>é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"æˆ–"è®¾ä¸ºå£çº¸"</li>
    </ol>
    <div class="tip">
        ğŸ’¡ æç¤ºï¼šå¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²å…è®¸æµè§ˆå™¨ä¸‹è½½æƒé™ï¼Œå¹¶å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
        <br>1. ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨ï¼ˆå¦‚Safariã€Chromeï¼‰
        <br>2. æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡è¯•
        <br>3. ä½¿ç”¨"æ‰‹åŠ¨ä¿å­˜"åŠŸèƒ½
    </div>
    <div class="guide-buttons">
        <button class="guide-retry" onclick="startMobileDownload()">å¼€å§‹ä¸‹è½½</button>
        <button class="guide-close" onclick="closeMobileGuide()">å…³é—­</button>
    </div>
</div>

<div id="downloadProgress" class="download-progress">
    <h4>æ­£åœ¨ä¸‹è½½...</h4>
    <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="progressText" class="progress-text">å‡†å¤‡ä¸‹è½½ä¸­...</div>
</div>

<script>
const PALETTES = {
    mard_full: [
        {id:"H1",rgb:[255,255,255]},{id:"H2",rgb:[250,250,250]},{id:"H3",rgb:[245,245,245]},
        {id:"H4",rgb:[235,235,235]},{id:"H5",rgb:[220,220,220]},{id:"H6",rgb:[200,200,200]},
        {id:"H7",rgb:[180,180,180]},{id:"H8",rgb:[160,160,160]},{id:"H9",rgb:[140,140,140]},
        {id:"H10",rgb:[120,120,120]},{id:"H11",rgb:[100,100,100]},{id:"H12",rgb:[80,80,80]},
        {id:"H13",rgb:[60,60,60]},{id:"H14",rgb:[40,40,40]},{id:"H15",rgb:[20,20,20]},{id:"H16",rgb:[0,0,0]},
        {id:"A1",rgb:[255,230,230]},{id:"A2",rgb:[255,200,200]},{id:"A3",rgb:[255,170,170]},
        {id:"A4",rgb:[255,140,140]},{id:"A5",rgb:[255,100,100]},{id:"A6",rgb:[255,70,70]},
        {id:"A7",rgb:[255,50,50]},{id:"A8",rgb:[240,30,30]},{id:"A9",rgb:[220,20,20]},
        {id:"A10",rgb:[200,0,0]},{id:"A11",rgb:[180,0,0]},{id:"A12",rgb:[150,0,0]},
        {id:"A13",rgb:[255,220,230]},{id:"A14",rgb:[255,190,210]},{id:"A15",rgb:[255,150,180]},
        {id:"A16",rgb:[255,120,160]},{id:"A17",rgb:[255,100,140]},{id:"A18",rgb:[255,180,200]},
        {id:"A19",rgb:[255,150,170]},{id:"A20",rgb:[240,100,130]},{id:"A21",rgb:[220,80,110]},
        {id:"B1",rgb:[255,240,220]},{id:"B2",rgb:[255,220,180]},{id:"B3",rgb:[255,200,150]},
        {id:"B4",rgb:[255,180,120]},{id:"B5",rgb:[255,160,80]},{id:"B6",rgb:[255,140,50]},
        {id:"B7",rgb:[255,120,30]},{id:"B8",rgb:[240,100,10]},{id:"B9",rgb:[220,90,0]},
        {id:"B10",rgb:[200,80,0]},{id:"B11",rgb:[180,70,0]},{id:"B12",rgb:[160,60,0]},
        {id:"C1",rgb:[255,255,220]},{id:"C2",rgb:[255,255,180]},{id:"C3",rgb:[255,255,140]},
        {id:"C4",rgb:[255,255,100]},{id:"C5",rgb:[255,255,50]},{id:"C6",rgb:[255,255,0]},
        {id:"C7",rgb:[255,240,0]},{id:"C8",rgb:[255,220,0]},{id:"C9",rgb:[240,200,0]},
        {id:"C10",rgb:[220,180,0]},{id:"C11",rgb:[200,160,0]},{id:"C12",rgb:[180,140,0]},
        {id:"D1",rgb:[220,255,220]},{id:"D2",rgb:[180,255,180]},{id:"D3",rgb:[140,255,140]},
        {id:"D4",rgb:[100,255,100]},{id:"D5",rgb:[50,255,50]},{id:"D6",rgb:[0,255,0]},
        {id:"D7",rgb:[0,230,0]},{id:"D8",rgb:[0,200,0]},{id:"D9",rgb:[0,180,0]},
        {id:"D10",rgb:[0,160,0]},{id:"D11",rgb:[0,140,0]},{id:"D12",rgb:[0,120,0]},
        {id:"D13",rgb:[0,100,0]},{id:"D14",rgb:[0,80,0]},{id:"D15",rgb:[0,60,0]},
        {id:"E1",rgb:[220,255,255]},{id:"E2",rgb:[180,255,255]},{id:"E3",rgb:[140,255,255]},
        {id:"E4",rgb:[100,255,255]},{id:"E5",rgb:[50,255,255]},{id:"E6",rgb:[0,255,255]},
        {id:"E7",rgb:[0,230,230]},{id:"E8",rgb:[0,200,200]},{id:"E9",rgb:[0,180,180]},
        {id:"F1",rgb:[220,230,255]},{id:"F2",rgb:[180,200,255]},{id:"F3",rgb:[140,170,255]},
        {id:"F4",rgb:[100,140,255]},{id:"F5",rgb:[60,110,255]},{id:"F6",rgb:[30,80,255]},
        {id:"F7",rgb:[0,60,255]},{id:"F8",rgb:[0,50,230]},{id:"F9",rgb:[0,40,200]},
        {id:"F10",rgb:[0,30,180]},{id:"F11",rgb:[0,20,150]},{id:"F12",rgb:[0,10,120]},
        {id:"G1",rgb:[240,220,255]},{id:"G2",rgb:[220,180,255]},{id:"G3",rgb:[200,140,255]},
        {id:"G4",rgb:[180,100,255]},{id:"G5",rgb:[160,60,255]},{id:"G6",rgb:[140,30,255]},
        {id:"G7",rgb:[130,0,255]},{id:"G8",rgb:[120,0,230]},{id:"G9",rgb:[100,0,200]},
        {id:"G10",rgb:[80,0,180]},{id:"G11",rgb:[60,0,150]},{id:"G12",rgb:[50,0,120]},
        {id:"M1",rgb:[240,220,200]},{id:"M2",rgb:[220,190,160]},{id:"M3",rgb:[200,160,120]},
        {id:"M4",rgb:[180,140,100]},{id:"M5",rgb:[160,120,80]},{id:"M6",rgb:[140,100,60]},
        {id:"M7",rgb:[120,80,50]},{id:"M8",rgb:[100,70,40]},{id:"M9",rgb:[90,60,35]},
        {id:"M10",rgb:[80,50,30]},{id:"M11",rgb:[70,45,25]},{id:"M12",rgb:[60,40,20]},
        {id:"N1",rgb:[255,240,230]},{id:"N2",rgb:[255,225,210]},{id:"N3",rgb:[255,210,190]},
        {id:"N4",rgb:[250,195,170]},{id:"N5",rgb:[240,180,150]},{id:"N6",rgb:[230,165,130]},
        {id:"N7",rgb:[210,150,120]},{id:"N8",rgb:[190,130,100]},{id:"N9",rgb:[170,115,85]},{id:"N10",rgb:[150,100,70]}
    ],
    perler: [
        {id:"P01",rgb:[255,255,255]},{id:"P02",rgb:[236,232,199]},{id:"P03",rgb:[255,234,0]},
        {id:"P04",rgb:[255,188,0]},{id:"P05",rgb:[255,127,0]},{id:"P06",rgb:[207,0,0]},
        {id:"P07",rgb:[255,0,128]},{id:"P08",rgb:[255,102,153]},{id:"P09",rgb:[255,178,204]},
        {id:"P10",rgb:[204,0,204]},{id:"P11",rgb:[102,0,153]},{id:"P12",rgb:[0,0,178]},
        {id:"P13",rgb:[0,102,204]},{id:"P14",rgb:[0,178,255]},{id:"P15",rgb:[153,217,234]},
        {id:"P16",rgb:[0,153,76]},{id:"P17",rgb:[0,204,0]},{id:"P18",rgb:[153,255,0]},
        {id:"P19",rgb:[192,192,192]},{id:"P20",rgb:[128,128,128]},{id:"P21",rgb:[64,64,64]},
        {id:"P22",rgb:[0,0,0]},{id:"P23",rgb:[139,90,43]},{id:"P24",rgb:[180,128,80]},
        {id:"P25",rgb:[255,204,153]},{id:"P26",rgb:[255,178,127]},{id:"P27",rgb:[255,153,102]},
        {id:"P28",rgb:[204,153,102]},{id:"P29",rgb:[153,102,51]},{id:"P30",rgb:[102,51,0]}
    ],
    artkal_a: [
        {id:"A01",rgb:[255,255,255]},{id:"A02",rgb:[0,0,0]},{id:"A03",rgb:[128,128,128]},
        {id:"A04",rgb:[255,0,0]},{id:"A05",rgb:[255,128,0]},{id:"A06",rgb:[255,255,0]},
        {id:"A07",rgb:[0,255,0]},{id:"A08",rgb:[0,255,255]},{id:"A09",rgb:[0,0,255]},
        {id:"A10",rgb:[255,0,255]},{id:"A11",rgb:[255,192,203]},{id:"A12",rgb:[139,69,19]},
        {id:"A13",rgb:[255,218,185]},{id:"A14",rgb:[245,245,220]},{id:"A15",rgb:[176,224,230]},
        {id:"A16",rgb:[144,238,144]},{id:"A17",rgb:[255,182,193]},{id:"A18",rgb:[221,160,221]},
        {id:"A19",rgb:[255,228,196]},{id:"A20",rgb:[240,230,140]}
    ],
    hama: [
        {id:"H01",rgb:[255,255,255]},{id:"H02",rgb:[255,255,180]},{id:"H03",rgb:[255,255,0]},
        {id:"H04",rgb:[255,200,0]},{id:"H05",rgb:[255,140,0]},{id:"H06",rgb:[255,80,0]},
        {id:"H07",rgb:[255,0,0]},{id:"H08",rgb:[200,0,0]},{id:"H09",rgb:[255,180,200]},
        {id:"H10",rgb:[255,100,150]},{id:"H11",rgb:[255,0,100]},{id:"H12",rgb:[200,0,100]},
        {id:"H13",rgb:[255,200,255]},{id:"H14",rgb:[255,100,255]},{id:"H15",rgb:[200,0,200]},
        {id:"H16",rgb:[150,0,150]},{id:"H17",rgb:[200,200,255]},{id:"H18",rgb:[100,100,255]},
        {id:"H19",rgb:[0,0,255]},{id:"H20",rgb:[0,0,150]},{id:"H21",rgb:[180,230,255]},
        {id:"H22",rgb:[0,200,255]},{id:"H23",rgb:[0,150,200]},{id:"H24",rgb:[0,100,150]},
        {id:"H25",rgb:[200,255,200]},{id:"H26",rgb:[100,255,100]},{id:"H27",rgb:[0,200,0]},
        {id:"H28",rgb:[0,150,0]},{id:"H29",rgb:[0,100,0]},{id:"H30",rgb:[128,128,128]},
        {id:"H31",rgb:[80,80,80]},{id:"H32",rgb:[0,0,0]},{id:"H33",rgb:[180,140,100]},
        {id:"H34",rgb:[150,100,50]},{id:"H35",rgb:[120,80,40]},{id:"H36",rgb:[100,60,30]}
    ]
};

PALETTES.mard_120 = PALETTES.mard_full.filter((_,i) => i%2 === 0).slice(0, 120);
PALETTES.mard_72 = PALETTES.mard_full.filter((_,i) => i%2 === 0).slice(0, 72);
PALETTES.mard_48 = PALETTES.mard_full.filter((_,i) => i%3 === 0).slice(0, 48);
PALETTES.artkal_c = PALETTES.artkal_a.map(c => ({...c, id: 'C' + c.id.slice(1)}));

const SCALE_FACTOR = 3;
const DOWNLOAD_SCALE_FACTOR = 5;
const CELL_SIZE = 26 * SCALE_FACTOR;
const DOWNLOAD_CELL_SIZE = 26 * DOWNLOAD_SCALE_FACTOR;

let uploadedImage = null, gridData = [], colorStats = [], canvasScale = 1, gridWidth = 0, gridHeight = 0;
let downloadCounter = 0;
let currentDownloadType = 'pattern';
let rememberedChoice = null;
let rememberChoiceChecked = false;
let selectedColor = null;
let selectedPaletteColor = null;
let originalGridData = [];
let originalColorStats = [];
let colorReplacements = {};

if (localStorage.getItem('rememberDownloadChoice') === 'true') {
    rememberedChoice = localStorage.getItem('downloadChoice');
    rememberChoiceChecked = true;
    document.getElementById('rememberChoice').checked = true;
}

function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast';
    
    switch(type) {
        case 'success':
            toast.style.background = '#48bb78';
            break;
        case 'error':
            toast.style.background = '#f56565';
            break;
        case 'warning':
            toast.style.background = '#ed8936';
            break;
        default:
            toast.style.background = '#4299e1';
    }
    
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function showLoading(text = 'æ­£åœ¨å¤„ç†...') {
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = text;
    loading.classList.add('show');
}

function hideLoading() {
    const loading = document.getElementById('loading');
    loading.classList.remove('show');
}

function showDownloadProgress(initialText = 'æ­£åœ¨å¤„ç†...') {
    document.getElementById('progressText').textContent = initialText;
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('downloadProgress').classList.add('show');
}

function updateDownloadProgress(text, percent) {
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressFill').style.width = percent + '%';
}

function hideDownloadProgress() {
    document.getElementById('downloadProgress').classList.remove('show');
}

function showMobileDownloadGuide() {
    document.getElementById('mobileDownloadGuide').classList.add('show');
}

function closeMobileGuide() {
    document.getElementById('mobileDownloadGuide').classList.remove('show');
}

function showIOSDownloadGuide() {
    const guide = document.getElementById('mobileDownloadGuide');
    guide.querySelector('h4').textContent = 'ğŸ“± iOSä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—';
    guide.querySelector('ol').innerHTML = `
        <li>ä¸‹è½½å®Œæˆåï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„"ä¸‹è½½"å›¾æ ‡</li>
        <li>åœ¨"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å›¾ç‰‡</li>
        <li>ç‚¹å‡»å³ä¸Šè§’çš„"åˆ†äº«"æŒ‰é’®</li>
        <li>æ»‘åŠ¨æ‰¾åˆ°"å­˜å‚¨åˆ°'ç…§ç‰‡'"å¹¶ç‚¹å‡»</li>
        <li>å›¾ç‰‡å°†ä¿å­˜åˆ°æ‚¨çš„ç›¸å†Œ</li>
    `;
    guide.querySelector('.tip').innerHTML = `
        ğŸ’¡ å¦‚æœæ‰¾ä¸åˆ°ä¸‹è½½æŒ‰é’®ï¼š
        <br>1. ç‚¹å‡»Safariåº•éƒ¨å·¥å…·æ ä¸­é—´çš„"åˆ†äº«"æŒ‰é’®
        <br>2. å‘å³æ»‘åŠ¨æ‰¾åˆ°"ä¸‹è½½"
        <br>3. æˆ–è€…åœ¨"æ–‡ä»¶"Appçš„"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾
    `;
    guide.classList.add('show');
}

function showAndroidDownloadGuide() {
    const guide = document.getElementById('mobileDownloadGuide');
    guide.querySelector('h4').textContent = 'ğŸ“± Androidä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—';
    guide.querySelector('ol').innerHTML = `
        <li>ç­‰å¾…ä¸‹è½½å®Œæˆåï¼Œç‚¹å‡»"å®Œæˆ"æˆ–"æ‰“å¼€"</li>
        <li>åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°"ä¸‹è½½"æ–‡ä»¶å¤¹</li>
        <li>é•¿æŒ‰å›¾ç‰‡æ–‡ä»¶ï¼Œé€‰æ‹©"ç§»åŠ¨"æˆ–"å¤åˆ¶"</li>
        <li>ç²˜è´´åˆ°"DCIM/Camera"æ–‡ä»¶å¤¹</li>
        <li>æ‰“å¼€ç›¸å†Œå³å¯æŸ¥çœ‹</li>
    `;
    guide.querySelector('.tip').innerHTML = `
        ğŸ’¡ å¿«é€Ÿä¿å­˜æ–¹æ³•ï¼š
        <br>1. ä¸‹è½½å®Œæˆåç›´æ¥ç‚¹å‡»å›¾ç‰‡é¢„è§ˆ
        <br>2. ç‚¹å‡»å³ä¸Šè§’çš„èœå•æŒ‰é’®
        <br>3. é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½"
        <br>4. éƒ¨åˆ†æµè§ˆå™¨ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ç›¸å†Œ
    `;
    guide.classList.add('show');
}

function startMobileDownload() {
    closeMobileGuide();
    if (isIOS()) {
        saveToIOSAlbum();
    } else if (isAndroid()) {
        saveToAndroidAlbum();
    } else {
        saveToAlbumUniversal();
    }
}

function saveToPhotoAlbum() {
    if (isIOS()) {
        saveToIOSAlbum();
        return;
    }
    
    if (isAndroid()) {
        saveToAndroidAlbum();
        return;
    }
    
    saveToAlbumUniversal();
}

function saveToIOSAlbum() {
    showDownloadProgress('æ­£åœ¨ä¸ºiOSè®¾å¤‡ç”Ÿæˆå›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}.png`;
            
            if (typeof window.showOpenFilePicker !== 'undefined') {
                saveWithFileSystemAccess(highResCanvas, filename);
                return;
            }
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 30);
            
            highResCanvas.toBlob(blob => {
                if (!blob) {
                    hideDownloadProgress();
                    showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                    return;
                }
                
                updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½é“¾æ¥...', 60);
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                const cleanup = () => {
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        if (link.parentNode) {
                            link.parentNode.removeChild(link);
                        }
                        hideDownloadProgress();
                    }, 1000);
                };
                
                link.onclick = cleanup;
                
                document.body.appendChild(link);
                
                updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 80);
                
                try {
                    link.click();
                    updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 90);
                    
                    setTimeout(() => {
                        hideDownloadProgress();
                        showIOSDownloadGuide();
                    }, 1500);
                    
                } catch (e) {
                    cleanup();
                    updateDownloadProgress('è‡ªåŠ¨ä¸‹è½½å¤±è´¥', 100);
                    setTimeout(() => {
                        hideDownloadProgress();
                        showMobileDownloadGuide();
                    }, 500);
                }
                
            }, 'image/png', 1.0);
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°iOSç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function saveToAndroidAlbum() {
    showDownloadProgress('æ­£åœ¨ä¸ºAndroidè®¾å¤‡ç”Ÿæˆå›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}.png`;
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 30);
            
            if (navigator.share && navigator.canShare) {
                highResCanvas.toBlob(blob => {
                    if (!blob) {
                        hideDownloadProgress();
                        showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                        return;
                    }
                    
                    updateDownloadProgress('æ­£åœ¨å‡†å¤‡åˆ†äº«...', 60);
                    
                    const file = new File([blob], filename, { type: 'image/png' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'ä¿å­˜æ‹¼è±†å›¾çº¸',
                            text: 'è¯·é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"'
                        })
                        .then(() => {
                            hideDownloadProgress();
                            showToast('è¯·é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"é€‰é¡¹', 'success');
                        })
                        .catch(err => {
                            if (err.name !== 'AbortError') {
                                downloadForAndroid(blob, filename);
                            } else {
                                hideDownloadProgress();
                            }
                        });
                    } else {
                        downloadForAndroid(blob, filename);
                    }
                }, 'image/png', 1.0);
            } else {
                highResCanvas.toBlob(blob => {
                    downloadForAndroid(blob, filename);
                }, 'image/png', 1.0);
            }
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°Androidç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function downloadForAndroid(blob, filename) {
    updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½...', 70);
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    
    const cleanup = () => {
        setTimeout(() => {
            URL.revokeObjectURL(url);
            if (link.parentNode) {
                link.parentNode.removeChild(link);
            }
            hideDownloadProgress();
        }, 1000);
    };
    
    link.onclick = cleanup;
    
    document.body.appendChild(link);
    
    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 85);
    
    try {
        const event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: false
        });
        link.dispatchEvent(event);
        
        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 95);
        
        setTimeout(() => {
            hideDownloadProgress();
            showAndroidDownloadGuide();
        }, 1500);
        
    } catch (e) {
        cleanup();
        updateDownloadProgress('ä¸‹è½½å¤±è´¥', 100);
        setTimeout(() => {
            hideDownloadProgress();
            showMobileDownloadGuide();
        }, 500);
    }
}

function saveToAlbumUniversal() {
    showDownloadProgress('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}_é«˜æ¸….png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}_é«˜æ¸….png`;
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 40);
            
            highResCanvas.toBlob(blob => {
                if (!blob) {
                    hideDownloadProgress();
                    showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                    return;
                }
                
                updateDownloadProgress('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 70);
                
                if ('showSaveFilePicker' in window) {
                    try {
                        window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'PNGå›¾ç‰‡',
                                accept: {'image/png': ['.png']},
                            }],
                        }).then(handle => {
                            return handle.createWritable();
                        }).then(writable => {
                            return writable.write(blob).then(() => writable.close());
                        }).then(() => {
                            hideDownloadProgress();
                            showToast('å›¾ç‰‡å·²ä¿å­˜åˆ°è®¾å¤‡', 'success');
                        }).catch(fsError => {
                            console.log('File System APIå¤±è´¥:', fsError);
                            downloadViaAnchor(blob, filename);
                        });
                        return;
                    } catch (fsError) {
                        console.log('File System APIå¤±è´¥:', fsError);
                    }
                }
                
                downloadViaAnchor(blob, filename);
                
            }, 'image/png', 1.0);
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°ç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function downloadViaAnchor(blob, filename) {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    
    link.addEventListener('click', function(e) {
        e.stopPropagation();
    }, false);
    
    const cleanup = () => {
        setTimeout(() => {
            URL.revokeObjectURL(url);
            if (link.parentNode) {
                link.parentNode.removeChild(link);
            }
            hideDownloadProgress();
        }, 2000);
    };
    
    document.body.appendChild(link);
    
    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 85);
    
    let downloadTriggered = false;
    
    try {
        link.click();
        downloadTriggered = true;
    } catch (e1) {
        console.log('ç›´æ¥clickå¤±è´¥:', e1);
    }
    
    if (!downloadTriggered) {
        try {
            const event = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: false
            });
            link.dispatchEvent(event);
            downloadTriggered = true;
        } catch (e2) {
            console.log('MouseEventå¤±è´¥:', e2);
        }
    }
    
    if (!downloadTriggered) {
        try {
            const event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            link.dispatchEvent(event);
            downloadTriggered = true;
        } catch (e3) {
            console.log('createEventå¤±è´¥:', e3);
        }
    }
    
    if (downloadTriggered) {
        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 95);
        
        setTimeout(() => {
            hideDownloadProgress();
            if (isMobile()) {
                showMobileDownloadGuide();
            } else {
                showToast('ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸‹è½½ç®¡ç†ä¸­æŸ¥çœ‹', 'success');
            }
        }, 1500);
        
        setTimeout(cleanup, 10000);
    } else {
        cleanup();
        updateDownloadProgress('ä¸‹è½½å¤±è´¥', 100);
        setTimeout(() => {
            hideDownloadProgress();
            showMobileDownloadGuide();
        }, 500);
    }
}

async function saveWithFileSystemAccess(canvas, filename) {
    try {
        updateDownloadProgress('æ­£åœ¨è¯·æ±‚æ–‡ä»¶è®¿é—®æƒé™...', 40);
        
        const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png', 1.0);
        });
        
        const opts = {
            suggestedName: filename,
            types: [{
                description: 'PNGå›¾ç‰‡',
                accept: {'image/png': ['.png']},
            }],
        };
        
        const handle = await window.showSaveFilePicker(opts);
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        hideDownloadProgress();
        showToast('å›¾ç‰‡å·²ä¿å­˜åˆ°è®¾å¤‡', 'success');
        
    } catch (error) {
        console.log('File System Accesså¤±è´¥:', error);
        canvas.toBlob(blob => {
            downloadViaAnchor(blob, filename);
        }, 'image/png', 1.0);
    }
}

function selectColorToReplace(color) {
    selectedColor = color;
    
    document.getElementById('selectedColorInfo').innerHTML = `
        <p><strong>è¦æ›¿æ¢çš„é¢œè‰²ï¼š</strong> ${color.id}</p>
        <p><strong>å½“å‰é¢œè‰²ï¼š</strong> <span class="color-dot" style="background:rgb(${color.rgb.join(',')})"></span> RGB(${color.rgb.join(',')})</p>
        <p><strong>ä½¿ç”¨æ•°é‡ï¼š</strong> ${color.count} é¢—</p>
        <p>è¯·åœ¨ä¸‹æ–¹é€‰æ‹©æ–°çš„é¢œè‰²ï¼š</p>
    `;
    
    document.getElementById('replaceOptions').style.display = 'block';
    
    loadPaletteForReplacement();
    
    document.getElementById('colorReplaceSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    showToast(`å·²é€‰æ‹©è‰²å· ${color.id}ï¼Œè¯·é€‰æ‹©æ›¿æ¢é¢œè‰²`, 'info');
}

function loadPaletteForReplacement() {
    const paletteGrid = document.getElementById('paletteGrid');
    const paletteName = document.getElementById('paletteSelect').value;
    const palette = PALETTES[paletteName];
    
    paletteGrid.innerHTML = '';
    
    palette.forEach(color => {
        const colorDiv = document.createElement('div');
        colorDiv.className = 'palette-color';
        colorDiv.onclick = () => selectPaletteColor(color, colorDiv);
        
        const isUsedInDrawing = colorStats.some(c => c.id === color.id);
        
        colorDiv.innerHTML = `
            <div class="palette-dot" style="background:rgb(${color.rgb.join(',')}); ${isUsedInDrawing ? 'border-color:#48bb78;' : ''}"></div>
            <div class="palette-id">${color.id}</div>
            <div class="palette-rgb">${color.rgb.join(',')}</div>
            ${isUsedInDrawing ? '<div style="font-size:9px;color:#48bb78;">å·²ä½¿ç”¨</div>' : ''}
        `;
        
        paletteGrid.appendChild(colorDiv);
    });
    
    selectedPaletteColor = null;
}

function selectPaletteColor(color, element) {
    document.querySelectorAll('.palette-color').forEach(el => {
        el.classList.remove('selected');
    });
    
    element.classList.add('selected');
    selectedPaletteColor = color;
    
    showToast(`å·²é€‰æ‹©è‰²å· ${color.id} ä½œä¸ºæ›¿æ¢é¢œè‰²`, 'info');
}

function searchPalette() {
    const searchText = document.getElementById('paletteSearch').value.toLowerCase();
    const paletteColors = document.querySelectorAll('.palette-color');
    
    paletteColors.forEach(div => {
        const colorId = div.querySelector('.palette-id').textContent.toLowerCase();
        const colorRgb = div.querySelector('.palette-rgb').textContent.toLowerCase();
        
        if (colorId.includes(searchText) || colorRgb.includes(searchText) || searchText === '') {
            div.style.display = 'flex';
        } else {
            div.style.display = 'none';
        }
    });
}

function replaceColor() {
    if (!selectedColor || !selectedPaletteColor) {
        showToast('è¯·å…ˆé€‰æ‹©è¦æ›¿æ¢çš„é¢œè‰²å’Œæ›¿æ¢ç›®æ ‡é¢œè‰²', 'error');
        return;
    }
    
    if (selectedColor.id === selectedPaletteColor.id) {
        showToast('é¢œè‰²ç›¸åŒï¼Œæ— éœ€æ›¿æ¢', 'warning');
        return;
    }
    
    showLoading(`æ­£åœ¨æ›¿æ¢ ${selectedColor.id} â†’ ${selectedPaletteColor.id}...`);
    
    setTimeout(() => {
        try {
            colorReplacements[selectedColor.id] = selectedPaletteColor;
            
            if (originalGridData.length === 0) {
                originalGridData = [...gridData];
                originalColorStats = [...colorStats];
            }
            
            let replaceCount = 0;
            for (let i = 0; i < gridData.length; i++) {
                if (gridData[i].id === selectedColor.id) {
                    gridData[i] = {...selectedPaletteColor};
                    replaceCount++;
                }
            }
            
            calculateStats();
            
            renderCanvas();
            renderStatsTable();
            
            updateStatsTableClickEvents();
            
            document.getElementById('replaceOptions').style.display = 'none';
            
            document.getElementById('selectedColorInfo').innerHTML = `
                <p><strong>æ›¿æ¢å®Œæˆï¼š</strong> ${selectedColor.id} â†’ ${selectedPaletteColor.id}</p>
                <p><strong>æ›¿æ¢æ•°é‡ï¼š</strong> ${replaceCount} é¢—</p>
                <p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„å…¶ä»–è‰²å·ç»§ç»­æ›¿æ¢</p>
            `;
            
            selectedColor = null;
            selectedPaletteColor = null;
            
            hideLoading();
            showToast(`æˆåŠŸæ›¿æ¢ ${replaceCount} ä¸ª ${selectedColor.id} ä¸º ${selectedPaletteColor.id}`, 'success');
            
        } catch (error) {
            hideLoading();
            showToast('é¢œè‰²æ›¿æ¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('é¢œè‰²æ›¿æ¢æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function cancelReplace() {
    selectedColor = null;
    selectedPaletteColor = null;
    document.getElementById('replaceOptions').style.display = 'none';
    document.getElementById('selectedColorInfo').innerHTML = '<p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>';
    showToast('å·²å–æ¶ˆé¢œè‰²æ›¿æ¢', 'info');
}

function resetAllColors() {
    if (originalGridData.length === 0) {
        showToast('æ²¡æœ‰å¯é‡ç½®çš„é¢œè‰²', 'info');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é¢œè‰²åˆ°åŸå§‹çŠ¶æ€å—ï¼Ÿæ‰€æœ‰æ›¿æ¢æ“ä½œå°†è¢«æ’¤é”€ã€‚')) {
        return;
    }
    
    showLoading('æ­£åœ¨é‡ç½®æ‰€æœ‰é¢œè‰²...');
    
    setTimeout(() => {
        try {
            gridData = [...originalGridData];
            
            calculateStats();
            
            renderCanvas();
            renderStatsTable();
            
            updateStatsTableClickEvents();
            
            colorReplacements = {};
            originalGridData = [];
            originalColorStats = [];
            
            document.getElementById('replaceOptions').style.display = 'none';
            document.getElementById('selectedColorInfo').innerHTML = '<p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>';
            
            selectedColor = null;
            selectedPaletteColor = null;
            
            hideLoading();
            showToast('æ‰€æœ‰é¢œè‰²å·²é‡ç½®åˆ°åŸå§‹çŠ¶æ€', 'success');
            
        } catch (error) {
            hideLoading();
            showToast('é‡ç½®é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('é‡ç½®é¢œè‰²æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function updateStatsTableClickEvents() {
    const colorDots = document.querySelectorAll('.color-dot');
    colorDots.forEach((dot, index) => {
        dot.onclick = null;
        
        dot.onclick = () => {
            if (colorStats[index]) {
                selectColorToReplace(colorStats[index]);
            }
        };
        
        dot.title = `ç‚¹å‡»æ›¿æ¢è‰²å· ${colorStats[index]?.id || ''}`;
    });
}

function saveToBrowser() {
    showDownloadProgress('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('browser');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            
            const highResCanvas = document.getElementById('highResCanvas');
            const dataUrl = highResCanvas.toDataURL('image/png', 1.0);
            
            const timestamp = new Date().getTime();
            const random = Math.random().toString(36).substring(2, 8);
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}_${timestamp}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}_${timestamp}.png`;
            
            updateDownloadProgress('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 60);
            
            fetch(dataUrl)
                .then(res => res.blob())
                .then(blob => {
                    updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½é“¾æ¥...', 80);
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    link.addEventListener('click', function() {
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            if (link.parentNode) {
                                link.parentNode.removeChild(link);
                            }
                        }, 1000);
                    });
                    
                    document.body.appendChild(link);
                    
                    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 90);
                    
                    let success = false;
                    
                    try {
                        link.click();
                        success = true;
                    } catch (e) {
                        console.log('æ–¹å¼1å¤±è´¥:', e);
                    }
                    
                    if (!success) {
                        try {
                            const event = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: false
                            });
                            link.dispatchEvent(event);
                            success = true;
                        } catch (e) {
                            console.log('æ–¹å¼2å¤±è´¥:', e);
                        }
                    }
                    
                    if (success) {
                        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 100);
                        setTimeout(() => {
                            hideDownloadProgress();
                            showToast('ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
                            
                            if (isMobile()) {
                                setTimeout(() => {
                                    if (isAndroid()) {
                                        showToast('è¯·æŸ¥çœ‹"æ–‡ä»¶ç®¡ç†"ä¸­çš„"ä¸‹è½½"æ–‡ä»¶å¤¹', 'info');
                                    } else if (isIOS()) {
                                        showToast('è¯·åœ¨"æ–‡ä»¶"Appçš„"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹', 'info');
                                    }
                                }, 2000);
                            }
                        }, 1000);
                    } else {
                        hideDownloadProgress();
                        showToast('è‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•æ‰‹åŠ¨ä¿å­˜', 'error');
                    }
                })
                .catch(err => {
                    hideDownloadProgress();
                    console.error('ä¸‹è½½å¤±è´¥:', err);
                    showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–é€‰æ‹©å…¶ä»–æ–¹å¼', 'error');
                });
                
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¸‹è½½æ—¶å‡ºé”™:', error);
        }
    }, 500);
}

function manualSave() {
    hideDownloadOptions();
    updateRememberChoice('manual');
    
    renderHighResCanvas(currentDownloadType);
    const highResCanvas = document.getElementById('highResCanvas');
    const previewImg = currentDownloadType === 'pattern' ? 
        document.getElementById('downloadImage') : 
        document.getElementById('downloadStatsImage');
    
    const dataUrl = highResCanvas.toDataURL('image/png', 1.0);
    previewImg.src = dataUrl;
    
    previewImg.onload = function() {
        let hintText = '';
        
        if (isIOS()) {
            hintText = 'ğŸ“± iOSä¿å­˜ï¼šé•¿æŒ‰å›¾ç‰‡ â†’ "æ·»åŠ åˆ°ç…§ç‰‡"';
        } else if (isAndroid()) {
            hintText = 'ğŸ“± Androidä¿å­˜ï¼šé•¿æŒ‰å›¾ç‰‡ â†’ "ä¿å­˜å›¾ç‰‡"';
        } else {
            hintText = 'ğŸ’» ç”µè„‘ä¿å­˜ï¼šå³é”®å›¾ç‰‡ â†’ "å›¾ç‰‡å¦å­˜ä¸º"';
        }
        
        document.getElementById('downloadHint').textContent = hintText;
        document.getElementById('downloadStatsHint').textContent = hintText;
        
        showDetailedSaveGuide();
    };
    
    if (previewImg.complete) {
        showDetailedSaveGuide();
    }
}

function showDetailedSaveGuide() {
    let guideText = '';
    let title = '';
    
    if (isIOS()) {
        title = 'ğŸ“± iPhone/iPadä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. é•¿æŒ‰ä¸Šæ–¹é«˜æ¸…å›¾ç‰‡\n' +
                   '2. åœ¨å¼¹å‡ºçš„èœå•ä¸­é€‰æ‹©"æ·»åŠ åˆ°ç…§ç‰‡"\n' +
                   '3. å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„ç›¸å†Œ\n\n' +
                   'å¤‡ç”¨æ–¹æ³•ï¼š\n' +
                   '1. ç‚¹å‡»å›¾ç‰‡å³ä¸Šè§’çš„"åˆ†äº«"æŒ‰é’®\n' +
                   '2. å‘å·¦æ»‘åŠ¨æ‰¾åˆ°"å­˜å‚¨å›¾åƒ"\n' +
                   '3. ç‚¹å‡»å³å¯ä¿å­˜\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå¦‚æ— æ³•ä¿å­˜ï¼Œè¯·ç¡®ä¿Safariè®¾ç½®ä¸­å…è®¸ä¸‹è½½ã€‚';
    } else if (isAndroid()) {
        title = 'ğŸ“± Androidæ‰‹æœºä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. é•¿æŒ‰ä¸Šæ–¹é«˜æ¸…å›¾ç‰‡\n' +
                   '2. é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½å›¾ç‰‡"\n' +
                   '3. ä¿å­˜åè¯·åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°è¯¥å›¾ç‰‡\n' +
                   '4. å°†å›¾ç‰‡ç§»åŠ¨åˆ°DCIM/Cameraæ–‡ä»¶å¤¹å³å¯åœ¨ç›¸å†Œä¸­æŸ¥çœ‹\n\n' +
                   'å¿«é€Ÿæ–¹æ³•ï¼š\n' +
                   '1. ç‚¹å‡»å›¾ç‰‡å³ä¸‹è§’çš„èœå•æŒ‰é’®\n' +
                   '2. é€‰æ‹©"ä¸‹è½½å›¾ç‰‡"\n' +
                   '3. éƒ¨åˆ†æ‰‹æœºä¼šè‡ªåŠ¨ä¿å­˜åˆ°ç›¸å†Œ\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå¦‚æ— æ³•ä¿å­˜ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½æƒé™ã€‚';
    } else {
        title = 'ğŸ’» ç”µè„‘ä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. å³é”®ç‚¹å‡»é«˜æ¸…å›¾ç‰‡\n' +
                   '2. é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"\n' +
                   '3. é€‰æ‹©ä¿å­˜ä½ç½®\n' +
                   '4. ç‚¹å‡»ä¿å­˜\n\n' +
                   'å¿«æ·é”®ï¼š\n' +
                   'â€¢ å³é”® + S: å¿«é€Ÿä¿å­˜\n' +
                   'â€¢ Ctrl+S: ä¿å­˜å½“å‰é¡µé¢\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå»ºè®®ä¿å­˜ä¸ºPNGæ ¼å¼ä»¥ä¿è¯è´¨é‡ã€‚';
    }
    
    alert(`${title}\n\n${guideText}\n\nâœ¨ æç¤ºï¼šå›¾ç‰‡å·²å‡†å¤‡å¥½ï¼Œè¯·æŒ‰ä¸Šè¿°æ­¥éª¤æ“ä½œã€‚`);
}

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('fileName').textContent = 'å·²é€‰æ‹©: ' + file.name;
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = new Image();
        img.onload = () => uploadedImage = img;
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

function generatePattern() {
    if (!uploadedImage) {
        showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼', 'error');
        return;
    }
    
    showLoading('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾çº¸...');
    
    setTimeout(() => {
        try {
            gridWidth = parseInt(document.getElementById('widthSlider').value);
            const paletteName = document.getElementById('paletteSelect').value;
            const palette = PALETTES[paletteName];
            
            const ratio = uploadedImage.height / uploadedImage.width;
            gridHeight = Math.round(gridWidth * ratio);
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gridWidth;
            tempCanvas.height = gridHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(uploadedImage, 0, 0, gridWidth, gridHeight);
            const imageData = tempCtx.getImageData(0, 0, gridWidth, gridHeight);
            const pixels = imageData.data;
            gridData = [];
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const i = (y * gridWidth + x) * 4;
                    const match = findClosestColor(pixels[i], pixels[i+1], pixels[i+2], palette);
                    gridData.push(match);
                }
            }
            calculateStats();
            renderCanvas();
            renderStatsTable();
            fitToScreen();
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('canvasWrapper').style.display = 'block';
            document.getElementById('zoomBar').style.display = 'flex';
            document.getElementById('downloadBtn').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'block';
            
            document.getElementById('colorReplaceSection').classList.add('show');
            
            updateStatsTableClickEvents();
            
            colorReplacements = {};
            originalGridData = [...gridData];
            originalColorStats = [...colorStats];
            selectedColor = null;
            selectedPaletteColor = null;
            
            hideLoading();
            showToast('å›¾çº¸ç”ŸæˆæˆåŠŸï¼ç‚¹å‡»è‰²å·å¯è¿›è¡Œæ›¿æ¢', 'success');
            
            optimizeMobileStatsDisplay();
            
        } catch (error) {
            hideLoading();
            showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ç”Ÿæˆå›¾çº¸æ—¶å‡ºé”™:', error);
        }
    }, 100);
}

function optimizeMobileStatsDisplay() {
    const statsPanel = document.getElementById('statsPanel');
    const statsTableWrap = document.querySelector('.stats-table-wrap');
    const isMobileDevice = window.innerWidth <= 900;
    
    if (isMobileDevice && colorStats.length > 0) {
        statsPanel.classList.add('auto-height');
        
        const estimatedHeight = colorStats.length * 35 + 120;
        
        statsPanel.style.minHeight = estimatedHeight + 'px';
        
        const maxHeight = window.innerHeight * 0.8;
        statsTableWrap.style.maxHeight = Math.min(estimatedHeight, maxHeight) + 'px';
        
        console.log('æ‰‹æœºç«¯ç»Ÿè®¡è¡¨æ ¼ä¼˜åŒ–å®Œæˆï¼Œé«˜åº¦:', estimatedHeight);
    } else {
        statsPanel.classList.remove('auto-height');
        statsPanel.style.minHeight = '';
        statsTableWrap.style.maxHeight = '400px';
    }
}

function calculateStats() {
    const usage = {};
    gridData.forEach(c => {
        if (!usage[c.id]) usage[c.id] = {...c, count: 0};
        usage[c.id].count++;
    });
    colorStats = Object.values(usage).sort((a, b) => b.count - a.count);
}

function renderStatsTable() {
    const total = gridWidth * gridHeight;
    document.getElementById('statsSummary').innerHTML = `<p>ğŸ“ å°ºå¯¸ï¼š<strong>${gridWidth} Ã— ${gridHeight}</strong></p><p>ğŸ”¢ æ€»ç æ•°ï¼š<strong>${total.toLocaleString()}</strong> é¢—</p><p>ğŸ¨ é¢œè‰²æ•°ï¼š<strong>${colorStats.length}</strong> ç§</p>`;
    const tbody = document.getElementById('statsBody');
    tbody.innerHTML = colorStats.map(c => {
        const percent = (c.count / total * 100).toFixed(1);
        const replacementInfo = colorReplacements[c.id] ? 
            ` <small style="color:#ed8936;">(åŸ: ${Object.keys(colorReplacements).find(key => colorReplacements[key].id === c.id)})</small>` : '';
        return `<tr><td><strong>${c.id}${replacementInfo}</strong></td><td><span class="color-dot" style="background:rgb(${c.rgb.join(',')})" title="ç‚¹å‡»æ›¿æ¢è‰²å· ${c.id}"></span></td><td>${c.count}</td><td>${percent}%</td></tr>`;
    }).join('');
}

function findClosestColor(r, g, b, palette) {
    let minDist = Infinity;
    let closest = palette[0];
    for (const color of palette) {
        const dr = (r - color.rgb[0]) * 0.30;
        const dg = (g - color.rgb[1]) * 0.59;
        const db = (b - color.rgb[2]) * 0.11;
        const dist = dr*dr + dg*dg + db*db;
        if (dist < minDist) {
            minDist = dist;
            closest = color;
        }
    }
    return closest;
}

function renderCanvas() {
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const showGrid = document.getElementById('showGrid').checked;
    const showCode = document.getElementById('showCode').checked;
    const showLegend = document.getElementById('showLegend').checked;
    const showRuler = document.getElementById('showRuler').checked;
    
    const margin = showRuler ? 40 * SCALE_FACTOR : 15 * SCALE_FACTOR;
    const gridW = gridWidth * CELL_SIZE;
    const gridH = gridHeight * CELL_SIZE;
    const legendH = showLegend ? Math.ceil(colorStats.length / 5) * 28 * SCALE_FACTOR + 40 * SCALE_FACTOR : 0;
    
    canvas.width = gridW + margin * 2;
    canvas.height = gridH + margin + 15 * SCALE_FACTOR + legendH;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(margin, margin);
    for (let y = 0; y < gridHeight; y++) {
        for (let x = 0; x < gridWidth; x++) {
            const color = gridData[y * gridWidth + x];
            const px = x * CELL_SIZE;
            const py = y * CELL_SIZE;
            ctx.fillStyle = `rgb(${color.rgb[0]},${color.rgb[1]},${color.rgb[2]})`;
            ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE);
            if (showGrid) {
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 0.5 * SCALE_FACTOR;
                ctx.strokeRect(px, py, CELL_SIZE, CELL_SIZE);
            }
            if (showCode) {
                const brightness = color.rgb[0]*0.299 + color.rgb[1]*0.587 + color.rgb[2]*0.114;
                ctx.fillStyle = brightness > 128 ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.95)';
                ctx.font = `bold ${9 * SCALE_FACTOR}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(color.id, px + CELL_SIZE/2, py + CELL_SIZE/2);
            }
        }
    }
    if (showGrid) {
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1.5 * SCALE_FACTOR;
        ctx.beginPath();
        for (let i = 0; i <= gridWidth; i += 10) {
            ctx.moveTo(i * CELL_SIZE, 0);
            ctx.lineTo(i * CELL_SIZE, gridH);
        }
        for (let i = 0; i <= gridHeight; i += 10) {
            ctx.moveTo(0, i * CELL_SIZE);
            ctx.lineTo(gridW, i * CELL_SIZE);
        }
        ctx.stroke();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2 * SCALE_FACTOR;
        ctx.strokeRect(0, 0, gridW, gridH);
    }
    if (showRuler) {
        ctx.fillStyle = '#666';
        ctx.font = `${10 * SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'center';
        for (let x = 0; x < gridWidth; x++) {
            if ((x+1) % 5 === 0) ctx.fillText(x+1, x * CELL_SIZE + CELL_SIZE/2, -8 * SCALE_FACTOR);
        }
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (let y = 0; y < gridHeight; y++) {
            if ((y+1) % 5 === 0) ctx.fillText(y+1, -8 * SCALE_FACTOR, y * CELL_SIZE + CELL_SIZE/2);
        }
    }
    if (showLegend && colorStats.length > 0) {
        ctx.translate(0, gridH + 18 * SCALE_FACTOR);
        ctx.fillStyle = '#333';
        ctx.font = `bold ${12 * SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'left';
        ctx.fillText(`è‰²å·è¡¨ (${colorStats.length}è‰², ${gridWidth}Ã—${gridHeight}=${gridWidth*gridHeight}é¢—)`, 0, 0);
        const cols = 5;
        const colW = gridW / cols;
        colorStats.forEach((c, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const bx = col * colW;
            const by = row * 28 * SCALE_FACTOR + 18 * SCALE_FACTOR;
            ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
            ctx.fillRect(bx, by - 6 * SCALE_FACTOR, 16 * SCALE_FACTOR, 16 * SCALE_FACTOR);
            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 1 * SCALE_FACTOR;
            ctx.strokeRect(bx, by - 6 * SCALE_FACTOR, 16 * SCALE_FACTOR, 16 * SCALE_FACTOR);
            ctx.fillStyle = '#333';
            ctx.font = `${10 * SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${c.id} Ã—${c.count}`, bx + 20 * SCALE_FACTOR, by);
        });
    }
    ctx.restore();
}

function renderHighResCanvas(type) {
    const highResCanvas = document.getElementById('highResCanvas');
    const ctx = highResCanvas.getContext('2d');
    const showGrid = document.getElementById('showGrid').checked;
    const showCode = document.getElementById('showCode').checked;
    const showLegend = document.getElementById('showLegend').checked;
    const showRuler = document.getElementById('showRuler').checked;
    
    if (type === 'pattern') {
        const margin = showRuler ? 40 * DOWNLOAD_SCALE_FACTOR : 15 * DOWNLOAD_SCALE_FACTOR;
        const gridW = gridWidth * DOWNLOAD_CELL_SIZE;
        const gridH = gridHeight * DOWNLOAD_CELL_SIZE;
        const legendH = showLegend ? Math.ceil(colorStats.length / 5) * 28 * DOWNLOAD_SCALE_FACTOR + 40 * DOWNLOAD_SCALE_FACTOR : 0;
        
        highResCanvas.width = gridW + margin * 2;
        highResCanvas.height = gridH + margin + 15 * DOWNLOAD_SCALE_FACTOR + legendH;
        
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, highResCanvas.width, highResCanvas.height);
        ctx.save();
        ctx.translate(margin, margin);
        
        for (let y = 0; y < gridHeight; y++) {
            for (let x = 0; x < gridWidth; x++) {
                const color = gridData[y * gridWidth + x];
                const px = x * DOWNLOAD_CELL_SIZE;
                const py = y * DOWNLOAD_CELL_SIZE;
                ctx.fillStyle = `rgb(${color.rgb[0]},${color.rgb[1]},${color.rgb[2]})`;
                ctx.fillRect(px, py, DOWNLOAD_CELL_SIZE, DOWNLOAD_CELL_SIZE);
                if (showGrid) {
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.lineWidth = 0.5 * DOWNLOAD_SCALE_FACTOR;
                    ctx.strokeRect(px, py, DOWNLOAD_CELL_SIZE, DOWNLOAD_CELL_SIZE);
                }
                if (showCode) {
                    const brightness = color.rgb[0]*0.299 + color.rgb[1]*0.587 + color.rgb[2]*0.114;
                    ctx.fillStyle = brightness > 128 ? 'rgba(0,0,0,0.85)' : 'rgba(255,255,255,0.98)';
                    ctx.font = `bold ${11 * DOWNLOAD_SCALE_FACTOR}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(color.id, px + DOWNLOAD_CELL_SIZE/2, py + DOWNLOAD_CELL_SIZE/2);
                }
            }
        }
        
        if (showGrid) {
            ctx.strokeStyle = 'rgba(0,0,0,0.35)';
            ctx.lineWidth = 1.5 * DOWNLOAD_SCALE_FACTOR;
            ctx.beginPath();
            for (let i = 0; i <= gridWidth; i += 10) {
                ctx.moveTo(i * DOWNLOAD_CELL_SIZE, 0);
                ctx.lineTo(i * DOWNLOAD_CELL_SIZE, gridH);
            }
            for (let i = 0; i <= gridHeight; i += 10) {
                ctx.moveTo(0, i * DOWNLOAD_CELL_SIZE);
                ctx.lineTo(gridW, i * DOWNLOAD_CELL_SIZE);
            }
            ctx.stroke();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2 * DOWNLOAD_SCALE_FACTOR;
            ctx.strokeRect(0, 0, gridW, gridH);
        }
        
        if (showRuler) {
            ctx.fillStyle = '#666';
            ctx.font = `${12 * DOWNLOAD_SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'center';
            for (let x = 0; x < gridWidth; x++) {
                if ((x+1) % 5 === 0) ctx.fillText(x+1, x * DOWNLOAD_CELL_SIZE + DOWNLOAD_CELL_SIZE/2, -10 * DOWNLOAD_SCALE_FACTOR);
            }
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let y = 0; y < gridHeight; y++) {
                if ((y+1) % 5 === 0) ctx.fillText(y+1, -10 * DOWNLOAD_SCALE_FACTOR, y * DOWNLOAD_CELL_SIZE + DOWNLOAD_CELL_SIZE/2);
            }
        }
        
        if (showLegend && colorStats.length > 0) {
            ctx.translate(0, gridH + 18 * DOWNLOAD_SCALE_FACTOR);
            ctx.fillStyle = '#333';
            ctx.font = `bold ${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText(`è‰²å·è¡¨ (${colorStats.length}è‰², ${gridWidth}Ã—${gridHeight}=${gridWidth*gridHeight}é¢—)`, 0, 0);
            const cols = 5;
            const colW = gridW / cols;
            colorStats.forEach((c, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const bx = col * colW;
                const by = row * 28 * DOWNLOAD_SCALE_FACTOR + 18 * DOWNLOAD_SCALE_FACTOR;
                ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
                ctx.fillRect(bx, by - 6 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR);
                ctx.strokeStyle = '#aaa';
                ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
                ctx.strokeRect(bx, by - 6 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR);
                ctx.fillStyle = '#333';
                ctx.font = `${12 * DOWNLOAD_SCALE_FACTOR}px Arial`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${c.id} Ã—${c.count}`, bx + 22 * DOWNLOAD_SCALE_FACTOR, by);
            });
        }
        ctx.restore();
    } else {
        renderHighResStatsCanvas();
    }
}

function renderHighResStatsCanvas() {
    const highResCanvas = document.getElementById('highResCanvas');
    const ctx = highResCanvas.getContext('2d');
    const padding = 30 * DOWNLOAD_SCALE_FACTOR;
    const rowHeight = 35 * DOWNLOAD_SCALE_FACTOR;
    const headerHeight = 90 * DOWNLOAD_SCALE_FACTOR;
    const width = 500 * DOWNLOAD_SCALE_FACTOR;
    const height = headerHeight + colorStats.length * rowHeight + padding * 2;
    
    highResCanvas.width = width;
    highResCanvas.height = height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.fillStyle = '#667eea';
    ctx.fillRect(0, 0, width, 60 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillStyle = '#ffffff';
    ctx.font = `bold ${20 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText('æ‹¼è±†è‰²å·ç»Ÿè®¡è¡¨', width/2, 35 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillStyle = '#333';
    ctx.font = `${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'left';
    const total = gridWidth * gridHeight;
    ctx.fillText(`å°ºå¯¸: ${gridWidth}Ã—${gridHeight}  |  æ€»ç æ•°: ${total}é¢—  |  é¢œè‰²æ•°: ${colorStats.length}ç§`, padding, 80 * DOWNLOAD_SCALE_FACTOR);
    
    const startY = headerHeight;
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(padding, startY, width - padding*2, rowHeight);
    ctx.fillStyle = '#333';
    ctx.font = `bold ${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText('åºå·', padding + 30 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('è‰²å·', padding + 100 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('é¢œè‰²', padding + 180 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('æ•°é‡', padding + 300 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('å æ¯”', padding + 400 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    
    colorStats.forEach((c, i) => {
        const y = startY + (i + 1) * rowHeight;
        if (i % 2 === 0) {
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(padding, y, width - padding*2, rowHeight);
        }
        ctx.fillStyle = '#333';
        ctx.font = `${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'center';
        ctx.fillText(i + 1, padding + 30 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.font = `bold ${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.fillText(c.id, padding + 100 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
        ctx.fillRect(padding + 165 * DOWNLOAD_SCALE_FACTOR, y + 10 * DOWNLOAD_SCALE_FACTOR, 35 * DOWNLOAD_SCALE_FACTOR, 20 * DOWNLOAD_SCALE_FACTOR);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
        ctx.strokeRect(padding + 165 * DOWNLOAD_SCALE_FACTOR, y + 10 * DOWNLOAD_SCALE_FACTOR, 35 * DOWNLOAD_SCALE_FACTOR, 20 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillStyle = '#333';
        ctx.font = `${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.fillText(c.count, padding + 300 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillText((c.count / total * 100).toFixed(1) + '%', padding + 400 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
    });
    
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
    ctx.strokeRect(padding, startY, width - padding*2, (colorStats.length + 1) * rowHeight);
}

function fitToScreen() {
    const canvas = document.getElementById('mainCanvas');
    const container = document.getElementById('previewArea');
    const scaleX = (container.clientWidth - 20) / canvas.width;
    const scaleY = (container.clientHeight - 20) / canvas.height;
    canvasScale = Math.min(scaleX, scaleY, 1);
    applyScale();
}

function zoomCanvas(delta) {
    canvasScale = Math.max(0.1, Math.min(3, canvasScale + delta));
    applyScale();
}

function applyScale() {
    const wrapper = document.getElementById('canvasWrapper');
    const canvas = document.getElementById('mainCanvas');
    wrapper.style.width = (canvas.width * canvasScale) + 'px';
    wrapper.style.height = (canvas.height * canvasScale) + 'px';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
}

function openDownloadModal() {
    if (!colorStats || colorStats.length === 0 || gridData.length === 0) {
        showToast('è¯·å…ˆç”Ÿæˆå›¾çº¸ï¼', 'error');
        return;
    }
    
    try {
        const canvas = document.getElementById('mainCanvas');
        if (canvas) {
            document.getElementById('downloadImage').src = canvas.toDataURL('image/png');
        }
        
        renderStatsCanvas();
        const statsCanvas = document.getElementById('statsCanvas');
        if (statsCanvas) {
            document.getElementById('downloadStatsImage').src = statsCanvas.toDataURL('image/png');
        }
        
        document.getElementById('downloadModal').classList.add('show');
        updateDownloadHint();
        switchTab(document.querySelector('.modal-tab'), 'pattern');
        showToast('ä¸‹è½½é¢„è§ˆå·²å‡†å¤‡å°±ç»ª', 'success');
    } catch (error) {
        console.error('æ‰“å¼€ä¸‹è½½æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
        showToast('æ‰“å¼€ä¸‹è½½çª—å£å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

function closeModal() {
    document.getElementById('downloadModal').classList.remove('show');
}

function switchTab(btn, tab) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tabPattern').style.display = tab === 'pattern' ? 'block' : 'none';
    document.getElementById('tabStats').style.display = tab === 'stats' ? 'block' : 'none';
}

function showDownloadOptions(type) {
    currentDownloadType = type;
    
    if (rememberedChoice && rememberChoiceChecked) {
        if (rememberedChoice === 'browser') {
            saveToBrowser();
        } else if (rememberedChoice === 'album') {
            saveToPhotoAlbum();
        } else if (rememberedChoice === 'manual') {
            manualSave();
        }
        return;
    }
    
    document.getElementById('downloadOptions').classList.add('show');
}

function hideDownloadOptions() {
    document.getElementById('downloadOptions').classList.remove('show');
}

function updateRememberChoice(choice) {
    rememberChoiceChecked = document.getElementById('rememberChoice').checked;
    
    if (rememberChoiceChecked) {
        rememberedChoice = choice;
        localStorage.setItem('rememberDownloadChoice', 'true');
        localStorage.setItem('downloadChoice', choice);
    }
}

function renderStatsCanvas() {
    const statsCanvas = document.getElementById('statsCanvas');
    if (!statsCanvas || !colorStats || colorStats.length === 0) return;
    
    const ctx = statsCanvas.getContext('2d');
    const padding = 30;
    const rowHeight = 35;
    const headerHeight = 90;
    const width = 500;
    const height = headerHeight + colorStats.length * rowHeight + padding * 2;
    
    statsCanvas.width = width;
    statsCanvas.height = height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.fillStyle = '#667eea';
    ctx.fillRect(0, 0, width, 60);
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('æ‹¼è±†è‰²å·ç»Ÿè®¡è¡¨', width/2, 35);
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    const total = gridWidth * gridHeight;
    ctx.fillText(`å°ºå¯¸: ${gridWidth}Ã—${gridHeight}  |  æ€»ç æ•°: ${total}é¢—  |  é¢œè‰²æ•°: ${colorStats.length}ç§`, padding, 80);
    
    const startY = headerHeight;
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(padding, startY, width - padding*2, rowHeight);
    ctx.fillStyle = '#333';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('åºå·', padding + 30, startY + 22);
    ctx.fillText('è‰²å·', padding + 100, startY + 22);
    ctx.fillText('é¢œè‰²', padding + 180, startY + 22);
    ctx.fillText('æ•°é‡', padding + 300, startY + 22);
    ctx.fillText('å æ¯”', padding + 400, startY + 22);
    
    colorStats.forEach((c, i) => {
        const y = startY + (i + 1) * rowHeight;
        if (i % 2 === 0) {
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(padding, y, width - padding*2, rowHeight);
        }
        ctx.fillStyle = '#333';
        ctx.font = '13px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(i + 1, padding + 30, y + 22);
        ctx.font = 'bold 13px Arial';
        ctx.fillText(c.id, padding + 100, y + 22);
        ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
        ctx.fillRect(padding + 165, y + 10, 35, 20);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.strokeRect(padding + 165, y + 10, 35, 20);
        ctx.fillStyle = '#333';
        ctx.font = '13px Arial';
        ctx.fillText(c.count, padding + 300, y + 22);
        ctx.fillText((c.count / total * 100).toFixed(1) + '%', padding + 400, y + 22);
    });
    
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.strokeRect(padding, startY, width - padding*2, (colorStats.length + 1) * rowHeight);
}

function updateDownloadHint() {
    const hintText = isMobile() ? 
        'é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œï¼Œæˆ–ç‚¹å‡»ä¸‹è½½æŒ‰é’®é€‰æ‹©ä¿å­˜æ–¹å¼' : 
        'å³é”®å›¾ç‰‡é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"ï¼Œæˆ–ç‚¹å‡»ä¸‹è½½æŒ‰é’®é€‰æ‹©ä¿å­˜æ–¹å¼';
    
    document.getElementById('downloadHint').textContent = hintText;
    document.getElementById('downloadStatsHint').textContent = hintText;
}

document.addEventListener('DOMContentLoaded', function() {
    updateDownloadHint();
    
    const downloadImage = document.getElementById('downloadImage');
    const downloadStatsImage = document.getElementById('downloadStatsImage');
    
    if (downloadImage) {
        downloadImage.addEventListener('touchstart', function() {
            if (isMobile()) {
                showToast('é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜é«˜æ¸…ç‰ˆæœ¬åˆ°æ‰‹æœºç›¸å†Œ', 'info');
            }
        }, { passive: true });
    }
    
    if (downloadStatsImage) {
        downloadStatsImage.addEventListener('touchstart', function() {
            if (isMobile()) {
                showToast('é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜é«˜æ¸…ç‰ˆæœ¬åˆ°æ‰‹æœºç›¸å†Œ', 'info');
            }
        }, { passive: true });
    }
    
    const downloadBtn = document.getElementById('downloadBtn');
    if (downloadBtn) {
        console.log('ä¸‹è½½æŒ‰é’®å·²æ‰¾åˆ°');
    }
});

['showGrid', 'showCode', 'showLegend', 'showRuler'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
        if (gridData.length > 0) {
            showLoading('æ­£åœ¨æ›´æ–°å›¾çº¸...');
            setTimeout(() => {
                renderCanvas();
                fitToScreen();
                hideLoading();
                showToast('å›¾çº¸å·²æ›´æ–°', 'success');
            }, 100);
        }
    });
});

window.addEventListener('resize', function() {
    if (colorStats.length > 0) {
        optimizeMobileStatsDisplay();
    }
});
</script>
</body>
</html>
