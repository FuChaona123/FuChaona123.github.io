<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANAæ‹¼è±†å›¾çº¸ç”Ÿæˆå™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .header { background: rgba(255,255,255,0.95); padding: 12px 20px; text-align: center; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.2rem; color: #4a5568; }
        
        .ad-banner { background: rgba(255,255,255,0.9); border: 2px dashed #cbd5e0; margin: 10px; padding: 18px; text-align: center; color: #718096; border-radius: 8px; font-size: 13px; }
        
        .main-container { max-width: 1500px; margin: 0 auto; padding: 10px; display: flex; gap: 12px; flex-wrap: wrap; }
        
        .panel { background: rgba(255,255,255,0.98); border-radius: 12px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .control-panel { width: 280px; flex-shrink: 0; }
        .preview-panel { flex: 1; min-width: 300px; }
        .stats-panel { width: 280px; flex-shrink: 0; display: none; }
        
        .section { margin-bottom: 16px; }
        .section-title { font-weight: 700; color: #2d3748; margin-bottom: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .section-title::before { content: ''; width: 3px; height: 14px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 2px; }
        
        .upload-area { border: 2px dashed #e2e8f0; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f7fafc; }
        .upload-area input { display: none; }
        .upload-area .icon { font-size: 32px; margin-bottom: 5px; }
        
        select { width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; background: white; }
        
        .slider-group { margin: 10px 0; }
        .slider-label { display: flex; justify-content: space-between; font-size: 12px; color: #4a5568; margin-bottom: 4px; }
        .slider-label span:last-child { color: #667eea; font-weight: 600; }
        input[type="range"] { width: 100%; height: 5px; border-radius: 3px; background: #e2e8f0; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); }
        
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #4a5568; }
        .checkbox-item input { width: 14px; height: 14px; accent-color: #667eea; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; display: none; }
        .btn-outline { background: white; border: 2px solid #667eea; color: #667eea; }
        .btn-outline:hover { background: #667eea; color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        .btn-info { background: linear-gradient(135deg, #4299e1, #3182ce); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        
        .preview-area { background: #f7fafc; border-radius: 8px; min-height: 350px; display: flex; align-items: center; justify-content: center; overflow: auto; position: relative; }
        #canvasWrapper { margin: 12px; position: relative; }
        canvas { display: block; box-shadow: 0 8px 30px rgba(0,0,0,0.15); cursor: default; }
        canvas.edit-mode { cursor: crosshair; }
        
        .placeholder { text-align: center; color: #a0aec0; }
        .placeholder .icon { font-size: 50px; margin-bottom: 8px; opacity: 0.5; }
        
        .zoom-bar { display: flex; gap: 6px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .zoom-btn { padding: 6px 12px; background: white; border: 1px solid #e2e8f0; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .zoom-btn:hover { border-color: #667eea; }
        
        .stats-header { margin-bottom: 10px; }
        .stats-header h3 { font-size: 14px; color: #2d3748; }
        .stats-summary { background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; }
        .stats-summary p { margin: 3px 0; color: #4a5568; }
        .stats-summary strong { color: #667eea; }
        
        .stats-table-wrap { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            margin-bottom: 10px;
        }
        .stats-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 11px; 
            table-layout: fixed;
        }
        .stats-table th { 
            background: #667eea; 
            color: white; 
            padding: 8px 5px; 
            position: sticky; 
            top: 0; 
            text-align: center;
        }
        .stats-table td { 
            padding: 6px 5px; 
            border-bottom: 1px solid #f0f0f0; 
            text-align: center; 
            word-break: break-word;
        }
        .stats-table tr:hover { background: #f7fafc; }
        .color-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 3px; 
            border: 1px solid #ddd; 
            display: inline-block; 
            vertical-align: middle; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            margin: 0 auto;
        }
        .color-dot.selected { transform: scale(1.2); box-shadow: 0 0 0 2px #667eea, 0 0 8px rgba(102,126,234,0.6); }
        .color-dot:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 20px; max-width: 95%; max-height: 90%; overflow: auto; }
        .modal-content h3 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .modal-tab { padding: 8px 16px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .modal-tab.active { background: #667eea; color: white; border-color: #667eea; }
        .modal-img-wrap { text-align: center; }
        .modal-img-wrap img { max-width: 100%; max-height: 55vh; border: 1px solid #ddd; border-radius: 4px; }
        .modal-img-wrap p { color: #666; font-size: 14px; margin-top: 10px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .modal-btn-primary { background: #667eea; color: white; }
        .modal-btn-success { background: #48bb78; color: white; }
        .modal-btn-close { background: #e2e8f0; color: #333; }
        
        .color-replace-section { display: none; margin-top: 15px; }
        .color-replace-section.show { display: block; }
        
        .selected-color-info { background: #f7fafc; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .selected-color-info p { margin: 5px 0; font-size: 12px; color: #4a5568; }
        .selected-color-info strong { color: #2d3748; }
        
        .replace-options { background: #f7fafc; border-radius: 8px; padding: 12px; }
        .replace-search { margin-bottom: 10px; }
        .replace-search input { width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 12px; }
        
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .palette-color { display: flex; flex-direction: column; align-items: center; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; }
        .palette-color:hover { border-color: #667eea; background: #f7fafc; transform: translateY(-2px); }
        .palette-color.selected { border-color: #667eea; background: #ebf4ff; box-shadow: 0 2px 8px rgba(102,126,234,0.3); }
        .palette-dot { width: 32px; height: 32px; border-radius: 4px; border: 2px solid #e2e8f0; margin-bottom: 5px; }
        .palette-id { font-size: 11px; font-weight: 600; color: #2d3748; }
        .palette-rgb { font-size: 9px; color: #718096; }
        
        .replace-buttons { display: flex; gap: 8px; margin-top: 12px; }
        .replace-buttons .btn { margin: 0; flex: 1; }
        
        /* é¢œè‰²è¿‡æ»¤åŒºåŸŸæ ·å¼ */
        .color-filter-section { margin-top: 15px; }
        
        .filter-controls { 
            background: #f7fafc; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 10px;
        }
        
        .filter-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #856404;
        }
        
        .filter-group {
            margin-bottom: 10px;
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
        }
        
        .filter-group .slider-label {
            margin-bottom: 8px;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-actions .btn {
            margin: 0;
            flex: 1;
        }
        
        /* å¯æ‹–åŠ¨çš„ç›¸ä¼¼é¢œè‰²åˆå¹¶æ¨¡æ€æ¡† */
        .similar-colors-modal .modal-content {
            max-width: 800px;
            position: absolute;
            cursor: move;
            user-select: none;
        }
        
        .similar-colors-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f7fafc;
        }
        
        .similar-group {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .similar-group:last-child {
            margin-bottom: 0;
        }
        
        .similar-group-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .similar-group-checkbox {
            margin-right: 10px;
        }
        
        .similar-group-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .similar-group-count {
            font-size: 12px;
            color: #718096;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .similar-colors {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .similar-color-item {
            display: flex;
            align-items: center;
            padding: 6px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .similar-color-dot {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .similar-color-info {
            flex: 1;
        }
        
        .similar-color-id {
            font-weight: 600;
            color: #2d3748;
        }
        
        .similar-color-count {
            color: #718096;
            font-size: 10px;
        }
        
        .similar-color-rgb {
            color: #a0aec0;
            font-size: 9px;
        }
        
        .target-color {
            display: flex;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e2e8f0;
            font-size: 12px;
        }
        
        .target-color-label {
            margin-right: 10px;
            color: #718096;
            flex-shrink: 0;
        }
        
        .target-color-preview {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .target-color-dot {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 8px;
        }
        
        .target-color-info {
            flex: 1;
        }
        
        .target-color-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .target-color-rgb {
            color: #718096;
            font-size: 10px;
        }
        
        .merge-stats {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
            font-size: 12px;
            color: #2e7d32;
        }
        
        .merge-stats h4 {
            margin-bottom: 5px;
            font-size: 13px;
            color: #2e7d32;
        }
        
        .merge-stats p {
            margin: 2px 0;
        }
        
        /* ç¼–è¾‘æ¨¡å¼å·¥å…·æ æ ·å¼ */
        .edit-toolbar {
            background: rgba(255,255,255,0.98);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .edit-toolbar.show {
            display: block;
        }
        
        .edit-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .edit-tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }
        
        .edit-tool-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .edit-tool-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .edit-tool-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .edit-tool-name {
            font-size: 11px;
            font-weight: 500;
        }
        
        .edit-color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f7fafc;
            margin-top: 10px;
            display: none;
        }
        
        .edit-color-palette.show {
            display: grid;
        }
        
        .edit-color-item {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-color-item:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .edit-color-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px #667eea;
        }
        
        .selected-color-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .selected-color-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        
        .edit-mode-hint {
            font-size: 11px;
            color: #718096;
            margin-top: 8px;
            text-align: center;
        }
        
        /* é•œåƒæŒ‰é’®æ ·å¼ */
        .mirror-btn {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
        }
        
        .mirror-btn:hover {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
        }
        
        @media (max-width: 900px) {
            .main-container { 
                flex-direction: column; 
                gap: 15px;
            }
            .control-panel, .stats-panel { 
                width: 100%; 
                max-width: 100%;
            }
            .stats-panel { 
                order: 3; 
                margin-top: 15px;
                min-height: auto;
            }
            .palette-grid { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
            
            .stats-table-wrap {
                max-height: 500px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                background: white;
            }
            
            .stats-table {
                font-size: 12px;
                width: 100%;
                min-width: 300px;
            }
            
            .stats-table th {
                padding: 10px 6px;
                font-size: 12px;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .stats-table td {
                padding: 8px 6px;
                border-bottom: 1px solid #f0f0f0;
                text-align: center;
                vertical-align: middle;
            }
            
            .stats-table th:nth-child(1),
            .stats-table td:nth-child(1) {
                width: 25%;
                text-align: center;
            }
            
            .stats-table th:nth-child(2),
            .stats-table td:nth-child(2) {
                width: 20%;
            }
            
            .stats-table th:nth-child(3),
            .stats-table td:nth-child(3) {
                width: 25%;
            }
            
            .stats-table th:nth-child(4),
            .stats-table td:nth-child(4) {
                width: 30%;
            }
            
            .color-dot {
                display: block;
                margin: 0 auto;
            }
            
            .panel {
                margin-bottom: 0;
                padding-bottom: 20px;
            }
            
            .stats-summary {
                margin-bottom: 15px;
                padding: 12px;
            }
            
            .similar-colors-modal .modal-content {
                max-width: 95%;
            }
            
            .similar-colors {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .edit-tools {
                justify-content: center;
            }
            
            .edit-tool-btn {
                min-width: 50px;
                padding: 6px 8px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-table {
                font-size: 11px;
            }
            
            .stats-table th,
            .stats-table td {
                padding: 6px 4px;
            }
            
            .color-dot {
                width: 14px;
                height: 14px;
            }
            
            .stats-summary {
                font-size: 11px;
                padding: 10px;
            }
            
            .similar-colors {
                grid-template-columns: 1fr;
            }
            
            .edit-tools {
                gap: 6px;
            }
            
            .edit-tool-btn {
                min-width: 45px;
                padding: 5px;
            }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #f56565;
        }
        
        .toast.info {
            background: #4299e1;
        }
        
        .toast.warning {
            background: #ed8936;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
        }
        
        .loading.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-options {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .download-options.show {
            display: flex;
        }
        
        .download-options-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .download-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .download-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .download-option-icon {
            font-size: 24px;
            margin-right: 12px;
            width: 40px;
            text-align: center;
        }
        
        .download-option-text {
            flex: 1;
            text-align: left;
        }
        
        .download-option-title {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }
        
        .download-option-desc {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }
        
        .download-options-title {
            margin-bottom: 20px;
            font-size: 16px;
            color: #2d3748;
        }
        
        .remember-option {
            margin-top: 15px;
            text-align: left;
            font-size: 13px;
        }
        
        .remember-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #4a5568;
        }
        
        .remember-option input {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }
        
        .mobile-download-guide {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            z-index: 4000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .mobile-download-guide.show {
            display: block;
        }
        
        .mobile-download-guide h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            text-align: center;
        }
        
        .mobile-download-guide ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .mobile-download-guide li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }
        
        .mobile-download-guide .tip {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 13px;
            color: #856404;
        }
        
        .guide-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .guide-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .guide-retry {
            background: #667eea;
            color: white;
        }
        
        .guide-close {
            background: #e2e8f0;
            color: #333;
        }
        
        .download-progress {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 4000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .download-progress.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
        }
        
        .stats-panel.auto-height .stats-table-wrap {
            max-height: none;
            height: auto;
            overflow: visible;
        }
        
        .stats-panel:after {
            content: '';
            display: table;
            clear: both;
        }
    </style>
</head>
<body>
<div class="header"><h1>ğŸ¨ NANAæ‹¼è±†å›¾çº¸ç”Ÿæˆå™¨</h1></div>
<div class="ad-banner">ğŸ“¢ å¹¿å‘Šä½ 1 (728Ã—90)</div>
<div class="main-container">
    <div class="panel control-panel">
        <div class="section">
            <div class="section-title">ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="icon">ğŸ“</div>
                <p style="font-size:13px;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div id="fileName" style="margin-top:6px;font-size:11px;color:#718096;"></div>
        </div>
        <div class="section">
            <div class="section-title">å›¾çº¸è®¾ç½®</div>
            <div class="slider-group">
                <div class="slider-label"><span>å®½åº¦</span><span id="widthVal">50 æ ¼</span></div>
                <input type="range" id="widthSlider" min="20" max="150" value="50" oninput="document.getElementById('widthVal').textContent=this.value+' æ ¼'">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>å¤§æ ¼å­è¾¹æ¡†</span><span id="bigGridVal">10 æ ¼</span></div>
                <input type="range" id="bigGridSlider" min="3" max="15" value="10" oninput="document.getElementById('bigGridVal').textContent=this.value+' æ ¼'">
                <div style="font-size:11px;color:#718096;margin-top:3px;">æ¯ {value}Ã—{value} ä¸ªå°æ ¼å­ç»„æˆä¸€ä¸ªå¤§æ ¼å­å¹¶åŠ ç²—è¾¹æ¡†</div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">è‰²æ¿é€‰æ‹©</div>
            <select id="paletteSelect">
                <optgroup label="MARD ç³»åˆ—">
                    <option value="mard_full">MARD å…¨è‰²ç³» (200+è‰²)</option>
                    <option value="mard_128">MARD 128è‰²</option>
                    <option value="mard_64">MARD 64è‰²</option>
                    <option value="mard_32">MARD 32è‰²</option>
                </optgroup>
                <optgroup label="COCO ç³»åˆ—">
                    <option value="coco_full">COCO å…¨è‰²ç³»</option>
                    <option value="coco_128">COCO 128è‰²</option>
                    <option value="coco_64">COCO 64è‰²</option>
                    <option value="coco_32">COCO 32è‰²</option>
                </optgroup>
                <optgroup label="æ¼«æ¼« ç³»åˆ—">
                    <option value="manson_full">æ¼«æ¼« å…¨è‰²ç³»</option>
                    <option value="manson_128">æ¼«æ¼« 128è‰²</option>
                    <option value="manson_64">æ¼«æ¼« 64è‰²</option>
                    <option value="manson_32">æ¼«æ¼« 32è‰²</option>
                </optgroup>
                <optgroup label="ç›¼ç›¼ ç³»åˆ—">
                    <option value="panpan_full">ç›¼ç›¼ å…¨è‰²ç³»</option>
                    <option value="panpan_128">ç›¼ç›¼ 128è‰²</option>
                    <option value="panpan_64">ç›¼ç›¼ 64è‰²</option>
                    <option value="panpan_32">ç›¼ç›¼ 32è‰²</option>
                </optgroup>
                <optgroup label="å’ªå°çª ç³»åˆ—">
                    <option value="mihome_full">å’ªå°çª å…¨è‰²ç³»</option>
                    <option value="mihome_128">å’ªå°çª 128è‰²</option>
                    <option value="mihome_64">å’ªå°çª 64è‰²</option>
                    <option value="mihome_32">å’ªå°çª 32è‰²</option>
                </optgroup>
                <optgroup label="å…¶ä»–">
                    <option value="perler">Perler å…¨è‰² (60+è‰²)</option>
                    <option value="hama">Hama å…¨è‰²ç³»</option>
                </optgroup>
            </select>
        </div>
        <div class="section">
            <div class="section-title">æ˜¾ç¤ºé€‰é¡¹</div>
            <div class="checkbox-grid">
                <label class="checkbox-item"><input type="checkbox" id="showGrid" checked> ç½‘æ ¼çº¿</label>
                <label class="checkbox-item"><input type="checkbox" id="showCode" checked> è‰²å·</label>
                <label class="checkbox-item"><input type="checkbox" id="showLegend" checked> è‰²å¡</label>
                <label class="checkbox-item"><input type="checkbox" id="showRuler" checked> åæ ‡</label>
            </div>
        </div>
        
        <!-- é¢œè‰²è¿‡æ»¤åŒºåŸŸ -->
        <div class="section color-filter-section">
            <div class="section-title">ğŸ” é¢œè‰²è¿‡æ»¤</div>
            <div class="filter-info">
                ğŸ’¡ å»é™¤æ‚è‰²ï¼šåˆå¹¶ç›¸ä¼¼é¢œè‰²ï¼Œè®©å›¾çº¸é¢œè‰²æ›´ç®€æ´
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <div class="slider-label">
                        <span>ç›¸ä¼¼åº¦é˜ˆå€¼</span>
                        <span id="similarityVal">15</span>
                    </div>
                    <input type="range" id="similaritySlider" min="5" max="50" value="15" oninput="document.getElementById('similarityVal').textContent=this.value">
                </div>
                <div class="filter-actions">
                    <button class="btn btn-info" onclick="findSimilarColors()">ğŸ” æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²</button>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="generatePattern()">âœ¨ ç”Ÿæˆå›¾çº¸</button>
        <button class="btn btn-success" id="downloadBtn" onclick="openDownloadModal()">ğŸ’¾ ä¿å­˜ä¸‹è½½</button>
        <button class="btn btn-outline" id="editModeBtn" onclick="toggleEditMode()">âœï¸ ç¼–è¾‘æ¨¡å¼</button>
        <button class="btn mirror-btn" onclick="mirrorPattern()">ğŸ”„ æ°´å¹³é•œåƒ</button>
        
        <!-- ç¼–è¾‘æ¨¡å¼å·¥å…·æ  -->
        <div class="edit-toolbar" id="editToolbar">
            <div class="edit-tools">
                <div class="edit-tool-btn active" id="penTool" onclick="selectTool('pen')">
                    <div class="edit-tool-icon">âœï¸</div>
                    <div class="edit-tool-name">ç”»ç¬”</div>
                </div>
                <div class="edit-tool-btn" id="eraserTool" onclick="selectTool('eraser')">
                    <div class="edit-tool-icon">ğŸ§½</div>
                    <div class="edit-tool-name">æ©¡çš®</div>
                </div>
                <div class="edit-tool-btn" id="dropperTool" onclick="selectTool('dropper')">
                    <div class="edit-tool-icon">ğŸ’§</div>
                    <div class="edit-tool-name">å¸ç®¡</div>
                </div>
            </div>
            
            <div class="selected-color-display" id="selectedColorDisplay">
                <div class="selected-color-box" id="currentColorBox"></div>
                <div id="currentColorInfo">å½“å‰é¢œè‰²: <span id="currentColorText">è¯·é€‰æ‹©é¢œè‰²</span></div>
            </div>
            
            <div class="edit-color-palette" id="editColorPalette">
                <!-- é¢œè‰²é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="edit-mode-hint">
                ğŸ’¡ æç¤ºï¼šåœ¨å›¾çº¸ä¸Šç‚¹å‡»æˆ–æ‹–åŠ¨è¿›è¡Œç»˜åˆ¶
            </div>
        </div>
        
        <div class="color-replace-section" id="colorReplaceSection">
            <div class="section-title">ğŸ¨ è‰²å·æ›¿æ¢</div>
            <div class="selected-color-info" id="selectedColorInfo">
                <p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>
            </div>
            <div class="replace-options" id="replaceOptions" style="display:none;">
                <div class="replace-search">
                    <input type="text" id="paletteSearch" placeholder="æœç´¢è‰²å·æˆ–é¢œè‰²..." oninput="searchPalette()">
                </div>
                <div class="palette-grid" id="paletteGrid"></div>
                <div class="replace-buttons">
                    <button class="btn btn-primary" onclick="replaceColor()">âœ… æ›¿æ¢é¢œè‰²</button>
                    <button class="btn btn-outline" onclick="cancelReplace()">å–æ¶ˆ</button>
                </div>
            </div>
            <button class="btn btn-warning" onclick="resetAllColors()" style="margin-top:10px;">ğŸ”„ é‡ç½®æ‰€æœ‰é¢œè‰²</button>
        </div>
        
        <div class="ad-banner" style="margin-top:12px;padding:25px 10px;">ğŸ“¢ å¹¿å‘Šä½ 2</div>


    </div>
    <div class="panel preview-panel">
        <div class="preview-area" id="previewArea">
            <div class="placeholder" id="placeholder"><div class="icon">ğŸ–¼ï¸</div><p>ä¸Šä¼ å›¾ç‰‡åç‚¹å‡»ç”Ÿæˆ</p></div>
            <div id="canvasWrapper" style="display:none;"><canvas id="mainCanvas"></canvas></div>
        </div>
        <div class="zoom-bar" id="zoomBar" style="display:none;">
            <button class="zoom-btn" onclick="zoomCanvas(-0.15)">â– ç¼©å°</button>
            <button class="zoom-btn" onclick="fitToScreen()">ğŸ“ é€‚åº”</button>
            <button class="zoom-btn" onclick="zoomCanvas(0.15)">â• æ”¾å¤§</button>
        </div>
    </div>
    <div class="panel stats-panel" id="statsPanel">
        <div class="stats-header"><h3>ğŸ“Š è‰²å·ç»Ÿè®¡</h3></div>
        <div class="stats-summary" id="statsSummary"></div>
        <div class="stats-table-wrap">
            <table class="stats-table"><thead><tr><th>è‰²å·</th><th>é¢œè‰²</th><th>æ•°é‡</th><th>å æ¯”</th></tr></thead><tbody id="statsBody"></tbody></table>
        </div>
    </div>
</div>

<!-- ä¸‹è½½æ¨¡æ€æ¡† -->
<div class="modal" id="downloadModal">
    <div class="modal-content">
        <h3>ğŸ“¥ ä¿å­˜å›¾çº¸ä¸ç»Ÿè®¡</h3>
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchTab(this,'pattern')">æ‹¼è±†å›¾çº¸</button>
            <button class="modal-tab" onclick="switchTab(this,'stats')">ç»Ÿè®¡è¡¨æ ¼</button>
        </div>
        <div id="tabPattern" class="modal-img-wrap">
            <img id="downloadImage" src="" alt="æ‹¼è±†å›¾çº¸" crossorigin="anonymous">
            <p id="downloadHint" style="color:#666;font-size:14px;margin-top:10px;"></p>
        </div>
        <div id="tabStats" class="modal-img-wrap" style="display:none;">
            <img id="downloadStatsImage" src="" alt="ç»Ÿè®¡è¡¨æ ¼" crossorigin="anonymous">
            <p id="downloadStatsHint" style="color:#666;font-size:14px;margin-top:10px;"></p>
        </div>
        <div class="modal-btns">
            <button class="modal-btn modal-btn-primary" onclick="showDownloadOptions('pattern')">ğŸ’¾ ä¸‹è½½å›¾çº¸</button>
            <button class="modal-btn modal-btn-success" onclick="showDownloadOptions('stats')">ğŸ“Š ä¸‹è½½ç»Ÿè®¡</button>
            <button class="modal-btn modal-btn-close" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- ç›¸ä¼¼é¢œè‰²åˆå¹¶æ¨¡æ€æ¡† -->
<div class="modal similar-colors-modal" id="similarColorsModal">
    <div class="modal-content" id="similarColorsModalContent">
        <h3>ğŸ” ç›¸ä¼¼é¢œè‰²åˆå¹¶</h3>
        <p style="color:#666;font-size:14px;margin-bottom:15px;">
            æ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼ <strong id="currentThreshold">15</strong> æ‰¾åˆ°çš„ç›¸ä¼¼é¢œè‰²ç»„ã€‚æ¯ä¸ªç»„å†…çš„é¢œè‰²å°†è¢«åˆå¹¶ä¸ºæœ€å¸¸ç”¨çš„é¢œè‰²ã€‚
        </p>
        
        <div class="similar-colors-list" id="similarColorsList">
            <!-- ç›¸ä¼¼é¢œè‰²ç»„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="merge-stats" id="mergeStats" style="display:none;">
            <h4>åˆå¹¶ç»Ÿè®¡</h4>
            <p id="mergeInfo">å°†åˆå¹¶ 0 ç»„ç›¸ä¼¼é¢œè‰²ï¼Œå‡å°‘ 0 ç§é¢œè‰²</p>
        </div>
        
        <div class="modal-btns">
            <button class="modal-btn modal-btn-success" onclick="mergeSimilarColors()">âœ… åˆå¹¶é€‰ä¸­çš„é¢œè‰²</button>
            <button class="modal-btn modal-btn-close" onclick="closeSimilarColorsModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- ä¸‹è½½é€‰é¡¹æ¨¡æ€æ¡† -->
<div id="downloadOptions" class="download-options">
    <div class="download-options-content">
        <div class="download-options-title">é€‰æ‹©ä¿å­˜æ–¹å¼</div>
        <div class="download-option" onclick="saveToBrowser()">
            <div class="download-option-icon">ğŸ“</div>
            <div class="download-option-text">
                <div class="download-option-title">ä¿å­˜åˆ°æµè§ˆå™¨é»˜è®¤ä½ç½®</div>
                <div class="download-option-desc">ç›´æ¥ä¸‹è½½åˆ°æ‰‹æœºä¸‹è½½æ–‡ä»¶å¤¹</div>
            </div>
        </div>
        <div class="download-option" onclick="saveToPhotoAlbum()">
            <div class="download-option-icon">ğŸ“±</div>
            <div class="download-option-text">
                <div class="download-option-title">ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œ</div>
                <div class="download-option-desc">ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ä¿å­˜åˆ°ç›¸å†Œ</div>
            </div>
        </div>
        <div class="download-option" onclick="manualSave()">
            <div class="download-option-icon">ğŸ‘†</div>
            <div class="download-option-text">
                <div class="download-option-title">æ‰‹åŠ¨ä¿å­˜</div>
                <div class="download-option-desc">é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</div>
            </div>
        </div>
        <div class="remember-option">
            <label>
                <input type="checkbox" id="rememberChoice">
                è®°ä½æˆ‘çš„é€‰æ‹©ï¼Œä¸‹æ¬¡ä¸å†è¯¢é—®
            </label>
        </div>
        <button class="modal-btn modal-btn-close" onclick="hideDownloadOptions()" style="margin-top:15px;">å–æ¶ˆ</button>
    </div>
</div>

<canvas id="highResCanvas" style="display:none;"></canvas>
<canvas id="statsCanvas" style="display:none;"></canvas>
<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p id="loadingText">æ­£åœ¨å¤„ç†...</p>
</div>
<div id="toast" class="toast"></div>

<!-- ç§»åŠ¨ç«¯ä¸‹è½½å¼•å¯¼ -->
<div id="mobileDownloadGuide" class="mobile-download-guide">
    <h4>ğŸ“± æ‰‹æœºä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—</h4>
    <ol>
        <li>ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹ä¸‹è½½"æŒ‰é’®</li>
        <li>ç­‰å¾…å›¾ç‰‡ä¸‹è½½å®Œæˆ</li>
        <li>åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°ä¸‹è½½çš„å›¾ç‰‡</li>
        <li>é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"æˆ–"è®¾ä¸ºå£çº¸"</li>
    </ol>
    <div class="tip">
        ğŸ’¡ æç¤ºï¼šå¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²å…è®¸æµè§ˆå™¨ä¸‹è½½æƒé™ï¼Œå¹¶å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
        <br>1. ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨ï¼ˆå¦‚Safariã€Chromeï¼‰
        <br>2. æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡è¯•
        <br>3. ä½¿ç”¨"æ‰‹åŠ¨ä¿å­˜"åŠŸèƒ½
    </div>
    <div class="guide-buttons">
        <button class="guide-retry" onclick="startMobileDownload()">å¼€å§‹ä¸‹è½½</button>
        <button class="guide-close" onclick="closeMobileGuide()">å…³é—­</button>
    </div>
</div>

<!-- ä¸‹è½½è¿›åº¦ -->
<div id="downloadProgress" class="download-progress">
    <h4>æ­£åœ¨ä¸‹è½½...</h4>
    <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="progressText" class="progress-text">å‡†å¤‡ä¸‹è½½ä¸­...</div>
</div>


        <!-- æ”¯æŒå¼€å‘è€…åŒºåŸŸ -->
<div class="support-section" style="
    background: linear-gradient(135deg, #f0f4ff 0%, #e6eeff 100%);
    border: 1px solid #c3dafe;
    border-radius: 12px;
    padding: 18px;
    margin: 15px 10px 10px 10px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
">
    <div class="support-header" style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px;
    ">
        <span style="font-size: 20px;">ğŸ</span>
        <h3 style="
            font-size: 15px;
            color: #4a5568;
            font-weight: 600;
            margin: 0;
        ">æ”¯æŒå¼€å‘è€…ï¼ˆå®Œå…¨è‡ªæ„¿ï¼‰</h3>
    </div>
    
    <div class="support-description" style="
        font-size: 12px;
        line-height: 1.5;
        color: #718096;
        text-align: left;
        margin-bottom: 15px;
        background: rgba(255,255,255,0.7);
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid #4299e1;
    ">
        <p style="margin-bottom: 8px;">æ„Ÿè°¢æ‚¨ä½¿ç”¨æ‹¼è±†å›¾çº¸ç”Ÿæˆå™¨ï¼è¿™ä¸ªå·¥å…·æ˜¯æˆ‘åˆ©ç”¨ä¸šä½™æ—¶é—´å¼€å‘çš„ï¼Œå¸Œæœ›èƒ½å¸®åŠ©æ›´å¤šæ‹¼è±†çˆ±å¥½è€…ã€‚</p>
        <p style="margin-bottom: 8px;">å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªå·¥å…·å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ„¿æ„æ”¯æŒæˆ‘ç»§ç»­å¼€å‘å’Œç»´æŠ¤ï¼Œå¯ä»¥æ‰«æä¸‹æ–¹äºŒç»´ç <strong style="color:#667eea;">éšå–œæ”¯æŒ</strong>ï¼ˆ<strong style="color:#e53e3e;">å®Œå…¨è‡ªæ„¿ï¼Œä¸å¼ºåˆ¶</strong>ï¼‰ã€‚</p>
        
        <div style="
            background: #f7fafc;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            border: 1px dashed #cbd5e0;
        ">
            <p style="
                font-size: 11px;
                font-weight: 600;
                color: #4a5568;
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 5px;
            ">
                <span style="color:#667eea;">âœ¨</span> æ‚¨çš„æ¯ä¸€ä»½æ”¯æŒéƒ½å°†ç›´æ¥ç”¨äºï¼š
            </p>
            <ul style="
                margin: 0;
                padding-left: 18px;
                font-size: 11px;
                color: #718096;
                line-height: 1.6;
            ">
                <li>ğŸ’» æ”¯ä»˜äº‘æœåŠ¡å™¨è´¹ç”¨ï¼ˆè®©å·¥å…·ä¿æŒç¨³å®šè¿è¡Œï¼‰</li>
                <li>ğŸ¨ è´­ä¹°æ‹¼è±†æ ·å“æµ‹è¯•é¢œè‰²å‡†ç¡®æ€§</li>
                <li>â° æŠ•å…¥æ›´å¤šæ—¶é—´å¼€å‘æ–°åŠŸèƒ½</li>
                <li>âœ¨ ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œä¿®å¤bug</li>
            </ul>
        </div>
        
        <p style="
            font-size: 11px;
            background: #fff5f5;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #fc8181;
            margin: 10px 0 0 0;
        ">
            <strong style="color:#e53e3e;">ğŸŒŸ å†æ¬¡å¼ºè°ƒï¼šè¿™æ˜¯å®Œå…¨è‡ªæ„¿çš„éšå–œæ”¯æŒ</strong>ï¼Œæ— è®ºæ‚¨æ˜¯å¦æ”¯æŒï¼Œéƒ½å¯ä»¥ç»§ç»­å…è´¹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é™ªä¼´ ğŸ’•
        </p>
    </div>
    
    <div class="qrcode-container" style="
        background: white;
        padding: 15px;
        border-radius: 10px;
        display: inline-block;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        margin: 5px 0;
    ">
        <!-- è¯·å°†ä¸‹æ–¹srcæ›¿æ¢ä¸ºä½ çš„æ”¶æ¬¾ç å›¾ç‰‡åœ°å€ -->
        <img src="æ”¶æ¬¾ç .jpg" alt="æ”¶æ¬¾ç " style="
            width: 180px;
            height: 180px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        ">
        <div style="
            margin-top: 10px;
            font-size: 11px;
            color: #718096;
        ">
            <p style="margin: 3px 0;">ğŸ’ é•¿æŒ‰è¯†åˆ«æˆ–æˆªå›¾æ‰«æ</p>
            <p style="margin: 3px 0; color: #fc8181; font-size: 10px;">
                * é‡‘é¢éšæ„ï¼Œé‡åœ¨å¿ƒæ„ *
            </p>
        </div>
    </div>
    
    <div class="support-footer" style="
        margin-top: 12px;
        font-size: 10px;
        color: #a0aec0;
        border-top: 1px dashed #e2e8f0;
        padding-top: 10px;
    ">
        <p style="margin: 3px 0;">ğŸ™ æ„Ÿè°¢æ¯ä¸€ä½æ‹¼è±†çˆ±å¥½è€…çš„æ”¯æŒä¸é¼“åŠ±</p>
        <p style="margin: 3px 0;">æœ‰ä»»ä½•å»ºè®®æˆ–é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶åé¦ˆ</p>
    </div>
</div>
//æ”¯æŒå¼€å‘è€…åŒºåŸŸï¼ˆå°¾ï¼‰

<script>
// ä»CSVæ•°æ®è§£æå‡ºäº”ä¸ªè‰²æ¿çš„æ•°æ®
const csvData = `187 198 182,M1,Y1,YX11,168,168,207,
144 153 148,M2,Y2,YX12,172,172,208,
105 126 128,M3,Y3,YX2,166,166,209,
224 212 188,M4,Y4,YX15,167,167,210,
208 203 174,M5,Y5,YX6,174,159,211,
176 170 134,M6,Y6,YX1,169,169,212,
176 167 150,M7,Y7,YX13,171,171,213,
174 128 130,M8,Y8,YX14,177,162,214,
168 135 100,M9,Y9,YX10,170,170,215,
198 178 187,M10,Y10,YX9,164,164,216,
157 118 147,M11,Y11,YX4,176,161,217,
100 75 81,M12,Y12,YX5,173,173,218,
199 146 102,M13,Y13,YX8,175,160,219,
195 116 99,M14,Y14,YX3,165,165,220,
116 125 122,M15,Y15,YX7,178,163,221,
250 245 205,A1,E2,E2,65,77,1,
252 254 214,A2,E1,B1,2,2,2,
252 255 146,A3,E5,R2,28,28,3,
247 236 92,A4,E7,B3,3,3,4,
255 228 75,A5,D3,B4,74,79,5,
253 169 81,A6,D5,B5,29,29,6,
250 140 79,A7,D8,B6,4,4,7,
249 224 69,A8,E8,B10,88,98,8,
249 156 95,A9,D6,B11,90,97,9,
244 126 54,A10,D7,B12,89,96,10,
254 219 153,A11,D1,E11,100,109,11,
253 162 118,A12,K9,A18,99,110,12,
254 198 103,A13,D4,B13,131,116,13,
248 88 66,A14,C5,B14,138,135,14,
251 246 94,A15,E4,B15,150,150,15,
254 255 151,A16,E3,IC4,216,216,16,
253 225 115,A17,E6,IC9,213,213,17,
252 191 128,A18,D2,IC14,223,208,18,
253 126 119,A19,K10,IC15,218,218,19,
249 214 110,A20,E9,Q6,242,242,20,
250 227 147,A21,E10,R7,276,261,21,
237 248 120,A22,E11,R6,270,255,22,
225 201 189,A23,E12,R8,274,259,23,
243 246 169,A24,E13,G3,288,273,24,
255 215 133,A25,E14,G4,289,274,25,
254 200 50,A26,E15,G5,290,275,26,
255 228 211,G1,Z2,E3,76,81,163,
252 198 172,G2,Z5,E4,49,49,164,
241 196 165,G3,Z6,E5,80,85,165,
220 179 135,G4,Z8,E6,19,19,166,
231 179 78,G5,Z10,B7,43,43,167,
243 160 20,G6,Z11,B8,50,50,168,
152 80 58,G7,Z18,E7,17,17,169,
75 43 28,G8,Z22,B8,12,12,170,
228 182 133,G9,Z9,E10,91,102,171,
218 140 66,G10,Z15,B9,87,101,172,
218 200 152,G11,Z7,E12,112,118,173,
254 201 147,G12,Z13,E13,113,127,174,
178 113 75,G13,Z14,E17,115,114,175,
139 104 76,G14,Z17,E14,114,123,176,
246 248 227,G15,Z3,E19,133,143,177,
242 216 193,G16,Z4,E20,134,138,178,
121 84 78,G17,Z16,E22,144,137,179,
255 228 214,G18,Z1,DH5,203,203,180,
221 125 65,G19,Z12,DH3,208,195,181,
165 69 47,G20,Z19,DH13,199,199,182,
179 133 97,G21,Z24,Q8,247,247,183,
212 14 31,R1,L1,T1,67,52,250,
241 52 132,R2,L2,N1,24,24,251,
251 133 43,R3,L3,N2,22,22,252,
248 237 51,R4,L4,N3,21,21,253,
50 201 88,R5,L5,N4,23,23,254,
30 186 147,R6,L6,T4,69,55,255,
29 119 156,R7,L7,T5,37,37,256,
25 96 200,R8,L8,T3,68,54,257,
148 90 177,R9,L9,T2,70,56,258,
248 218 84,R10,L10,L2,156,53,259,
252 236 247,R11,L11,T6,151,151,260,
216 212 211,R12,L12,T7,160,157,261,
86 83 78,R13,L13,-,152,152,262,
163 231 220,R14,S1,S1,231,231,263,
120 206 231,R15,S2,S2,237,224,264,
63 205 206,R16,S3,S3,238,225,265,
78 131 121,R17,S4,S5,233,233,266,
125 202 156,R18,S5,S4,235,222,267,
200 230 100,R19,S6,S11,227,227,268,
227 204 186,R20,S7,S6,230,230,269,
161 113 64,R21,S8,S13,234,221,270,
107 55 44,R22,S9,S15,226,226,271,
246 187 111,R23,S10,S12,224,219,272,
243 198 192,R24,S11,S4,228,228,273,
199 106 98,R25,S12,S14,225,220,274,
208 147 188,R26,S13,S9,229,229,275,
229 142 174,R27,S14,S8,232,232,276,
159 133 207,R28,S15,S10,236,223,277,
246 212 203,E1,K3,E1,18,18,114,
252 193 221,E2,K15,A7,38,38,115,
246 189 232,E3,K17,A8,62,74,116,
233 99 158,E4,K21,A9,6,6,117,
241 85 159,E5,K19,A10,40,40,118,
236 64 114,E6,K22,A11,20,20,119,
198 54 116,E7,K25,A12,41,41,120,
253 219 233,E8,K12,A13,84,103,121,
229 117 199,E9,K18,A14,98,95,122,
211 57 151,E10,K23,A16,83,94,123,
247 218 212,E11,K2,A19,125,131,124,
248 147 191,E12,K16,A20,126,112,125,
181 2 106,E13,K24,A21,127,124,126,
250 212 191,E14,K5,E21,137,140,127,
245 201 202,E15,K4,A23,135,139,128,
251 244 236,E16,K1,IC2,221,206,129,
247 227 236,E17,K11,IC7,220,205,130,
251 203 219,E18,K13,IC13,210,210,131,
246 187 209,E19,K14,IC12,215,215,132,
215 198 206,E20,K26,Q1,241,241,133,
192 157 164,E21,K27,Q2,253,238,134,
181 139 159,E22,K28,Q4,252,237,135,
147 125 138,E23,K29,Q3,250,235,136,
222 190 229,E24,K30,G8,282,267,137,
218 171 179,ZG1,GB1,ZG1,254,ZG1,288,
214 170 135,ZG2,GB2,ZG2,255,ZG2,289,
193 189 141,ZG3,GB3,ZG3,256,ZG3,290,
150 182 159,ZG4,GB4,ZG4,257,ZG4,291,
132 157 198,ZG5,GB5,ZG5,258,ZG5,292,
148 191 226,ZG6,GB6,ZG6,259,ZG6,293,
226 169 210,ZG7,GB7,ZG7,260,ZG7,294,
171 145 192,ZG8,GB8,ZG8,261,ZG8,295,
255 254 228,C1,G1,C8,64,76,59,
171 248 254,C2,H3,D1,30,30,60,
158 224 248,C3,H4,D2,63,75,61,
68 205 251,C4,H5,D3,77,82,62,
6 171 227,C5,H7,D7,34,34,63,
84 167 233,C6,H8,D4,25,25,64,
57 119 204,C7,H13,D8,9,9,65,
15 82 189,C8,H14,D9,52,71,66,
51 73 195,C9,H16,N5,42,42,67,
61 187 227,C10,H9,D25,121,130,68,
42 222 211,C11,H10,D28,122,113,69,
30 51 78,C12,H23,D26,120,120,70,
205 231 254,C13,H1,D30,140,142,71,
214 253 252,C14,H2,D29,139,136,72,
33 197 196,C15,H11,D31,143,132,73,
24 88 162,C16,H18,D32,149,149,74,
2 209 243,C17,H19,D36,163,156,75,
33 50 68,C18,H24,DH6,196,196,76,
24 134 144,C19,H12,DH9,202,202,77,
26 112 169,C20,H17,DH14,197,197,78,
190 221 252,C21,H6,IC3,212,212,79,
107 177 187,C22,H25,Q11,239,239,80,
200 226 249,C23,H26,R13,263,263,81,
126 197 249,C24,H27,R14,267,252,82,
169 232 224,C25,H28,R12,271,256,83,
66 173 209,C26,H29,R15,265,250,84,
208 222 239,C27,H30,G13,279,264,85,
189 206 237,C28,H31,G14,280,265,86,
54 74 137,C29,H32,G15,281,266,87,
251 251 251,H1,A2,F1,15,15,184,
255 255 255,H2,A1,F2,1,1,185,
180 180 180,H3,B3,F3,13,13,186,
135 135 135,H4,B5,F4,78,83,187,
70 70 72,H5,B6,F5,45,45,188,
44 44 44,H6,B7,F6,51,70,189,
1 1 1,H7,B9,F7,14,14,190,
231 214 220,H8,A9,F8,85,86,191,
239 237 238,H9,A8,F10,95,87,192,
236 234 235,H10,A10,F9,86,88,193,
205 205 205,H11,B1,F11,123,121,194,
253 246 238,H12,A4,E18,132,144,195,
244 239 209,H13,A6,E23,145,146,196,
206 215 212,H14,B2,F12,146,145,197,
152 166 166,H15,B4,DH4,201,201,198,
27 18 19,H16,B8,DH11,200,200,199,
240 238 239,H17,A7,IC6,214,214,200,
252 255 248,H18,A3,IC1,219,204,201,
242 238 229,H19,A5,IC11,209,209,202,
150 160 159,H20,B10,Q12,251,236,203,
248 251 230,H21,A11,G1,291,276,204,
202 202 218,H22,A12,G2,277,277,205,
155 156 148,H23,B11,G11,278,278,206,
249 249 249,P1,M1,P1,71,62,222,
171 171 171,P2,M2,P2,55,69,223,
182 219 175,P3,M3,P4,73,66,224,
254 162 163,P4,M4,P5,72,64,225,
235 144 63,P5,M5,P3,56,63,226,
99 206 162,P6,M6,P8,70,65,227,
231 146 115,P7,M7,P6,68,68,228,
236 219 89,P8,M8,P7,67,67,229,
219 217 218,P9,M9,P13,195,178,230,
219 199 234,P10,M10,P18,187,187,231,
241 233 212,P11,M11,P9,185,185,232,
233 237 238,P12,M12,P12,190,190,233,
173 203 241,P13,M13,P17,193,176,234,
51 123 173,P14,M14,P22,183,183,235,
102 133 117,P15,M15,P23,184,184,236,
253 194 78,P16,M16,P14,182,182,237,
253 164 46,P17,M17,P19,179,179,238,
254 189 167,P18,M18,P11,194,177,239,
255 222 233,P19,M19,P10,186,186,240,
252 191 209,P20,M21,P15,188,180,241,
232 190 194,P21,M20,P20,180,188,242,
223 170 164,P22,M22,P16,189,189,243,
163 101 106,P23,M23,P21,181,181,244,
255 146 128,F1,K8,A1,35,35,138,
247 61 72,F2,C2,A2,31,31,139,
239 77 62,F3,C3,A3,53,72,140,
249 43 64,F4,C6,A4,54,73,141,
227 3 40,F5,C7,A5,5,5,142,
145 54 53,F6,Z21,E9,16,16,143,
145 25 50,F7,C10,A6,47,47,144,
187 1 38,F8,C9,A17,81,92,145,
224 103 122,F9,K20,A15,82,93,146,
135 70 40,F10,Z20,E15,116,115,147,
111 50 29,F11,Z23,E16,117,129,148,
248 81 109,F12,C1,A22,136,134,149,
244 92 69,F13,C4,A24,148,148,150,
252 173 178,F14,K7,A25,154,154,151,
213 5 39,F15,C8,DH8,204,191,152,
248 192 169,F16,K6,IC10,211,211,153,
232 155 125,F17,K31,Q9,245,245,154,
208 126 74,F18,K32,Q10,246,246,155,
190 69 74,F19,K33,Q5,243,243,156,
198 148 149,F20,K34,R4,275,260,157,
242 187 198,F21,K35,R3,266,251,158,
247 195 208,F22,K36,R2,272,257,159,
236 128 109,F23,K37,R5,264,249,160,
224 157 175,F24,K38,G9,283,268,161,
232 72 84,F25,K39,G10,284,269,162,
223 241 57,B1,F5,C1,48,48,27,
100 243 67,B2,F8,C2,33,33,28,
159 246 133,B3,F4,C7,26,26,29,
95 223 52,B4,F9,C3,66,78,30,
57 225 88,B5,F10,C4,39,39,31,
100 224 164,B6,G4,C9,11,11,32,
63 174 124,B7,G5,C10,44,44,33,
29 158 84,B8,F11,C5,10,10,34,
42 80 55,B9,F16,C6,79,84,35,
154 209 186,B10,G3,C11,96,100,36,
98 112 50,B11,F14,C12,97,99,37,
26 110 61,B12,F12,C13,106,111,38,
200 232 125,B13,F2,C14,128,119,39,
172 232 76,B14,F6,C15,129,117,40,
48 83 53,B15,F15,C16,130,122,41,
192 237 156,B16,F3,C17,141,133,42,
158 179 62,B17,F13,C18,142,141,43,
230 237 79,B18,F7,C19,147,147,44,
38 183 142,B19,G6,DH15,191,174,45,
202 237 207,B20,G2,DH10,192,175,46,
23 98 104,B21,G7,DH2,207,194,47,
10 66 65,B22,G8,DH7,206,193,48,
52 59 26,B23,F17,DH12,205,192,49,
232 250 166,B24,F1,IC5,222,207,50,
78 132 109,B25,F18,Q13,240,240,51,
144 124 53,B26,F19,Q7,248,248,52,
208 224 175,B27,F20,R10,262,262,53,
158 229 187,B28,F21,R11,269,254,54,
198 223 95,B29,F22,R9,268,253,55,
227 251 177,B30,F23,G6,285,270,56,
178 230 148,B31,F24,G7,286,271,57,
146 173 96,B32,F25,G12,287,272,58,
172 183 239,D1,J7,D5,46,46,88,
134 141 211,D2,J8,D6,36,36,89,
54 83 175,D3,H15,D10,8,8,90,
22 44 126,D4,H20,D11,75,80,91,
179 78 198,D5,J12,D13,32,32,92,
179 123 220,D6,J11,D14,27,27,93,
135 88 169,D7,J15,D12,7,7,94,
227 210 254,D8,J3,D16,94,89,95,
214 186 245,D9,J4,D17,93,90,96,
48 26 73,D10,J19,D15,92,91,97,
188 186 226,D11,J6,D19,105,104,98,
220 153 206,D12,J10,D20,104,105,99,
181 3 143,D13,J14,D21,103,106,100,
136 40 147,D14,J16,D22,102,107,101,
47 30 142,D15,H22,D18,101,108,102,
226 228 240,D16,J1,D23,118,126,103,
199 211 249,D17,J5,D24,119,128,104,
154 100 184,D18,J13,D27,124,125,105,
216 194 217,D19,J9,D33,153,153,106,
156 52 173,D20,J17,D34,161,155,107,
148 5 149,D21,J18,D35,162,158,108,
56 57 149,D22,H21,DH1,198,198,109,
250 219 248,D23,J2,IC8,217,217,110,
118 138 225,D24,J20,Q14,244,244,111,
73 80 194,D25,J21,Q15,249,234,112,
214 198 235,D26,J22,R1,273,258,113,
242 165 232,Q1,W3,W3,109,W3,245,
233 236 145,Q2,W4,W4,111,W4,246,
255 255 0,Q3,W1,W1,107,W1,247,
255 235 250,Q4,W2,W2,110,W2,248,
118 206 222,Q5,W5,W5,108,W5,249,
255 111 183,Y1,N1,Y1,59,59,279,
253 181 131,Y2,N2,Y2,60,60,280,
216 252 164,Y3,N3,Y3,57,57,281,
145 218 251,Y4,N4,Y4,58,58,282,
233 135 234,Y5,N5,Y5,61,61,283,
247 212 184,Y6,-,-,-,-,284,
241 250 125,Y7,-,-,-,-,285,
94 232 140,Y8,-,-,-,-,286,
248 245 254,Y9,-,-,-,-,287,
252 253 255,T1,L14,L6,155,51,278,`;

// è§£æCSVæ•°æ®
const parseCSVData = (csv) => {
    const lines = csv.trim().split('\n');
    const data = [];
    
    for (const line of lines) {
        const parts = line.trim().split(',');
        if (parts.length >= 7) {
            const rgbStr = parts[0].trim();
            const rgb = rgbStr.split(' ').map(num => parseInt(num, 10));
            
            // è·³è¿‡æ— æ•ˆçš„RGBæ•°æ®
            if (rgb.length === 3 && !rgb.some(isNaN)) {
                data.push({
                    rgb: rgb,
                    mard: parts[1]?.trim() || '',
                    coco: parts[2]?.trim() || '',
                    manson: parts[3]?.trim() || '', // æ¼«æ¼«
                    panpan: parts[4]?.trim() || '', // ç›¼ç›¼
                    mihome: parts[5]?.trim() || '', // å’ªå°çª
                    id: parts[6]?.trim() || ''
                });
            }
        }
    }
    
    return data;
};

const allColors = parseCSVData(csvData);

// åˆ›å»ºè‰²æ¿æ•°æ®
const PALETTES = {
    // MARDç³»åˆ—
    mard_full: allColors
        .filter(color => color.mard && color.mard !== '-')
        .map(color => ({
            id: color.mard,
            rgb: color.rgb,
            brand: 'MARD'
        })),
    
    // COCOç³»åˆ—
    coco_full: allColors
        .filter(color => color.coco && color.coco !== '-')
        .map(color => ({
            id: color.coco,
            rgb: color.rgb,
            brand: 'COCO'
        })),
    
    // æ¼«æ¼«ç³»åˆ—
    manson_full: allColors
        .filter(color => color.manson && color.manson !== '-')
        .map(color => ({
            id: color.manson,
            rgb: color.rgb,
            brand: 'æ¼«æ¼«'
        })),
    
    // ç›¼ç›¼ç³»åˆ—
    panpan_full: allColors
        .filter(color => color.panpan && color.panpan !== '-')
        .map(color => ({
            id: color.panpan,
            rgb: color.rgb,
            brand: 'ç›¼ç›¼'
        })),
    
    // å’ªå°çªç³»åˆ—
    mihome_full: allColors
        .filter(color => color.mihome && color.mihome !== '-')
        .map(color => ({
            id: color.mihome,
            rgb: color.rgb,
            brand: 'å’ªå°çª'
        })),
    
    // ä¿ç•™åŸæœ‰çš„Perlerå’ŒHamaè‰²æ¿
    perler: [
        {id:"P01",rgb:[255,255,255]},{id:"P02",rgb:[236,232,199]},{id:"P03",rgb:[255,234,0]},
        {id:"P04",rgb:[255,188,0]},{id:"P05",rgb:[255,127,0]},{id:"P06",rgb:[207,0,0]},
        {id:"P07",rgb:[255,0,128]},{id:"P08",rgb:[255,102,153]},{id:"P09",rgb:[255,178,204]},
        {id:"P10",rgb:[204,0,204]},{id:"P11",rgb:[102,0,153]},{id:"P12",rgb:[0,0,178]},
        {id:"P13",rgb:[0,102,204]},{id:"P14",rgb:[0,178,255]},{id:"P15",rgb:[153,217,234]},
        {id:"P16",rgb:[0,153,76]},{id:"P17",rgb:[0,204,0]},{id:"P18",rgb:[153,255,0]},
        {id:"P19",rgb:[192,192,192]},{id:"P20",rgb:[128,128,128]},{id:"P21",rgb:[64,64,64]},
        {id:"P22",rgb:[0,0,0]},{id:"P23",rgb:[139,90,43]},{id:"P24",rgb:[180,128,80]},
        {id:"P25",rgb:[255,204,153]},{id:"P26",rgb:[255,178,127]},{id:"P27",rgb:[255,153,102]},
        {id:"P28",rgb:[204,153,102]},{id:"P29",rgb:[153,102,51]},{id:"P30",rgb:[102,51,0]}
    ],
    
    hama: [
        {id:"H01",rgb:[255,255,255]},{id:"H02",rgb:[255,255,180]},{id:"H03",rgb:[255,255,0]},
        {id:"H04",rgb:[255,200,0]},{id:"H05",rgb:[255,140,0]},{id:"H06",rgb:[255,80,0]},
        {id:"H07",rgb:[255,0,0]},{id:"H08",rgb:[200,0,0]},{id:"H09",rgb:[255,180,200]},
        {id:"H10",rgb:[255,100,150]},{id:"H11",rgb:[255,0,100]},{id:"H12",rgb:[200,0,100]},
        {id:"H13",rgb:[255,200,255]},{id:"H14",rgb:[255,100,255]},{id:"H15",rgb:[200,0,200]},
        {id:"H16",rgb:[150,0,150]},{id:"H17",rgb:[200,200,255]},{id:"H18",rgb:[100,100,255]},
        {id:"H19",rgb:[0,0,255]},{id:"H20",rgb:[0,0,150]},{id:"H21",rgb:[180,230,255]},
        {id:"H22",rgb:[0,200,255]},{id:"H23",rgb:[0,150,200]},{id:"H24",rgb:[0,100,150]},
        {id:"H25",rgb:[200,255,200]},{id:"H26",rgb:[100,255,100]},{id:"H27",rgb:[0,200,0]},
        {id:"H28",rgb:[0,150,0]},{id:"H29",rgb:[0,100,0]},{id:"H30",rgb:[128,128,128]},
        {id:"H31",rgb:[80,80,80]},{id:"H32",rgb:[0,0,0]},{id:"H33",rgb:[180,140,100]},
        {id:"H34",rgb:[150,100,50]},{id:"H35",rgb:[120,80,40]},{id:"H36",rgb:[100,60,30]}
    ]
};

// åˆ›å»º128è‰²ã€64è‰²ã€32è‰²ç‰ˆæœ¬
function createColorVariants(basePalette, size) {
    if (!basePalette || basePalette.length === 0) return [];
    
    const fullColors = [...basePalette];
    
    // æŒ‰é¢œè‰²äº®åº¦æ’åºï¼Œä»¥ç¡®ä¿é€‰æ‹©çš„é¢œè‰²åˆ†å¸ƒå‡åŒ€
    fullColors.sort((a, b) => {
        const brightnessA = a.rgb[0]*0.299 + a.rgb[1]*0.587 + a.rgb[2]*0.114;
        const brightnessB = b.rgb[0]*0.299 + b.rgb[1]*0.587 + b.rgb[2]*0.114;
        return brightnessA - brightnessB;
    });
    
    // é€‰æ‹©æŒ‡å®šæ•°é‡çš„é¢œè‰²
    const step = Math.max(1, Math.floor(fullColors.length / size));
    const selectedColors = [];
    
    for (let i = 0; i < fullColors.length && selectedColors.length < size; i += step) {
        selectedColors.push(fullColors[i]);
    }
    
    // å¦‚æœé¢œè‰²æ•°é‡ä¸è¶³ï¼Œä»å¼€å¤´å†è¡¥å……
    if (selectedColors.length < size) {
        for (let i = 0; selectedColors.length < size && i < fullColors.length; i++) {
            if (!selectedColors.some(c => c.id === fullColors[i].id)) {
                selectedColors.push(fullColors[i]);
            }
        }
    }
    
    return selectedColors.slice(0, size);
}

// ç”Ÿæˆå„ä¸ªè‰²æ¿çš„128è‰²ã€64è‰²ã€32è‰²ç‰ˆæœ¬
PALETTES.mard_128 = createColorVariants(PALETTES.mard_full, 128);
PALETTES.mard_64 = createColorVariants(PALETTES.mard_full, 64);
PALETTES.mard_32 = createColorVariants(PALETTES.mard_full, 32);

PALETTES.coco_128 = createColorVariants(PALETTES.coco_full, 128);
PALETTES.coco_64 = createColorVariants(PALETTES.coco_full, 64);
PALETTES.coco_32 = createColorVariants(PALETTES.coco_full, 32);

PALETTES.manson_128 = createColorVariants(PALETTES.manson_full, 128);
PALETTES.manson_64 = createColorVariants(PALETTES.manson_full, 64);
PALETTES.manson_32 = createColorVariants(PALETTES.manson_full, 32);

PALETTES.panpan_128 = createColorVariants(PALETTES.panpan_full, 128);
PALETTES.panpan_64 = createColorVariants(PALETTES.panpan_full, 64);
PALETTES.panpan_32 = createColorVariants(PALETTES.panpan_full, 32);

PALETTES.mihome_128 = createColorVariants(PALETTES.mihome_full, 128);
PALETTES.mihome_64 = createColorVariants(PALETTES.mihome_full, 64);
PALETTES.mihome_32 = createColorVariants(PALETTES.mihome_full, 32);

// å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
if (PALETTES.mard_full.length === 0) {
    // ä½¿ç”¨åŸæœ‰çš„MARDæ•°æ®ä½œä¸ºåå¤‡
    PALETTES.mard_full = [
        {id:"H1",rgb:[255,255,255]},{id:"H2",rgb:[250,250,250]},{id:"H3",rgb:[245,245,245]},
        {id:"H4",rgb:[235,235,235]},{id:"H5",rgb:[220,220,220]},{id:"H6",rgb:[200,200,200]},
        {id:"H7",rgb:[180,180,180]},{id:"H8",rgb:[160,160,160]},{id:"H9",rgb:[140,140,140]},
        {id:"H10",rgb:[120,120,120]},{id:"H11",rgb:[100,100,100]},{id:"H12",rgb:[80,80,80]},
        {id:"H13",rgb:[60,60,60]},{id:"H14",rgb:[40,40,40]},{id:"H15",rgb:[20,20,20]},{id:"H16",rgb:[0,0,0]},
        {id:"A1",rgb:[255,230,230]},{id:"A2",rgb:[255,200,200]},{id:"A3",rgb:[255,170,170]},
        {id:"A4",rgb:[255,140,140]},{id:"A5",rgb:[255,100,100]},{id:"A6",rgb:[255,70,70]},
        {id:"A7",rgb:[255,50,50]},{id:"A8",rgb:[240,30,30]},{id:"A9",rgb:[220,20,20]},
        {id:"A10",rgb:[200,0,0]},{id:"A11",rgb:[180,0,0]},{id:"A12",rgb:[150,0,0]},
        {id:"A13",rgb:[255,220,230]},{id:"A14",rgb:[255,190,210]},{id:"A15",rgb:[255,150,180]},
        {id:"A16",rgb:[255,120,160]},{id:"A17",rgb:[255,100,140]},{id:"A18",rgb:[255,180,200]},
        {id:"A19",rgb:[255,150,170]},{id:"A20",rgb:[240,100,130]},{id:"A21",rgb:[220,80,110]},
        {id:"B1",rgb:[255,240,220]},{id:"B2",rgb:[255,220,180]},{id:"B3",rgb:[255,200,150]},
        {id:"B4",rgb:[255,180,120]},{id:"B5",rgb:[255,160,80]},{id:"B6",rgb:[255,140,50]},
        {id:"B7",rgb:[255,120,30]},{id:"B8",rgb:[240,100,10]},{id:"B9",rgb:[220,90,0]},
        {id:"B10",rgb:[200,80,0]},{id:"B11",rgb:[180,70,0]},{id:"B12",rgb:[160,60,0]},
        {id:"C1",rgb:[255,255,220]},{id:"C2",rgb:[255,255,180]},{id:"C3",rgb:[255,255,140]},
        {id:"C4",rgb:[255,255,100]},{id:"C5",rgb:[255,255,50]},{id:"C6",rgb:[255,255,0]},
        {id:"C7",rgb:[255,240,0]},{id:"C8",rgb:[255,220,0]},{id:"C9",rgb:[240,200,0]},
        {id:"C10",rgb:[220,180,0]},{id:"C11",rgb:[200,160,0]},{id:"C12",rgb:[180,140,0]},
        {id:"D1",rgb:[220,255,220]},{id:"D2",rgb:[180,255,180]},{id:"D3",rgb:[140,255,140]},
        {id:"D4",rgb:[100,255,100]},{id:"D5",rgb:[50,255,50]},{id:"D6",rgb:[0,255,0]},
        {id:"D7",rgb:[0,230,0]},{id:"D8",rgb:[0,200,0]},{id:"D9",rgb:[0,180,0]},
        {id:"D10",rgb:[0,160,0]},{id:"D11",rgb:[0,140,0]},{id:"D12",rgb:[0,120,0]},
        {id:"D13",rgb:[0,100,0]},{id:"D14",rgb:[0,80,0]},{id:"D15",rgb:[0,60,0]},
        {id:"E1",rgb:[220,255,255]},{id:"E2",rgb:[180,255,255]},{id:"E3",rgb:[140,255,255]},
        {id:"E4",rgb:[100,255,255]},{id:"E5",rgb:[50,255,255]},{id:"E6",rgb:[0,255,255]},
        {id:"E7",rgb:[0,230,230]},{id:"E8",rgb:[0,200,200]},{id:"E9",rgb:[0,180,180]},
        {id:"F1",rgb:[220,230,255]},{id:"F2",rgb:[180,200,255]},{id:"F3",rgb:[140,170,255]},
        {id:"F4",rgb:[100,140,255]},{id:"F5",rgb:[60,110,255]},{id:"F6",rgb:[30,80,255]},
        {id:"F7",rgb:[0,60,255]},{id:"F8",rgb:[0,50,230]},{id:"F9",rgb:[0,40,200]},
        {id:"F10",rgb:[0,30,180]},{id:"F11",rgb:[0,20,150]},{id:"F12",rgb:[0,10,120]},
        {id:"G1",rgb:[240,220,255]},{id:"G2",rgb:[220,180,255]},{id:"G3",rgb:[200,140,255]},
        {id:"G4",rgb:[180,100,255]},{id:"G5",rgb:[160,60,255]},{id:"G6",rgb:[140,30,255]},
        {id:"G7",rgb:[130,0,255]},{id:"G8",rgb:[120,0,230]},{id:"G9",rgb:[100,0,200]},
        {id:"G10",rgb:[80,0,180]},{id:"G11",rgb:[60,0,150]},{id:"G12",rgb:[50,0,120]},
        {id:"M1",rgb:[240,220,200]},{id:"M2",rgb:[220,190,160]},{id:"M3",rgb:[200,160,120]},
        {id:"M4",rgb:[180,140,100]},{id:"M5",rgb:[160,120,80]},{id:"M6",rgb:[140,100,60]},
        {id:"M7",rgb:[120,80,50]},{id:"M8",rgb:[100,70,40]},{id:"M9",rgb:[90,60,35]},
        {id:"M10",rgb:[80,50,30]},{id:"M11",rgb:[70,45,25]},{id:"M12",rgb:[60,40,20]},
        {id:"N1",rgb:[255,240,230]},{id:"N2",rgb:[255,225,210]},{id:"N3",rgb:[255,210,190]},
        {id:"N4",rgb:[250,195,170]},{id:"N5",rgb:[240,180,150]},{id:"N6",rgb:[230,165,130]},
        {id:"N7",rgb:[210,150,120]},{id:"N8",rgb:[190,130,100]},{id:"N9",rgb:[170,115,85]},{id:"N10",rgb:[150,100,70]}
    ];
    
    // é‡æ–°ç”Ÿæˆå˜ä½“
    PALETTES.mard_128 = createColorVariants(PALETTES.mard_full, 128);
    PALETTES.mard_64 = createColorVariants(PALETTES.mard_full, 64);
    PALETTES.mard_32 = createColorVariants(PALETTES.mard_full, 32);
}

// å¦‚æœå…¶ä»–è‰²æ¿æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨MARDæ•°æ®ä½œä¸ºåå¤‡
['coco', 'manson', 'panpan', 'mihome'].forEach(brand => {
    if (!PALETTES[`${brand}_full`] || PALETTES[`${brand}_full`].length === 0) {
        PALETTES[`${brand}_full`] = [...PALETTES.mard_full];
        PALETTES[`${brand}_128`] = [...PALETTES.mard_128];
        PALETTES[`${brand}_64`] = [...PALETTES.mard_64];
        PALETTES[`${brand}_32`] = [...PALETTES.mard_32];
    }
});

const SCALE_FACTOR = 3;
const DOWNLOAD_SCALE_FACTOR = 5;
const CELL_SIZE = 26 * SCALE_FACTOR;
const DOWNLOAD_CELL_SIZE = 26 * DOWNLOAD_SCALE_FACTOR;

let uploadedImage = null, gridData = [], colorStats = [], canvasScale = 1, gridWidth = 0, gridHeight = 0;
let downloadCounter = 0;
let currentDownloadType = 'pattern';
let rememberedChoice = null;
let rememberChoiceChecked = false;
let selectedColor = null;
let selectedPaletteColor = null;
let originalGridData = [];
let originalColorStats = [];
let colorReplacements = {};
let similarColorGroups = []; // å­˜å‚¨æ‰¾åˆ°çš„ç›¸ä¼¼é¢œè‰²ç»„

// æ–°å¢å˜é‡
let isEditMode = false;
let currentTool = 'pen'; // pen, eraser, dropper
let currentEditColor = null;
let originalGridDataBeforeEdit = []; // ç”¨äºæ©¡çš®æ“¦æ¢å¤
let editPaletteColors = [];
let bigGridSize = 10; // å¤§æ ¼å­è¾¹æ¡†å¤§å°ï¼Œé»˜è®¤10Ã—10

// æ–°å¢æ‹–åŠ¨ç»˜åˆ¶ç›¸å…³å˜é‡
let isDrawing = false;
let lastDrawnCell = null; // è®°å½•ä¸Šæ¬¡ç»˜åˆ¶çš„å•å…ƒæ ¼ï¼Œé¿å…é‡å¤ç»˜åˆ¶

if (localStorage.getItem('rememberDownloadChoice') === 'true') {
    rememberedChoice = localStorage.getItem('downloadChoice');
    rememberChoiceChecked = true;
    document.getElementById('rememberChoice').checked = true;
}

function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast';
    
    switch(type) {
        case 'success':
            toast.style.background = '#48bb78';
            break;
        case 'error':
            toast.style.background = '#f56565';
            break;
        case 'warning':
            toast.style.background = '#ed8936';
            break;
        default:
            toast.style.background = '#4299e1';
    }
    
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function showLoading(text = 'æ­£åœ¨å¤„ç†...') {
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = text;
    loading.classList.add('show');
}

function hideLoading() {
    const loading = document.getElementById('loading');
    loading.classList.remove('show');
}

function showDownloadProgress(initialText = 'æ­£åœ¨å¤„ç†...') {
    document.getElementById('progressText').textContent = initialText;
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('downloadProgress').classList.add('show');
}

function updateDownloadProgress(text, percent) {
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressFill').style.width = percent + '%';
}

function hideDownloadProgress() {
    document.getElementById('downloadProgress').classList.remove('show');
}

function showMobileDownloadGuide() {
    document.getElementById('mobileDownloadGuide').classList.add('show');
}

function closeMobileGuide() {
    document.getElementById('mobileDownloadGuide').classList.remove('show');
}

// 1. ä¿®å¤ç”»ç¬”é¢œè‰²é€‰æ‹©é—®é¢˜
function initEditColorPalette() {
    const paletteGrid = document.getElementById('editColorPalette');
    paletteGrid.innerHTML = '';
    
    // ä½¿ç”¨å½“å‰è‰²æ¿ä¸­çš„é¢œè‰²
    const paletteName = document.getElementById('paletteSelect').value;
    const palette = PALETTES[paletteName];
    
    if (!palette || palette.length === 0) {
        showToast('è‰²æ¿ä¸­æ²¡æœ‰å¯ç”¨é¢œè‰²', 'error');
        return;
    }
    
    // ä¿®å¤é—®é¢˜ä¸€ï¼šæ˜¾ç¤ºæ›´å¤šé¢œè‰²ï¼Œå¢åŠ æ˜¾ç¤ºæ•°é‡
    const maxColors = 100; // å¢åŠ åˆ°100ä¸ªé¢œè‰²
    const displayColors = palette.slice(0, Math.min(palette.length, maxColors));
    
    displayColors.forEach(color => {
        const colorDiv = document.createElement('div');
        colorDiv.className = 'edit-color-item';
        colorDiv.style.background = `rgb(${color.rgb.join(',')})`;
        colorDiv.onclick = () => selectEditColor(color);
        
        if (currentEditColor && color.id === currentEditColor.id) {
            colorDiv.classList.add('selected');
        }
        
        paletteGrid.appendChild(colorDiv);
    });
    
    editPaletteColors = displayColors;
    
    // å¦‚æœæ²¡æœ‰å½“å‰é€‰æ‹©çš„é¢œè‰²ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªé¢œè‰²
    if (!currentEditColor && displayColors.length > 0) {
        selectEditColor(displayColors[0]);
    }
}

function selectEditColor(color) {
    currentEditColor = color;
    
    // æ›´æ–°é¢œè‰²æ˜¾ç¤º
    document.getElementById('currentColorBox').style.background = `rgb(${color.rgb.join(',')})`;
    document.getElementById('currentColorText').textContent = `${color.id} (${color.rgb.join(',')})`;
    
    // æ›´æ–°è‰²æ¿é€‰æ‹©çŠ¶æ€
    document.querySelectorAll('.edit-color-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // æ·»åŠ é€‰ä¸­çŠ¶æ€
    const selectedItem = Array.from(document.querySelectorAll('.edit-color-item')).find(item => {
        const bg = item.style.background;
        return bg === `rgb(${color.rgb.join(',')})`;
    });
    
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
    
    // ç¡®ä¿å½“å‰å·¥å…·æ˜¯ç”»ç¬”
    if (currentTool !== 'pen') {
        selectTool('pen');
    }
}

// 2. å¢å¼ºçš„ç»˜åˆ¶åŠŸèƒ½ - æ”¯æŒæ‹–åŠ¨ç»˜åˆ¶
function handleCanvasClick(event) {
    if (!isEditMode) return;
    
    const canvas = document.getElementById('mainCanvas');
    const rect = canvas.getBoundingClientRect();
    const showRuler = document.getElementById('showRuler').checked;
    const margin = showRuler ? 40 * SCALE_FACTOR : 15 * SCALE_FACTOR;
    
    // è®¡ç®—ç‚¹å‡»åœ¨ç”»å¸ƒä¸Šçš„åæ ‡ï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const canvasX = (event.clientX - rect.left) * scaleX;
    const canvasY = (event.clientY - rect.top) * scaleY;
    
    const x = Math.floor((canvasX - margin) / CELL_SIZE);
    const y = Math.floor((canvasY - margin) / CELL_SIZE);
    
    // æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (x >= 0 && x < gridWidth && y >= 0 && y < gridHeight) {
        applyToolToCell(x, y);
    }
}

// 3. æ–°å¢å‡½æ•°ï¼šå¤„ç†å•ä¸ªå•å…ƒæ ¼çš„å·¥å…·åº”ç”¨
function applyToolToCell(x, y) {
    const index = y * gridWidth + x;
    
    switch(currentTool) {
        case 'pen':
            if (currentEditColor) {
                // ä¿å­˜å½“å‰çŠ¶æ€ä»¥ä¾¿æ©¡çš®æ“¦æ¢å¤
                if (!originalGridDataBeforeEdit[index]) {
                    originalGridDataBeforeEdit[index] = {...gridData[index]};
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç»˜åˆ¶è¿‡è¿™ä¸ªå•å…ƒæ ¼
                if (lastDrawnCell && lastDrawnCell.x === x && lastDrawnCell.y === y) {
                    return; // é¿å…é‡å¤ç»˜åˆ¶åŒä¸€ä¸ªå•å…ƒæ ¼
                }
                
                // è®°å½•æœ€åç»˜åˆ¶çš„å•å…ƒæ ¼
                lastDrawnCell = { x, y };
                
                // è®¾ç½®é¢œè‰²
                gridData[index] = {
                    id: currentEditColor.id,
                    rgb: [...currentEditColor.rgb],
                    brand: currentEditColor.brand || ''
                };
                renderCanvas();
            } else {
                showToast('è¯·å…ˆé€‰æ‹©ç”»ç¬”é¢œè‰²', 'error');
            }
            break;
            
        case 'eraser':
            if (originalGridDataBeforeEdit[index]) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ“¦é™¤è¿‡è¿™ä¸ªå•å…ƒæ ¼
                if (lastDrawnCell && lastDrawnCell.x === x && lastDrawnCell.y === y) {
                    return; // é¿å…é‡å¤æ“¦é™¤åŒä¸€ä¸ªå•å…ƒæ ¼
                }
                
                // è®°å½•æœ€åæ“¦é™¤çš„å•å…ƒæ ¼
                lastDrawnCell = { x, y };
                
                gridData[index] = {...originalGridDataBeforeEdit[index]};
                renderCanvas();
            }
            break;
            
        case 'dropper':
            const color = gridData[index];
            // åœ¨è‰²æ¿ä¸­æŸ¥æ‰¾åŒ¹é…çš„é¢œè‰²
            const paletteColor = editPaletteColors.find(c => 
                c.rgb[0] === color.rgb[0] && 
                c.rgb[1] === color.rgb[1] && 
                c.rgb[2] === color.rgb[2]
            );
            
            if (paletteColor) {
                selectEditColor(paletteColor);
                showToast(`å·²å¸å–é¢œè‰²: ${color.id}`, 'success');
            } else {
                // åˆ›å»ºæ­£ç¡®çš„é¢œè‰²å¯¹è±¡
                const tempColor = {
                    id: color.id || 'å¸å–',
                    rgb: [...color.rgb],
                    brand: color.brand || ''
                };
                currentEditColor = tempColor;
                document.getElementById('currentColorBox').style.background = `rgb(${color.rgb.join(',')})`;
                document.getElementById('currentColorText').textContent = `${color.id || 'å¸å–'} (${color.rgb.join(',')})`;
                showToast(`å·²å¸å–é¢œè‰²: ${color.id || 'å¸å–'}`, 'success');
            }
            break;
    }
}

// 4. æ–°å¢å‡½æ•°ï¼šè·å–é¼ æ ‡/è§¦æ‘¸ä½ç½®çš„å•å…ƒæ ¼åæ ‡
function getCellCoordinates(event) {
    const canvas = document.getElementById('mainCanvas');
    const rect = canvas.getBoundingClientRect();
    const showRuler = document.getElementById('showRuler').checked;
    const margin = showRuler ? 40 * SCALE_FACTOR : 15 * SCALE_FACTOR;
    
    // è·å–åæ ‡ï¼ˆæ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶ï¼‰
    let clientX, clientY;
    
    if (event.type.includes('touch')) {
        if (event.touches.length > 0) {
            clientX = event.touches[0].clientX;
            clientY = event.touches[0].clientY;
        } else if (event.changedTouches.length > 0) {
            clientX = event.changedTouches[0].clientX;
            clientY = event.changedTouches[0].clientY;
        } else {
            return null;
        }
    } else {
        clientX = event.clientX;
        clientY = event.clientY;
    }
    
    // è®¡ç®—ç‚¹å‡»åœ¨ç”»å¸ƒä¸Šçš„åæ ‡ï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const canvasX = (clientX - rect.left) * scaleX;
    const canvasY = (clientY - rect.top) * scaleY;
    
    const x = Math.floor((canvasX - margin) / CELL_SIZE);
    const y = Math.floor((canvasY - margin) / CELL_SIZE);
    
    return { x, y, isValid: x >= 0 && x < gridWidth && y >= 0 && y < gridHeight };
}

// 5. æ–°å¢å‡½æ•°ï¼šå¼€å§‹ç»˜åˆ¶ï¼ˆé¼ æ ‡æŒ‰ä¸‹/è§¦æ‘¸å¼€å§‹ï¼‰
function startDrawing(event) {
    if (!isEditMode) return;
    
    event.preventDefault();
    isDrawing = true;
    lastDrawnCell = null; // é‡ç½®æœ€åç»˜åˆ¶çš„å•å…ƒæ ¼
    
    const coords = getCellCoordinates(event);
    if (coords && coords.isValid) {
        applyToolToCell(coords.x, coords.y);
    }
}

// 6. æ–°å¢å‡½æ•°ï¼šæ‹–åŠ¨ç»˜åˆ¶ï¼ˆé¼ æ ‡ç§»åŠ¨/è§¦æ‘¸ç§»åŠ¨ï¼‰
function continueDrawing(event) {
    if (!isEditMode || !isDrawing) return;
    
    event.preventDefault();
    
    const coords = getCellCoordinates(event);
    if (coords && coords.isValid) {
        applyToolToCell(coords.x, coords.y);
    }
}

// 7. æ–°å¢å‡½æ•°ï¼šåœæ­¢ç»˜åˆ¶ï¼ˆé¼ æ ‡æ¾å¼€/è§¦æ‘¸ç»“æŸï¼‰
function stopDrawing(event) {
    if (!isEditMode) return;
    
    event.preventDefault();
    isDrawing = false;
    lastDrawnCell = null; // é‡ç½®æœ€åç»˜åˆ¶çš„å•å…ƒæ ¼
}

// 8. ä¿®å¤é—®é¢˜å››ï¼šåæ ‡æ˜¾ç¤ºè·Ÿéšå¤§æ ¼å­è¾¹æ¡†å˜åŒ–
function renderCanvas() {
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const showGrid = document.getElementById('showGrid').checked;
    const showCode = document.getElementById('showCode').checked;
    const showLegend = document.getElementById('showLegend').checked;
    const showRuler = document.getElementById('showRuler').checked;
    
    const margin = showRuler ? 40 * SCALE_FACTOR : 15 * SCALE_FACTOR;
    const gridW = gridWidth * CELL_SIZE;
    const gridH = gridHeight * CELL_SIZE;
    const legendH = showLegend ? Math.ceil(colorStats.length / 5) * 28 * SCALE_FACTOR + 40 * SCALE_FACTOR : 0;
    
    canvas.width = gridW + margin * 2;
    canvas.height = gridH + margin + 15 * SCALE_FACTOR + legendH;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(margin, margin);
    for (let y = 0; y < gridHeight; y++) {
        for (let x = 0; x < gridWidth; x++) {
            const color = gridData[y * gridWidth + x];
            const px = x * CELL_SIZE;
            const py = y * CELL_SIZE;
            ctx.fillStyle = `rgb(${color.rgb[0]},${color.rgb[1]},${color.rgb[2]})`;
            ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE);
            if (showGrid) {
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 0.5 * SCALE_FACTOR;
                ctx.strokeRect(px, py, CELL_SIZE, CELL_SIZE);
            }
            if (showCode) {
                const brightness = color.rgb[0]*0.299 + color.rgb[1]*0.587 + color.rgb[2]*0.114;
                ctx.fillStyle = brightness > 128 ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.95)';
                ctx.font = `bold ${9 * SCALE_FACTOR}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(color.id, px + CELL_SIZE/2, py + CELL_SIZE/2);
            }
        }
    }
    if (showGrid) {
        // ç»˜åˆ¶å¤§æ ¼å­è¾¹æ¡†
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1.5 * SCALE_FACTOR;
        ctx.beginPath();
        // å‚ç›´å¤§æ ¼å­çº¿
        for (let i = 0; i <= gridWidth; i += bigGridSize) {
            ctx.moveTo(i * CELL_SIZE, 0);
            ctx.lineTo(i * CELL_SIZE, gridH);
        }
        // æ°´å¹³å¤§æ ¼å­çº¿
        for (let i = 0; i <= gridHeight; i += bigGridSize) {
            ctx.moveTo(0, i * CELL_SIZE);
            ctx.lineTo(gridW, i * CELL_SIZE);
        }
        ctx.stroke();
        
        // å¤–è¾¹æ¡†
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2 * SCALE_FACTOR;
        ctx.strokeRect(0, 0, gridW, gridH);
    }
    if (showRuler) {
        ctx.fillStyle = '#666';
        ctx.font = `${10 * SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'center';
        
        // ä¿®å¤é—®é¢˜å››ï¼šåæ ‡æ˜¾ç¤ºè·Ÿéšå¤§æ ¼å­è¾¹æ¡†å˜åŒ–
        for (let x = 0; x < gridWidth; x++) {
            // æ˜¾ç¤ºå¤§æ ¼å­è¾¹ç•Œå¤„çš„åæ ‡
            if ((x+1) % bigGridSize === 0) {
                ctx.fillText(x+1, x * CELL_SIZE + CELL_SIZE/2, -8 * SCALE_FACTOR);
            }
        }
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (let y = 0; y < gridHeight; y++) {
            // æ˜¾ç¤ºå¤§æ ¼å­è¾¹ç•Œå¤„çš„åæ ‡
            if ((y+1) % bigGridSize === 0) {
                ctx.fillText(y+1, -8 * SCALE_FACTOR, y * CELL_SIZE + CELL_SIZE/2);
            }
        }
    }
    if (showLegend && colorStats.length > 0) {
        ctx.translate(0, gridH + 18 * SCALE_FACTOR);
        ctx.fillStyle = '#333';
        ctx.font = `bold ${12 * SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'left';
        ctx.fillText(`è‰²å·è¡¨ (${colorStats.length}è‰², ${gridWidth}Ã—${gridHeight}=${gridWidth*gridHeight}é¢—)`, 0, 0);
        const cols = 5;
        const colW = gridW / cols;
        colorStats.forEach((c, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const bx = col * colW;
            const by = row * 28 * SCALE_FACTOR + 18 * SCALE_FACTOR;
            ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
            ctx.fillRect(bx, by - 6 * SCALE_FACTOR, 16 * SCALE_FACTOR, 16 * SCALE_FACTOR);
            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 1 * SCALE_FACTOR;
            ctx.strokeRect(bx, by - 6 * SCALE_FACTOR, 16 * SCALE_FACTOR, 16 * SCALE_FACTOR);
            ctx.fillStyle = '#333';
            ctx.font = `${10 * SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${c.id} Ã—${c.count}`, bx + 20 * SCALE_FACTOR, by);
        });
    }
    ctx.restore();
}

function renderHighResCanvas(type) {
    const highResCanvas = document.getElementById('highResCanvas');
    const ctx = highResCanvas.getContext('2d');
    const showGrid = document.getElementById('showGrid').checked;
    const showCode = document.getElementById('showCode').checked;
    const showLegend = document.getElementById('showLegend').checked;
    const showRuler = document.getElementById('showRuler').checked;
    
    if (type === 'pattern') {
        const margin = showRuler ? 40 * DOWNLOAD_SCALE_FACTOR : 15 * DOWNLOAD_SCALE_FACTOR;
        const gridW = gridWidth * DOWNLOAD_CELL_SIZE;
        const gridH = gridHeight * DOWNLOAD_CELL_SIZE;
        const legendH = showLegend ? Math.ceil(colorStats.length / 5) * 28 * DOWNLOAD_SCALE_FACTOR + 40 * DOWNLOAD_SCALE_FACTOR : 0;
        
        highResCanvas.width = gridW + margin * 2;
        highResCanvas.height = gridH + margin + 15 * DOWNLOAD_SCALE_FACTOR + legendH;
        
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, highResCanvas.width, highResCanvas.height);
        ctx.save();
        ctx.translate(margin, margin);
        
        for (let y = 0; y < gridHeight; y++) {
            for (let x = 0; x < gridWidth; x++) {
                const color = gridData[y * gridWidth + x];
                const px = x * DOWNLOAD_CELL_SIZE;
                const py = y * DOWNLOAD_CELL_SIZE;
                ctx.fillStyle = `rgb(${color.rgb[0]},${color.rgb[1]},${color.rgb[2]})`;
                ctx.fillRect(px, py, DOWNLOAD_CELL_SIZE, DOWNLOAD_CELL_SIZE);
                if (showGrid) {
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.lineWidth = 0.5 * DOWNLOAD_SCALE_FACTOR;
                    ctx.strokeRect(px, py, DOWNLOAD_CELL_SIZE, DOWNLOAD_CELL_SIZE);
                }
                if (showCode) {
                    const brightness = color.rgb[0]*0.299 + color.rgb[1]*0.587 + color.rgb[2]*0.114;
                    ctx.fillStyle = brightness > 128 ? 'rgba(0,0,0,0.85)' : 'rgba(255,255,255,0.98)';
                    ctx.font = `bold ${11 * DOWNLOAD_SCALE_FACTOR}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(color.id, px + DOWNLOAD_CELL_SIZE/2, py + DOWNLOAD_CELL_SIZE/2);
                }
            }
        }
        
        if (showGrid) {
            // ç»˜åˆ¶å¤§æ ¼å­è¾¹æ¡†
            ctx.strokeStyle = 'rgba(0,0,0,0.35)';
            ctx.lineWidth = 1.5 * DOWNLOAD_SCALE_FACTOR;
            ctx.beginPath();
            // å‚ç›´å¤§æ ¼å­çº¿
            for (let i = 0; i <= gridWidth; i += bigGridSize) {
                ctx.moveTo(i * DOWNLOAD_CELL_SIZE, 0);
                ctx.lineTo(i * DOWNLOAD_CELL_SIZE, gridH);
            }
            // æ°´å¹³å¤§æ ¼å­çº¿
            for (let i = 0; i <= gridHeight; i += bigGridSize) {
                ctx.moveTo(0, i * DOWNLOAD_CELL_SIZE);
                ctx.lineTo(gridW, i * DOWNLOAD_CELL_SIZE);
            }
            ctx.stroke();
            
            // å¤–è¾¹æ¡†
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2 * DOWNLOAD_SCALE_FACTOR;
            ctx.strokeRect(0, 0, gridW, gridH);
        }
        
        if (showRuler) {
            ctx.fillStyle = '#666';
            ctx.font = `${12 * DOWNLOAD_SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'center';
            // ä¿®å¤é—®é¢˜å››ï¼šåæ ‡æ˜¾ç¤ºè·Ÿéšå¤§æ ¼å­è¾¹æ¡†å˜åŒ–
            for (let x = 0; x < gridWidth; x++) {
                // æ˜¾ç¤ºå¤§æ ¼å­è¾¹ç•Œå¤„çš„åæ ‡
                if ((x+1) % bigGridSize === 0) {
                    ctx.fillText(x+1, x * DOWNLOAD_CELL_SIZE + DOWNLOAD_CELL_SIZE/2, -10 * DOWNLOAD_SCALE_FACTOR);
                }
            }
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let y = 0; y < gridHeight; y++) {
                // æ˜¾ç¤ºå¤§æ ¼å­è¾¹ç•Œå¤„çš„åæ ‡
                if ((y+1) % bigGridSize === 0) {
                    ctx.fillText(y+1, -10 * DOWNLOAD_SCALE_FACTOR, y * DOWNLOAD_CELL_SIZE + DOWNLOAD_CELL_SIZE/2);
                }
            }
        }
        
        if (showLegend && colorStats.length > 0) {
            ctx.translate(0, gridH + 18 * DOWNLOAD_SCALE_FACTOR);
            ctx.fillStyle = '#333';
            ctx.font = `bold ${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText(`è‰²å·è¡¨ (${colorStats.length}è‰², ${gridWidth}Ã—${gridHeight}=${gridWidth*gridHeight}é¢—)`, 0, 0);
            const cols = 5;
            const colW = gridW / cols;
            colorStats.forEach((c, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const bx = col * colW;
                const by = row * 28 * DOWNLOAD_SCALE_FACTOR + 18 * DOWNLOAD_SCALE_FACTOR;
                ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
                ctx.fillRect(bx, by - 6 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR);
                ctx.strokeStyle = '#aaa';
                ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
                ctx.strokeRect(bx, by - 6 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR, 18 * DOWNLOAD_SCALE_FACTOR);
                ctx.fillStyle = '#333';
                ctx.font = `${12 * DOWNLOAD_SCALE_FACTOR}px Arial`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${c.id} Ã—${c.count}`, bx + 22 * DOWNLOAD_SCALE_FACTOR, by);
            });
        }
        ctx.restore();
    } else {
        renderHighResStatsCanvas();
    }
}

// 2. ç¼–è¾‘æ¨¡å¼åŠŸèƒ½
function toggleEditMode() {
    isEditMode = !isEditMode;
    const editToolbar = document.getElementById('editToolbar');
    const canvas = document.getElementById('mainCanvas');
    const editModeBtn = document.getElementById('editModeBtn');
    
    if (isEditMode) {
        if (!gridData || gridData.length === 0) {
            showToast('è¯·å…ˆç”Ÿæˆå›¾çº¸ï¼', 'error');
            isEditMode = false;
            return;
        }
        
        // ä¿å­˜ç¼–è¾‘å‰çš„åŸå§‹æ•°æ®
        if (originalGridDataBeforeEdit.length === 0) {
            originalGridDataBeforeEdit = [...gridData];
        }
        
        editToolbar.classList.add('show');
        canvas.classList.add('edit-mode');
        editModeBtn.textContent = 'âœ… å®Œæˆç¼–è¾‘';
        editModeBtn.classList.remove('btn-outline');
        editModeBtn.classList.add('btn-success');
        
        // åˆå§‹åŒ–ç¼–è¾‘è‰²æ¿
        initEditColorPalette();
        
        // å¦‚æœæ²¡æœ‰é€‰æ‹©é¢œè‰²ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé¢œè‰²
        if (!currentEditColor && colorStats.length > 0) {
            selectEditColor(colorStats[0]);
        }
        
        showToast('å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œé€‰æ‹©å·¥å…·åç‚¹å‡»æˆ–æ‹–åŠ¨å›¾çº¸è¿›è¡Œç¼–è¾‘', 'info');
        
        // æ·»åŠ æ‹–åŠ¨ç»˜åˆ¶äº‹ä»¶ç›‘å¬
        setupDragDrawingEvents();
        
    } else {
        editToolbar.classList.remove('show');
        canvas.classList.remove('edit-mode');
        editModeBtn.textContent = 'âœï¸ ç¼–è¾‘æ¨¡å¼';
        editModeBtn.classList.remove('btn-success');
        editModeBtn.classList.add('btn-outline');
        
        // ç§»é™¤æ‹–åŠ¨ç»˜åˆ¶äº‹ä»¶ç›‘å¬
        removeDragDrawingEvents();
        
        // é‡æ–°è®¡ç®—ç»Ÿè®¡
        calculateStats();
        renderStatsTable();
        updateStatsTableClickEvents();
        
        showToast('å·²é€€å‡ºç¼–è¾‘æ¨¡å¼', 'info');
    }
}

// 9. æ–°å¢å‡½æ•°ï¼šè®¾ç½®æ‹–åŠ¨ç»˜åˆ¶äº‹ä»¶ç›‘å¬
function setupDragDrawingEvents() {
    const canvas = document.getElementById('mainCanvas');
    
    // é¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', continueDrawing);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing); // é¼ æ ‡ç¦»å¼€ç”»å¸ƒæ—¶åœæ­¢ç»˜åˆ¶
    
    // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', continueDrawing, { passive: false });
    canvas.addEventListener('touchend', stopDrawing, { passive: false });
    canvas.addEventListener('touchcancel', stopDrawing, { passive: false });
}

// 10. æ–°å¢å‡½æ•°ï¼šç§»é™¤æ‹–åŠ¨ç»˜åˆ¶äº‹ä»¶ç›‘å¬
function removeDragDrawingEvents() {
    const canvas = document.getElementById('mainCanvas');
    
    // é¼ æ ‡äº‹ä»¶
    canvas.removeEventListener('mousedown', startDrawing);
    canvas.removeEventListener('mousemove', continueDrawing);
    canvas.removeEventListener('mouseup', stopDrawing);
    canvas.removeEventListener('mouseleave', stopDrawing);
    
    // è§¦æ‘¸äº‹ä»¶
    canvas.removeEventListener('touchstart', startDrawing);
    canvas.removeEventListener('touchmove', continueDrawing);
    canvas.removeEventListener('touchend', stopDrawing);
    canvas.removeEventListener('touchcancel', stopDrawing);
}

function selectTool(tool) {
    currentTool = tool;
    
    // æ›´æ–°å·¥å…·æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.edit-tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    switch(tool) {
        case 'pen':
            document.getElementById('penTool').classList.add('active');
            document.getElementById('editColorPalette').classList.add('show');
            break;
        case 'eraser':
            document.getElementById('eraserTool').classList.add('active');
            document.getElementById('editColorPalette').classList.remove('show');
            break;
        case 'dropper':
            document.getElementById('dropperTool').classList.add('active');
            document.getElementById('editColorPalette').classList.remove('show');
            break;
    }
    
    showToast(`å·²é€‰æ‹© ${tool === 'pen' ? 'ç”»ç¬”' : tool === 'eraser' ? 'æ©¡çš®æ“¦' : 'å¸ç®¡'} å·¥å…·ï¼Œç‚¹å‡»æˆ–æ‹–åŠ¨è¿›è¡Œç»˜åˆ¶`, 'info');
}

// 3. å¯æ‹–åŠ¨çš„ç›¸ä¼¼é¢œè‰²æ¨¡æ€æ¡†
function makeSimilarColorsModalDraggable() {
    const modalContent = document.getElementById('similarColorsModalContent');
    const modal = document.getElementById('similarColorsModal');
    
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let modalOffsetX = 0;
    let modalOffsetY = 0;
    
    modalContent.addEventListener('mousedown', startDrag);
    modalContent.addEventListener('touchstart', startDragTouch);
    
    function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        
        const rect = modalContent.getBoundingClientRect();
        modalOffsetX = rect.left;
        modalOffsetY = rect.top;
        
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    function startDragTouch(e) {
        if (e.touches.length === 1) {
            e.preventDefault();
            isDragging = true;
            dragStartX = e.touches[0].clientX;
            dragStartY = e.touches[0].clientY;
            
            const rect = modalContent.getBoundingClientRect();
            modalOffsetX = rect.left;
            modalOffsetY = rect.top;
            
            document.addEventListener('touchmove', onDragTouch);
            document.addEventListener('touchend', stopDrag);
        }
    }
    
    function onDrag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        
        modalContent.style.left = (modalOffsetX + dx) + 'px';
        modalContent.style.top = (modalOffsetY + dy) + 'px';
    }
    
    function onDragTouch(e) {
        if (!isDragging || e.touches.length !== 1) return;
        
        e.preventDefault();
        const dx = e.touches[0].clientX - dragStartX;
        const dy = e.touches[0].clientY - dragStartY;
        
        modalContent.style.left = (modalOffsetX + dx) + 'px';
        modalContent.style.top = (modalOffsetY + dy) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDragTouch);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
    }
}

// 4. é•œåƒåŠŸèƒ½
function mirrorPattern() {
    if (!gridData || gridData.length === 0) {
        showToast('è¯·å…ˆç”Ÿæˆå›¾çº¸ï¼', 'error');
        return;
    }
    
    showLoading('æ­£åœ¨åº”ç”¨æ°´å¹³é•œåƒ...');
    
    // åˆ›å»ºé•œåƒåçš„æ•°æ®
    const mirroredData = [];
    
    for (let y = 0; y < gridHeight; y++) {
        for (let x = 0; x < gridWidth; x++) {
            const originalIndex = y * gridWidth + x;
            const mirroredX = gridWidth - 1 - x;
            const mirroredIndex = y * gridWidth + mirroredX;
            mirroredData[originalIndex] = {...gridData[mirroredIndex]};
        }
    }
    
    gridData = mirroredData;
    
    // é‡æ–°è®¡ç®—ç»Ÿè®¡
    calculateStats();
    
    // é‡æ–°æ¸²æŸ“
    renderCanvas();
    renderStatsTable();
    updateStatsTableClickEvents();
    
    hideLoading();
    showToast('æ°´å¹³é•œåƒå·²åº”ç”¨ï¼', 'success');
}

// æ˜¾ç¤ºç›¸ä¼¼é¢œè‰²æ¨¡æ€æ¡†
function showSimilarColorsModal() {
    makeSimilarColorsModalDraggable();
    document.getElementById('similarColorsModal').classList.add('show');
}

// å…³é—­ç›¸ä¼¼é¢œè‰²æ¨¡æ€æ¡†
function closeSimilarColorsModal() {
    document.getElementById('similarColorsModal').classList.remove('show');
}

// è®¡ç®—é¢œè‰²ä¹‹é—´çš„è·ç¦»ï¼ˆæ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰
function colorDistance(color1, color2) {
    const dr = color1.rgb[0] - color2.rgb[0];
    const dg = color1.rgb[1] - color2.rgb[1];
    const db = color1.rgb[2] - color2.rgb[2];
    return Math.sqrt(dr * dr + dg * dg + db * db);
}

// æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²
function findSimilarColors() {
    if (!colorStats || colorStats.length === 0) {
        showToast('è¯·å…ˆç”Ÿæˆå›¾çº¸ï¼', 'error');
        return;
    }
    
    const threshold = parseInt(document.getElementById('similaritySlider').value);
    document.getElementById('currentThreshold').textContent = threshold;
    
    showLoading(`æ­£åœ¨æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²ï¼ˆé˜ˆå€¼: ${threshold}ï¼‰...`);
    
    setTimeout(() => {
        try {
            // å¤åˆ¶é¢œè‰²ç»Ÿè®¡æ•°æ®
            const colors = colorStats.map(color => ({...color}));
            
            // æŒ‰é¢œè‰²æ•°é‡æ’åºï¼Œæ•°é‡å¤šçš„å…ˆå¤„ç†
            colors.sort((a, b) => b.count - a.count);
            
            // æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²ç»„
            similarColorGroups = [];
            const usedColors = new Set();
            
            for (let i = 0; i < colors.length; i++) {
                if (usedColors.has(colors[i].id)) continue;
                
                const group = {
                    id: `group_${similarColorGroups.length + 1}`,
                    colors: [colors[i]],
                    targetColor: colors[i], // é»˜è®¤ç›®æ ‡é¢œè‰²ä¸ºç¬¬ä¸€ä¸ªé¢œè‰²
                    selected: true // é»˜è®¤é€‰ä¸­
                };
                
                usedColors.add(colors[i].id);
                
                // æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²
                for (let j = i + 1; j < colors.length; j++) {
                    if (usedColors.has(colors[j].id)) continue;
                    
                    const distance = colorDistance(colors[i], colors[j]);
                    if (distance <= threshold) {
                        group.colors.push(colors[j]);
                        usedColors.add(colors[j].id);
                        
                        // å¦‚æœè¿™ä¸ªé¢œè‰²æ•°é‡æ›´å¤šï¼Œè®¾ä¸ºç›®æ ‡é¢œè‰²
                        if (colors[j].count > group.targetColor.count) {
                            group.targetColor = colors[j];
                        }
                    }
                }
                
                // åªæœ‰å½“ç»„å†…æœ‰å¤šä¸ªé¢œè‰²æ—¶æ‰æ·»åŠ åˆ°ç»“æœä¸­
                if (group.colors.length > 1) {
                    // æŒ‰é¢œè‰²æ•°é‡æ’åºç»„å†…é¢œè‰²
                    group.colors.sort((a, b) => b.count - a.count);
                    similarColorGroups.push(group);
                }
            }
            
            // æ¸²æŸ“ç›¸ä¼¼é¢œè‰²ç»„
            renderSimilarColorGroups();
            
            hideLoading();
            showSimilarColorsModal();
            showToast(`æ‰¾åˆ° ${similarColorGroups.length} ç»„ç›¸ä¼¼é¢œè‰²`, 'success');
            
        } catch (error) {
            hideLoading();
            showToast('æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

// æ¸²æŸ“ç›¸ä¼¼é¢œè‰²ç»„
function renderSimilarColorGroups() {
    const similarColorsList = document.getElementById('similarColorsList');
    
    if (similarColorGroups.length === 0) {
        similarColorsList.innerHTML = `
            <div style="text-align:center;padding:40px;color:#718096;">
                <div style="font-size:48px;margin-bottom:10px;">ğŸ”</div>
                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸ä¼¼çš„é¢œè‰²</p>
                <p style="font-size:12px;margin-top:5px;">å°è¯•è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼åé‡è¯•</p>
            </div>
        `;
        document.getElementById('mergeStats').style.display = 'none';
        return;
    }
    
    let html = '';
    let totalColorsToMerge = 0;
    let totalColorsReduced = 0;
    
    similarColorGroups.forEach((group, groupIndex) => {
        const totalCount = group.colors.reduce((sum, color) => sum + color.count, 0);
        totalColorsToMerge += group.colors.length - 1;
        
        html += `
            <div class="similar-group" id="group_${groupIndex}">
                <div class="similar-group-header">
                    <input type="checkbox" class="similar-group-checkbox" id="checkbox_${groupIndex}" 
                           ${group.selected ? 'checked' : ''} 
                           onchange="toggleGroupSelection(${groupIndex})">
                    <div class="similar-group-title">ç›¸ä¼¼é¢œè‰²ç»„ ${groupIndex + 1}</div>
                    <div class="similar-group-count">${group.colors.length} è‰²</div>
                </div>
                
                <div class="similar-colors">
        `;
        
        group.colors.forEach((color, colorIndex) => {
            const isTarget = color.id === group.targetColor.id;
            html += `
                <div class="similar-color-item" style="${isTarget ? 'background:#e8f5e9;border-color:#c8e6c9;' : ''}">
                    <div class="similar-color-dot" style="background:rgb(${color.rgb.join(',')})"></div>
                    <div class="similar-color-info">
                        <div class="similar-color-id">
                            ${color.id} ${isTarget ? '<span style="color:#2e7d32;font-size:9px;">(ç›®æ ‡)</span>' : ''}
                        </div>
                        <div class="similar-color-count">${color.count} é¢—</div>
                        <div class="similar-color-rgb">${color.rgb.join(',')}</div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div class="target-color">
                    <div class="target-color-label">å°†åˆå¹¶ä¸ºï¼š</div>
                    <div class="target-color-preview">
                        <div class="target-color-dot" style="background:rgb(${group.targetColor.rgb.join(',')})"></div>
                        <div class="target-color-info">
                            <div class="target-color-name">${group.targetColor.id}</div>
                            <div class="target-color-rgb">${group.targetColor.rgb.join(',')} (${totalCount} é¢—)</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    similarColorsList.innerHTML = html;
    
    // æ›´æ–°åˆå¹¶ç»Ÿè®¡
    const selectedGroups = similarColorGroups.filter(group => group.selected);
    totalColorsReduced = selectedGroups.reduce((sum, group) => sum + (group.colors.length - 1), 0);
    
    if (selectedGroups.length > 0) {
        document.getElementById('mergeStats').style.display = 'block';
        document.getElementById('mergeInfo').textContent = 
            `å°†åˆå¹¶ ${selectedGroups.length} ç»„ç›¸ä¼¼é¢œè‰²ï¼Œå‡å°‘ ${totalColorsReduced} ç§é¢œè‰²`;
    } else {
        document.getElementById('mergeStats').style.display = 'none';
    }
}

// åˆ‡æ¢ç»„é€‰æ‹©çŠ¶æ€
function toggleGroupSelection(groupIndex) {
    const checkbox = document.getElementById(`checkbox_${groupIndex}`);
    similarColorGroups[groupIndex].selected = checkbox.checked;
    
    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    renderSimilarColorGroups();
}

// åˆå¹¶ç›¸ä¼¼é¢œè‰²
function mergeSimilarColors() {
    const selectedGroups = similarColorGroups.filter(group => group.selected);
    
    if (selectedGroups.length === 0) {
        showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç»„ç›¸ä¼¼é¢œè‰²è¿›è¡Œåˆå¹¶', 'warning');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦åˆå¹¶ ${selectedGroups.length} ç»„ç›¸ä¼¼é¢œè‰²å—ï¼Ÿæ­¤æ“ä½œå°†å‡å°‘ ${selectedGroups.reduce((sum, group) => sum + (group.colors.length - 1), 0)} ç§é¢œè‰²ã€‚`)) {
        return;
    }
    
    showLoading('æ­£åœ¨åˆå¹¶ç›¸ä¼¼é¢œè‰²...');
    
    setTimeout(() => {
        try {
            // ä¿å­˜åŸå§‹æ•°æ®ä»¥ä¾¿æ’¤é”€
            if (originalGridData.length === 0) {
                originalGridData = [...gridData];
                originalColorStats = [...colorStats];
            }
            
            // åˆ›å»ºé¢œè‰²æ˜ å°„ï¼šç›¸ä¼¼é¢œè‰² -> ç›®æ ‡é¢œè‰²
            const colorMap = {};
            selectedGroups.forEach(group => {
                group.colors.forEach(color => {
                    if (color.id !== group.targetColor.id) {
                        colorMap[color.id] = group.targetColor;
                    }
                });
            });
            
            // åº”ç”¨é¢œè‰²æ˜ å°„åˆ°å›¾çº¸æ•°æ®
            let mergeCount = 0;
            for (let i = 0; i < gridData.length; i++) {
                const colorId = gridData[i].id;
                if (colorMap[colorId]) {
                    gridData[i] = {...colorMap[colorId]};
                    mergeCount++;
                }
            }
            
            // é‡æ–°è®¡ç®—ç»Ÿè®¡
            calculateStats();
            
            // æ›´æ–°æ˜¾ç¤º
            renderCanvas();
            renderStatsTable();
            updateStatsTableClickEvents();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeSimilarColorsModal();
            
            // é‡ç½®ç›¸ä¼¼é¢œè‰²ç»„
            similarColorGroups = [];
            
            hideLoading();
            showToast(`æˆåŠŸåˆå¹¶ ${mergeCount} ä¸ªé¢œè‰²ç‚¹ï¼Œé¢œè‰²æ•°é‡ä» ${originalColorStats.length} å‡å°‘åˆ° ${colorStats.length}`, 'success');
            
            // ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º
            optimizeMobileStatsDisplay();
            
        } catch (error) {
            hideLoading();
            showToast('åˆå¹¶é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('åˆå¹¶ç›¸ä¼¼é¢œè‰²æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function showIOSDownloadGuide() {
    const guide = document.getElementById('mobileDownloadGuide');
    guide.querySelector('h4').textContent = 'ğŸ“± iOSä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—';
    guide.querySelector('ol').innerHTML = `
        <li>ä¸‹è½½å®Œæˆåï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„"ä¸‹è½½"å›¾æ ‡</li>
        <li>åœ¨"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å›¾ç‰‡</li>
        <li>ç‚¹å‡»å³ä¸Šè§’çš„"åˆ†äº«"æŒ‰é’®</li>
        <li>æ»‘åŠ¨æ‰¾åˆ°"å­˜å‚¨åˆ°'ç…§ç‰‡'"å¹¶ç‚¹å‡»</li>
        <li>å›¾ç‰‡å°†ä¿å­˜åˆ°æ‚¨çš„ç›¸å†Œ</li>
    `;
    guide.querySelector('.tip').innerHTML = `
        ğŸ’¡ å¦‚æœæ‰¾ä¸åˆ°ä¸‹è½½æŒ‰é’®ï¼š
        <br>1. ç‚¹å‡»Safariåº•éƒ¨å·¥å…·æ ä¸­é—´çš„"åˆ†äº«"æŒ‰é’®
        <br>2. å‘å³æ»‘åŠ¨æ‰¾åˆ°"ä¸‹è½½"
        <br>3. æˆ–è€…åœ¨"æ–‡ä»¶"Appçš„"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾
    `;
    guide.classList.add('show');
}

function showAndroidDownloadGuide() {
    const guide = document.getElementById('mobileDownloadGuide');
    guide.querySelector('h4').textContent = 'ğŸ“± Androidä¿å­˜åˆ°ç›¸å†ŒæŒ‡å—';
    guide.querySelector('ol').innerHTML = `
        <li>ç­‰å¾…ä¸‹è½½å®Œæˆåï¼Œç‚¹å‡»"å®Œæˆ"æˆ–"æ‰“å¼€"</li>
        <li>åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°"ä¸‹è½½"æ–‡ä»¶å¤¹</li>
        <li>é•¿æŒ‰å›¾ç‰‡æ–‡ä»¶ï¼Œé€‰æ‹©"ç§»åŠ¨"æˆ–"å¤åˆ¶"</li>
        <li>ç²˜è´´åˆ°"DCIM/Camera"æ–‡ä»¶å¤¹</li>
        <li>æ‰“å¼€ç›¸å†Œå³å¯æŸ¥çœ‹</li>
    `;
    guide.querySelector('.tip').innerHTML = `
        ğŸ’¡ å¿«é€Ÿä¿å­˜æ–¹æ³•ï¼š
        <br>1. ä¸‹è½½å®Œæˆåç›´æ¥ç‚¹å‡»å›¾ç‰‡é¢„è§ˆ
        <br>2. ç‚¹å‡»å³ä¸Šè§’çš„èœå•æŒ‰é’®
        <br>3. é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½"
        <br>4. éƒ¨åˆ†æµè§ˆå™¨ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ç›¸å†Œ
    `;
    guide.classList.add('show');
}

function startMobileDownload() {
    closeMobileGuide();
    if (isIOS()) {
        saveToIOSAlbum();
    } else if (isAndroid()) {
        saveToAndroidAlbum();
    } else {
        saveToAlbumUniversal();
    }
}

function saveToPhotoAlbum() {
    if (isIOS()) {
        saveToIOSAlbum();
        return;
    }
    
    if (isAndroid()) {
        saveToAndroidAlbum();
        return;
    }
    
    saveToAlbumUniversal();
}

function saveToIOSAlbum() {
    showDownloadProgress('æ­£åœ¨ä¸ºiOSè®¾å¤‡ç”Ÿæˆå›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}.png`;
            
            if (typeof window.showOpenFilePicker !== 'undefined') {
                saveWithFileSystemAccess(highResCanvas, filename);
                return;
            }
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 30);
            
            highResCanvas.toBlob(blob => {
                if (!blob) {
                    hideDownloadProgress();
                    showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                    return;
                }
                
                updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½é“¾æ¥...', 60);
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                const cleanup = () => {
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        if (link.parentNode) {
                            link.parentNode.removeChild(link);
                        }
                        hideDownloadProgress();
                    }, 1000);
                };
                
                link.onclick = cleanup;
                
                document.body.appendChild(link);
                
                updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 80);
                
                try {
                    link.click();
                    updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 90);
                    
                    setTimeout(() => {
                        hideDownloadProgress();
                        showIOSDownloadGuide();
                    }, 1500);
                    
                } catch (e) {
                    cleanup();
                    updateDownloadProgress('è‡ªåŠ¨ä¸‹è½½å¤±è´¥', 100);
                    setTimeout(() => {
                        hideDownloadProgress();
                        showMobileDownloadGuide();
                    }, 500);
                }
                
            }, 'image/png', 1.0);
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°iOSç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function saveToAndroidAlbum() {
    showDownloadProgress('æ­£åœ¨ä¸ºAndroidè®¾å¤‡ç”Ÿæˆå›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}.png`;
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 30);
            
            if (navigator.share && navigator.canShare) {
                highResCanvas.toBlob(blob => {
                    if (!blob) {
                        hideDownloadProgress();
                        showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                        return;
                    }
                    
                    updateDownloadProgress('æ­£åœ¨å‡†å¤‡åˆ†äº«...', 60);
                    
                    const file = new File([blob], filename, { type: 'image/png' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'ä¿å­˜æ‹¼è±†å›¾çº¸',
                            text: 'è¯·é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"'
                        })
                        .then(() => {
                            hideDownloadProgress();
                            showToast('è¯·é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"é€‰é¡¹', 'success');
                        })
                        .catch(err => {
                            if (err.name !== 'AbortError') {
                                downloadForAndroid(blob, filename);
                            } else {
                                hideDownloadProgress();
                            }
                        });
                    } else {
                        downloadForAndroid(blob, filename);
                    }
                }, 'image/png', 1.0);
            } else {
                highResCanvas.toBlob(blob => {
                    downloadForAndroid(blob, filename);
                }, 'image/png', 1.0);
            }
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°Androidç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function downloadForAndroid(blob, filename) {
    updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½...', 70);
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    
    const cleanup = () => {
        setTimeout(() => {
            URL.revokeObjectURL(url);
            if (link.parentNode) {
                link.parentNode.removeChild(link);
            }
            hideDownloadProgress();
        }, 1000);
    };
    
    link.onclick = cleanup;
    
    document.body.appendChild(link);
    
    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 85);
    
    try {
        const event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: false
        });
        link.dispatchEvent(event);
        
        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 95);
        
        setTimeout(() => {
            hideDownloadProgress();
            showAndroidDownloadGuide();
        }, 1500);
        
    } catch (e) {
        cleanup();
        updateDownloadProgress('ä¸‹è½½å¤±è´¥', 100);
        setTimeout(() => {
            hideDownloadProgress();
            showMobileDownloadGuide();
        }, 500);
    }
}

function saveToAlbumUniversal() {
    showDownloadProgress('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('album');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            const highResCanvas = document.getElementById('highResCanvas');
            
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}_é«˜æ¸….png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}_é«˜æ¸….png`;
            
            updateDownloadProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡æ•°æ®...', 40);
            
            highResCanvas.toBlob(blob => {
                if (!blob) {
                    hideDownloadProgress();
                    showToast('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                    return;
                }
                
                updateDownloadProgress('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 70);
                
                if ('showSaveFilePicker' in window) {
                    try {
                        window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'PNGå›¾ç‰‡',
                                accept: {'image/png': ['.png']},
                            }],
                        }).then(handle => {
                            return handle.createWritable();
                        }).then(writable => {
                            return writable.write(blob).then(() => writable.close());
                        }).then(() => {
                            hideDownloadProgress();
                            showToast('å›¾ç‰‡å·²ä¿å­˜åˆ°è®¾å¤‡', 'success');
                        }).catch(fsError => {
                            console.log('File System APIå¤±è´¥:', fsError);
                            downloadViaAnchor(blob, filename);
                        });
                        return;
                    } catch (fsError) {
                        console.log('File System APIå¤±è´¥:', fsError);
                    }
                }
                
                downloadViaAnchor(blob, filename);
                
            }, 'image/png', 1.0);
            
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¿å­˜åˆ°ç›¸å†Œæ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function downloadViaAnchor(blob, filename) {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    
    link.addEventListener('click', function(e) {
        e.stopPropagation();
    }, false);
    
    const cleanup = () => {
        setTimeout(() => {
            URL.revokeObjectURL(url);
            if (link.parentNode) {
                link.parentNode.removeChild(link);
            }
            hideDownloadProgress();
        }, 2000);
    };
    
    document.body.appendChild(link);
    
    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 85);
    
    let downloadTriggered = false;
    
    try {
        link.click();
        downloadTriggered = true;
    } catch (e1) {
        console.log('ç›´æ¥clickå¤±è´¥:', e1);
    }
    
    if (!downloadTriggered) {
        try {
            const event = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: false
            });
            link.dispatchEvent(event);
            downloadTriggered = true;
        } catch (e2) {
            console.log('MouseEventå¤±è´¥:', e2);
        }
    }
    
    if (!downloadTriggered) {
        try {
            const event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            link.dispatchEvent(event);
            downloadTriggered = true;
        } catch (e3) {
            console.log('createEventå¤±è´¥:', e3);
        }
    }
    
    if (downloadTriggered) {
        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 95);
        
        setTimeout(() => {
            hideDownloadProgress();
            if (isMobile()) {
                showMobileDownloadGuide();
            } else {
                showToast('ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸‹è½½ç®¡ç†ä¸­æŸ¥çœ‹', 'success');
            }
        }, 1500);
        
        setTimeout(cleanup, 10000);
    } else {
        cleanup();
        updateDownloadProgress('ä¸‹è½½å¤±è´¥', 100);
        setTimeout(() => {
            hideDownloadProgress();
            showMobileDownloadGuide();
        }, 500);
    }
}

async function saveWithFileSystemAccess(canvas, filename) {
    try {
        updateDownloadProgress('æ­£åœ¨è¯·æ±‚æ–‡ä»¶è®¿é—®æƒé™...', 40);
        
        const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png', 1.0);
        });
        
        const opts = {
            suggestedName: filename,
            types: [{
                description: 'PNGå›¾ç‰‡',
                accept: {'image/png': ['.png']},
            }],
        };
        
        const handle = await window.showSaveFilePicker(opts);
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        hideDownloadProgress();
        showToast('å›¾ç‰‡å·²ä¿å­˜åˆ°è®¾å¤‡', 'success');
        
    } catch (error) {
        console.log('File System Accesså¤±è´¥:', error);
        canvas.toBlob(blob => {
            downloadViaAnchor(blob, filename);
        }, 'image/png', 1.0);
    }
}

// ä¿®å¤ï¼šæ­£ç¡®é€‰æ‹©è¦æ›¿æ¢çš„é¢œè‰²
function selectColorToReplace(color) {
    if (!color) {
        showToast('æœªæ‰¾åˆ°å¯¹åº”é¢œè‰²æ•°æ®', 'error');
        return;
    }
    
    console.log('é€‰æ‹©æ›¿æ¢é¢œè‰²:', color.id, 'ç´¢å¼•:', colorStats.findIndex(c => c.id === color.id));
    
    selectedColor = color;
    
    // æ¸…ç©ºä¹‹å‰çš„æ›¿æ¢é€‰æ‹©
    selectedPaletteColor = null;
    document.querySelectorAll('.palette-color').forEach(el => {
        el.classList.remove('selected');
    });
    
    // æ›´æ–°é€‰æ‹©ä¿¡æ¯
    document.getElementById('selectedColorInfo').innerHTML = `
        <p><strong>è¦æ›¿æ¢çš„é¢œè‰²ï¼š</strong> ${color.id}</p>
        <p><strong>å½“å‰é¢œè‰²ï¼š</strong> <span class="color-dot" style="background:rgb(${color.rgb.join(',')})"></span> RGB(${color.rgb.join(',')})</p>
        <p><strong>ä½¿ç”¨æ•°é‡ï¼š</strong> ${color.count} é¢—</p>
        <p>è¯·åœ¨ä¸‹æ–¹é€‰æ‹©æ–°çš„é¢œè‰²ï¼š</p>
    `;
    
    // æ˜¾ç¤ºæ›¿æ¢é€‰é¡¹
    document.getElementById('replaceOptions').style.display = 'block';
    
    // åŠ è½½è‰²æ¿
    loadPaletteForReplacement();
    
    // æ»šåŠ¨åˆ°æ›¿æ¢åŒºåŸŸ
    document.getElementById('colorReplaceSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
    
    // æ˜¾ç¤ºæç¤º
    showToast(`å·²é€‰æ‹©è‰²å· ${color.id}ï¼Œè¯·é€‰æ‹©æ›¿æ¢é¢œè‰²`, 'info');
}

// ä¿®å¤ï¼šæ›´æ–°è‰²ç‚¹ç‚¹å‡»äº‹ä»¶ç»‘å®š
function updateStatsTableClickEvents() {
    const colorDots = document.querySelectorAll('.color-dot');
    
    // ç¡®ä¿æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„æ•°æ®
    if (colorStats.length === 0) {
        console.warn('æ²¡æœ‰é¢œè‰²ç»Ÿè®¡æ•°æ®');
        return;
    }
    
    console.log(`å¼€å§‹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå…±æœ‰ ${colorDots.length} ä¸ªè‰²ç‚¹ï¼Œ${colorStats.length} ç§é¢œè‰²`);
    
    colorDots.forEach((dot, index) => {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
        const newDot = dot.cloneNode(true);
        dot.parentNode.replaceChild(newDot, dot);
    });
    
    // è·å–æ›´æ–°åçš„è‰²ç‚¹å…ƒç´ 
    const updatedColorDots = document.querySelectorAll('.color-dot');
    
    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    updatedColorDots.forEach((dot, index) => {
        if (index < colorStats.length) {
            const color = colorStats[index];
            
            // è®¾ç½®æ­£ç¡®çš„æç¤º
            dot.title = `ç‚¹å‡»æ›¿æ¢è‰²å· ${color.id}`;
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            dot.onclick = (e) => {
                e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                console.log(`ç‚¹å‡»äº†è‰²ç‚¹ ${index}ï¼Œå¯¹åº”é¢œè‰² ${color.id}`);
                selectColorToReplace(color);
            };
            
            // æ·»åŠ æŒ‡é’ˆæ ·å¼
            dot.style.cursor = 'pointer';
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            dot.onmouseenter = function() {
                this.style.transform = 'scale(1.2)';
                this.style.boxShadow = '0 0 5px rgba(0,0,0,0.3)';
            };
            
            dot.onmouseleave = function() {
                this.style.transform = '';
                this.style.boxShadow = '';
            };
        } else {
            console.warn(`ç´¢å¼• ${index} è¶…å‡ºé¢œè‰²ç»Ÿè®¡èŒƒå›´`);
        }
    });
    
    console.log(`å·²ä¸º ${Math.min(updatedColorDots.length, colorStats.length)} ä¸ªè‰²ç‚¹ç»‘å®šç‚¹å‡»äº‹ä»¶`);
}

function loadPaletteForReplacement() {
    const paletteGrid = document.getElementById('paletteGrid');
    const paletteName = document.getElementById('paletteSelect').value;
    
    // è·å–å½“å‰é€‰ä¸­çš„è‰²æ¿
    const palette = PALETTES[paletteName];
    
    if (!palette || palette.length === 0) {
        paletteGrid.innerHTML = '<div style="text-align:center;padding:20px;color:#718096;">å½“å‰è‰²æ¿æ²¡æœ‰å¯ç”¨é¢œè‰²</div>';
        return;
    }
    
    paletteGrid.innerHTML = '';
    
    palette.forEach(color => {
        const colorDiv = document.createElement('div');
        colorDiv.className = 'palette-color';
        colorDiv.onclick = () => selectPaletteColor(color, colorDiv);
        
        // æ£€æŸ¥è¿™ä¸ªé¢œè‰²æ˜¯å¦å·²ç»åœ¨å›¾çº¸ä¸­ä½¿ç”¨
        const isUsedInDrawing = colorStats.some(c => c.id === color.id);
        
        colorDiv.innerHTML = `
            <div class="palette-dot" style="background:rgb(${color.rgb.join(',')}); ${isUsedInDrawing ? 'border-color:#48bb78;' : ''}"></div>
            <div class="palette-id">${color.id}</div>
            <div class="palette-rgb">${color.rgb.join(',')}</div>
            ${isUsedInDrawing ? '<div style="font-size:9px;color:#48bb78;">å·²ä½¿ç”¨</div>' : ''}
        `;
        
        paletteGrid.appendChild(colorDiv);
    });
    
    selectedPaletteColor = null;
}

function selectPaletteColor(color, element) {
    document.querySelectorAll('.palette-color').forEach(el => {
        el.classList.remove('selected');
    });
    
    element.classList.add('selected');
    selectedPaletteColor = color;
    
    showToast(`å·²é€‰æ‹©è‰²å· ${color.id} ä½œä¸ºæ›¿æ¢é¢œè‰²`, 'info');
}

function searchPalette() {
    const searchText = document.getElementById('paletteSearch').value.toLowerCase();
    const paletteColors = document.querySelectorAll('.palette-color');
    
    paletteColors.forEach(div => {
        const colorId = div.querySelector('.palette-id').textContent.toLowerCase();
        const colorRgb = div.querySelector('.palette-rgb').textContent.toLowerCase();
        
        if (colorId.includes(searchText) || colorRgb.includes(searchText) || searchText === '') {
            div.style.display = 'flex';
        } else {
            div.style.display = 'none';
        }
    });
}

function replaceColor() {
    if (!selectedColor || !selectedPaletteColor) {
        showToast('è¯·å…ˆé€‰æ‹©è¦æ›¿æ¢çš„é¢œè‰²å’Œæ›¿æ¢ç›®æ ‡é¢œè‰²', 'error');
        return;
    }
    
    if (selectedColor.id === selectedPaletteColor.id) {
        showToast('é¢œè‰²ç›¸åŒï¼Œæ— éœ€æ›¿æ¢', 'warning');
        return;
    }
    
    showLoading(`æ­£åœ¨æ›¿æ¢ ${selectedColor.id} â†’ ${selectedPaletteColor.id}...`);
    
    setTimeout(() => {
        try {
            colorReplacements[selectedColor.id] = selectedPaletteColor;
            
            if (originalGridData.length === 0) {
                originalGridData = [...gridData];
                originalColorStats = [...colorStats];
            }
            
            let replaceCount = 0;
            for (let i = 0; i < gridData.length; i++) {
                if (gridData[i].id === selectedColor.id) {
                    gridData[i] = {...selectedPaletteColor};
                    replaceCount++;
                }
            }
            
            calculateStats();
            
            renderCanvas();
            renderStatsTable();
            
            updateStatsTableClickEvents();
            
            document.getElementById('replaceOptions').style.display = 'none';
            
            document.getElementById('selectedColorInfo').innerHTML = `
                <p><strong>æ›¿æ¢å®Œæˆï¼š</strong> ${selectedColor.id} â†’ ${selectedPaletteColor.id}</p>
                <p><strong>æ›¿æ¢æ•°é‡ï¼š</strong> ${replaceCount} é¢—</p>
                <p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„å…¶ä»–è‰²å·ç»§ç»­æ›¿æ¢</p>
            `;
            
            selectedColor = null;
            selectedPaletteColor = null;
            
            hideLoading();
            showToast(`æˆåŠŸæ›¿æ¢ ${replaceCount} ä¸ª ${selectedColor.id} ä¸º ${selectedPaletteColor.id}`, 'success');
            
        } catch (error) {
            hideLoading();
            showToast('é¢œè‰²æ›¿æ¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('é¢œè‰²æ›¿æ¢æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

function cancelReplace() {
    selectedColor = null;
    selectedPaletteColor = null;
    document.getElementById('replaceOptions').style.display = 'none';
    document.getElementById('selectedColorInfo').innerHTML = '<p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>';
    showToast('å·²å–æ¶ˆé¢œè‰²æ›¿æ¢', 'info');
}

function resetAllColors() {
    if (originalGridData.length === 0) {
        showToast('æ²¡æœ‰å¯é‡ç½®çš„é¢œè‰²', 'info');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é¢œè‰²åˆ°åŸå§‹çŠ¶æ€å—ï¼Ÿæ‰€æœ‰æ›¿æ¢æ“ä½œå°†è¢«æ’¤é”€ã€‚')) {
        return;
    }
    
    showLoading('æ­£åœ¨é‡ç½®æ‰€æœ‰é¢œè‰²...');
    
    setTimeout(() => {
        try {
            gridData = [...originalGridData];
            
            calculateStats();
            
            renderCanvas();
            renderStatsTable();
            
            updateStatsTableClickEvents();
            
            colorReplacements = {};
            originalGridData = [];
            originalColorStats = [];
            
            document.getElementById('replaceOptions').style.display = 'none';
            document.getElementById('selectedColorInfo').innerHTML = '<p>ç‚¹å‡»ä¸‹æ–¹è¡¨æ ¼ä¸­çš„è‰²å·è¿›è¡Œæ›¿æ¢</p>';
            
            selectedColor = null;
            selectedPaletteColor = null;
            
            hideLoading();
            showToast('æ‰€æœ‰é¢œè‰²å·²é‡ç½®åˆ°åŸå§‹çŠ¶æ€', 'success');
            
        } catch (error) {
            hideLoading();
            showToast('é‡ç½®é¢œè‰²å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('é‡ç½®é¢œè‰²æ—¶å‡ºé”™:', error);
        }
    }, 300);
}

// ä¿®å¤ï¼šç”Ÿæˆç»Ÿè®¡è¡¨æ ¼æ—¶æ·»åŠ æ­£ç¡®çš„æ•°æ®å±æ€§
function renderStatsTable() {
    const total = gridWidth * gridHeight;
    document.getElementById('statsSummary').innerHTML = `
        <p>ğŸ“ å°ºå¯¸ï¼š<strong>${gridWidth} Ã— ${gridHeight}</strong></p>
        <p>ğŸ”¢ æ€»ç æ•°ï¼š<strong>${total.toLocaleString()}</strong> é¢—</p>
        <p>ğŸ¨ é¢œè‰²æ•°ï¼š<strong>${colorStats.length}</strong> ç§</p>
    `;
    
    const tbody = document.getElementById('statsBody');
    let html = '';
    
    colorStats.forEach((c, index) => {
        const percent = (c.count / total * 100).toFixed(1);
        const replacementInfo = colorReplacements[c.id] ? 
            ` <small style="color:#ed8936;">(åŸ: ${Object.keys(colorReplacements).find(key => colorReplacements[key].id === c.id)})</small>` : '';
        
        // ä¸ºæ¯ä¸ªè‰²ç‚¹æ·»åŠ å”¯ä¸€çš„æ•°æ®å±æ€§
        html += `
            <tr>
                <td><strong>${c.id}${replacementInfo}</strong></td>
                <td>
                    <span class="color-dot" 
                          style="background:rgb(${c.rgb.join(',')})" 
                          data-color-id="${c.id}"
                          data-index="${index}">
                    </span>
                </td>
                <td>${c.count}</td>
                <td>${percent}%</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // ç¡®ä¿æ­£ç¡®ç»‘å®šäº‹ä»¶
    setTimeout(() => {
        updateStatsTableClickEvents();
    }, 10);
}

function saveToBrowser() {
    showDownloadProgress('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...');
    hideDownloadOptions();
    updateRememberChoice('browser');
    
    setTimeout(() => {
        try {
            renderHighResCanvas(currentDownloadType);
            
            const highResCanvas = document.getElementById('highResCanvas');
            const dataUrl = highResCanvas.toDataURL('image/png', 1.0);
            
            const timestamp = new Date().getTime();
            const random = Math.random().toString(36).substring(2, 8);
            const filename = currentDownloadType === 'pattern' ? 
                `æ‹¼è±†å›¾çº¸_${gridWidth}x${gridHeight}_${timestamp}.png` : 
                `æ‹¼è±†ç»Ÿè®¡_${gridWidth}x${gridHeight}_${timestamp}.png`;
            
            updateDownloadProgress('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 60);
            
            fetch(dataUrl)
                .then(res => res.blob())
                .then(blob => {
                    updateDownloadProgress('æ­£åœ¨åˆ›å»ºä¸‹è½½é“¾æ¥...', 80);
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    link.addEventListener('click', function() {
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            if (link.parentNode) {
                                link.parentNode.removeChild(link);
                            }
                        }, 1000);
                    });
                    
                    document.body.appendChild(link);
                    
                    updateDownloadProgress('æ­£åœ¨è§¦å‘ä¸‹è½½...', 90);
                    
                    let success = false;
                    
                    try {
                        link.click();
                        success = true;
                    } catch (e) {
                        console.log('æ–¹å¼1å¤±è´¥:', e);
                    }
                    
                    if (!success) {
                        try {
                            const event = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: false
                            });
                            link.dispatchEvent(event);
                            success = true;
                        } catch (e) {
                            console.log('æ–¹å¼2å¤±è´¥:', e);
                        }
                    }
                    
                    if (success) {
                        updateDownloadProgress('ä¸‹è½½å·²å¼€å§‹', 100);
                        setTimeout(() => {
                            hideDownloadProgress();
                            showToast('ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
                            
                            if (isMobile()) {
                                setTimeout(() => {
                                    if (isAndroid()) {
                                        showToast('è¯·æŸ¥çœ‹"æ–‡ä»¶ç®¡ç†"ä¸­çš„"ä¸‹è½½"æ–‡ä»¶å¤¹', 'info');
                                    } else if (isIOS()) {
                                        showToast('è¯·åœ¨"æ–‡ä»¶"Appçš„"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹', 'info');
                                    }
                                }, 2000);
                            }
                        }, 1000);
                    } else {
                        hideDownloadProgress();
                        showToast('è‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•æ‰‹åŠ¨ä¿å­˜', 'error');
                    }
                })
                .catch(err => {
                    hideDownloadProgress();
                    console.error('ä¸‹è½½å¤±è´¥:', err);
                    showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–é€‰æ‹©å…¶ä»–æ–¹å¼', 'error');
                });
                
        } catch (error) {
            hideDownloadProgress();
            showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ä¸‹è½½æ—¶å‡ºé”™:', error);
        }
    }, 500);
}

function manualSave() {
    hideDownloadOptions();
    updateRememberChoice('manual');
    
    renderHighResCanvas(currentDownloadType);
    const highResCanvas = document.getElementById('highResCanvas');
    const previewImg = currentDownloadType === 'pattern' ? 
        document.getElementById('downloadImage') : 
        document.getElementById('downloadStatsImage');
    
    const dataUrl = highResCanvas.toDataURL('image/png', 1.0);
    previewImg.src = dataUrl;
    
    previewImg.onload = function() {
        let hintText = '';
        
        if (isIOS()) {
            hintText = 'ğŸ“± iOSä¿å­˜ï¼šé•¿æŒ‰å›¾ç‰‡ â†’ "æ·»åŠ åˆ°ç…§ç‰‡"';
        } else if (isAndroid()) {
            hintText = 'ğŸ“± Androidä¿å­˜ï¼šé•¿æŒ‰å›¾ç‰‡ â†’ "ä¿å­˜å›¾ç‰‡"';
        } else {
            hintText = 'ğŸ’» ç”µè„‘ä¿å­˜ï¼šå³é”®å›¾ç‰‡ â†’ "å›¾ç‰‡å¦å­˜ä¸º"';
        }
        
        document.getElementById('downloadHint').textContent = hintText;
        document.getElementById('downloadStatsHint').textContent = hintText;
        
        showDetailedSaveGuide();
    };
    
    if (previewImg.complete) {
        showDetailedSaveGuide();
    }
}

function showDetailedSaveGuide() {
    let guideText = '';
    let title = '';
    
    if (isIOS()) {
        title = 'ğŸ“± iPhone/iPadä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. é•¿æŒ‰ä¸Šæ–¹é«˜æ¸…å›¾ç‰‡\n' +
                   '2. åœ¨å¼¹å‡ºçš„èœå•ä¸­é€‰æ‹©"æ·»åŠ åˆ°ç…§ç‰‡"\n' +
                   '3. å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„ç›¸å†Œ\n\n' +
                   'å¤‡ç”¨æ–¹æ³•ï¼š\n' +
                   '1. ç‚¹å‡»å›¾ç‰‡å³ä¸Šè§’çš„"åˆ†äº«"æŒ‰é’®\n' +
                   '2. å‘å·¦æ»‘åŠ¨æ‰¾åˆ°"å­˜å‚¨å›¾åƒ"\n' +
                   '3. ç‚¹å‡»å³å¯ä¿å­˜\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå¦‚æ— æ³•ä¿å­˜ï¼Œè¯·ç¡®ä¿Safariè®¾ç½®ä¸­å…è®¸ä¸‹è½½ã€‚';
    } else if (isAndroid()) {
        title = 'ğŸ“± Androidæ‰‹æœºä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. é•¿æŒ‰ä¸Šæ–¹é«˜æ¸…å›¾ç‰‡\n' +
                   '2. é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½å›¾ç‰‡"\n' +
                   '3. ä¿å­˜åè¯·åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰¾åˆ°è¯¥å›¾ç‰‡\n' +
                   '4. å°†å›¾ç‰‡ç§»åŠ¨åˆ°DCIM/Cameraæ–‡ä»¶å¤¹å³å¯åœ¨ç›¸å†Œä¸­æŸ¥çœ‹\n\n' +
                   'å¿«é€Ÿæ–¹æ³•ï¼š\n' +
                   '1. ç‚¹å‡»å›¾ç‰‡å³ä¸‹è§’çš„èœå•æŒ‰é’®\n' +
                   '2. é€‰æ‹©"ä¸‹è½½å›¾ç‰‡"\n' +
                   '3. éƒ¨åˆ†æ‰‹æœºä¼šè‡ªåŠ¨ä¿å­˜åˆ°ç›¸å†Œ\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå¦‚æ— æ³•ä¿å­˜ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½æƒé™ã€‚';
    } else {
        title = 'ğŸ’» ç”µè„‘ä¿å­˜æŒ‡å—';
        guideText = 'è¯¦ç»†æ­¥éª¤ï¼š\n\n' +
                   '1. å³é”®ç‚¹å‡»é«˜æ¸…å›¾ç‰‡\n' +
                   '2. é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"\n' +
                   '3. é€‰æ‹©ä¿å­˜ä½ç½®\n' +
                   '4. ç‚¹å‡»ä¿å­˜\n\n' +
                   'å¿«æ·é”®ï¼š\n' +
                   'â€¢ å³é”® + S: å¿«é€Ÿä¿å­˜\n' +
                   'â€¢ Ctrl+S: ä¿å­˜å½“å‰é¡µé¢\n\n' +
                   'ğŸ’¡ æç¤ºï¼šå»ºè®®ä¿å­˜ä¸ºPNGæ ¼å¼ä»¥ä¿è¯è´¨é‡ã€‚';
    }
    
    alert(`${title}\n\n${guideText}\n\nâœ¨ æç¤ºï¼šå›¾ç‰‡å·²å‡†å¤‡å¥½ï¼Œè¯·æŒ‰ä¸Šè¿°æ­¥éª¤æ“ä½œã€‚`);
}

// ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('fileName').textContent = 'å·²é€‰æ‹©: ' + file.name;
    const reader = new FileReader();
    reader.onload = function(event) {
        const img = new Image();
        img.onload = () => {
            uploadedImage = img;
            showToast('å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œè¯·ç‚¹å‡»ç”Ÿæˆå›¾çº¸', 'success');
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

// ä¿®å¤ï¼šåœ¨ç”Ÿæˆå›¾çº¸åç¡®ä¿æ­£ç¡®ç»‘å®šäº‹ä»¶
function generatePattern() {
    if (!uploadedImage) {
        showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼', 'error');
        return;
    }
    
    showLoading('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾çº¸...');
    
    setTimeout(() => {
        try {
            gridWidth = parseInt(document.getElementById('widthSlider').value);
            const paletteName = document.getElementById('paletteSelect').value;
            const palette = PALETTES[paletteName];
            
            if (!palette || palette.length === 0) {
                hideLoading();
                showToast('æ‰€é€‰è‰²æ¿æ²¡æœ‰å¯ç”¨é¢œè‰²ï¼Œè¯·é€‰æ‹©å…¶ä»–è‰²æ¿', 'error');
                return;
            }
            
            // è·å–å¤§æ ¼å­è¾¹æ¡†è®¾ç½®
            bigGridSize = parseInt(document.getElementById('bigGridSlider').value);
            
            const ratio = uploadedImage.height / uploadedImage.width;
            gridHeight = Math.round(gridWidth * ratio);
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gridWidth;
            tempCanvas.height = gridHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(uploadedImage, 0, 0, gridWidth, gridHeight);
            const imageData = tempCtx.getImageData(0, 0, gridWidth, gridHeight);
            const pixels = imageData.data;
            gridData = [];
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const i = (y * gridWidth + x) * 4;
                    const match = findClosestColor(pixels[i], pixels[i+1], pixels[i+2], palette);
                    gridData.push(match);
                }
            }
            calculateStats();
            renderCanvas();
            renderStatsTable();
            fitToScreen();
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('canvasWrapper').style.display = 'block';
            document.getElementById('zoomBar').style.display = 'flex';
            document.getElementById('downloadBtn').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'block';
            
            document.getElementById('colorReplaceSection').classList.add('show');
            
            // ç¡®ä¿æ­£ç¡®ç»‘å®šç‚¹å‡»äº‹ä»¶
            setTimeout(() => {
                updateStatsTableClickEvents();
                console.log('å›¾çº¸ç”Ÿæˆå®Œæˆï¼Œé¢œè‰²ç»Ÿè®¡æ•°é‡:', colorStats.length);
            }, 100);
            
            colorReplacements = {};
            originalGridData = [...gridData];
            originalColorStats = [...colorStats];
            selectedColor = null;
            selectedPaletteColor = null;
            similarColorGroups = []; // é‡ç½®ç›¸ä¼¼é¢œè‰²ç»„
            
            // é‡ç½®ç¼–è¾‘æ¨¡å¼
            isEditMode = false;
            document.getElementById('editToolbar').classList.remove('show');
            document.getElementById('mainCanvas').classList.remove('edit-mode');
            document.getElementById('editModeBtn').textContent = 'âœï¸ ç¼–è¾‘æ¨¡å¼';
            document.getElementById('editModeBtn').classList.remove('btn-success');
            document.getElementById('editModeBtn').classList.add('btn-outline');
            
            hideLoading();
            showToast('å›¾çº¸ç”ŸæˆæˆåŠŸï¼ç‚¹å‡»è‰²å·å¯è¿›è¡Œæ›¿æ¢', 'success');
            
            optimizeMobileStatsDisplay();
            
        } catch (error) {
            hideLoading();
            showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            console.error('ç”Ÿæˆå›¾çº¸æ—¶å‡ºé”™:', error);
        }
    }, 100);
}

function optimizeMobileStatsDisplay() {
    const statsPanel = document.getElementById('statsPanel');
    const statsTableWrap = document.querySelector('.stats-table-wrap');
    const isMobileDevice = window.innerWidth <= 900;
    
    if (isMobileDevice && colorStats.length > 0) {
        statsPanel.classList.add('auto-height');
        
        const estimatedHeight = colorStats.length * 35 + 120;
        
        statsPanel.style.minHeight = estimatedHeight + 'px';
        
        const maxHeight = window.innerHeight * 0.8;
        statsTableWrap.style.maxHeight = Math.min(estimatedHeight, maxHeight) + 'px';
        
        console.log('æ‰‹æœºç«¯ç»Ÿè®¡è¡¨æ ¼ä¼˜åŒ–å®Œæˆï¼Œé«˜åº¦:', estimatedHeight);
    } else {
        statsPanel.classList.remove('auto-height');
        statsPanel.style.minHeight = '';
        statsTableWrap.style.maxHeight = '400px';
    }
}

function calculateStats() {
    const usage = {};
    gridData.forEach(c => {
        if (!usage[c.id]) usage[c.id] = {...c, count: 0};
        usage[c.id].count++;
    });
    colorStats = Object.values(usage).sort((a, b) => b.count - a.count);
}

function findClosestColor(r, g, b, palette) {
    let minDist = Infinity;
    let closest = palette[0];
    for (const color of palette) {
        const dr = (r - color.rgb[0]) * 0.30;
        const dg = (g - color.rgb[1]) * 0.59;
        const db = (b - color.rgb[2]) * 0.11;
        const dist = dr*dr + dg*dg + db*db;
        if (dist < minDist) {
            minDist = dist;
            closest = color;
        }
    }
    return closest;
}

function renderHighResStatsCanvas() {
    const highResCanvas = document.getElementById('highResCanvas');
    const ctx = highResCanvas.getContext('2d');
    const padding = 30 * DOWNLOAD_SCALE_FACTOR;
    const rowHeight = 35 * DOWNLOAD_SCALE_FACTOR;
    const headerHeight = 90 * DOWNLOAD_SCALE_FACTOR;
    const width = 500 * DOWNLOAD_SCALE_FACTOR;
    const height = headerHeight + colorStats.length * rowHeight + padding * 2;
    
    highResCanvas.width = width;
    highResCanvas.height = height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.fillStyle = '#667eea';
    ctx.fillRect(0, 0, width, 60 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillStyle = '#ffffff';
    ctx.font = `bold ${20 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText('æ‹¼è±†è‰²å·ç»Ÿè®¡è¡¨', width/2, 35 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillStyle = '#333';
    ctx.font = `${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'left';
    const total = gridWidth * gridHeight;
    ctx.fillText(`å°ºå¯¸: ${gridWidth}Ã—${gridHeight}  |  æ€»ç æ•°: ${total}é¢—  |  é¢œè‰²æ•°: ${colorStats.length}ç§`, padding, 80 * DOWNLOAD_SCALE_FACTOR);
    
    const startY = headerHeight;
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(padding, startY, width - padding*2, rowHeight);
    ctx.fillStyle = '#333';
    ctx.font = `bold ${14 * DOWNLOAD_SCALE_FACTOR}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText('åºå·', padding + 30 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('è‰²å·', padding + 100 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('é¢œè‰²', padding + 180 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('æ•°é‡', padding + 300 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    ctx.fillText('å æ¯”', padding + 400 * DOWNLOAD_SCALE_FACTOR, startY + 22 * DOWNLOAD_SCALE_FACTOR);
    
    colorStats.forEach((c, i) => {
        const y = startY + (i + 1) * rowHeight;
        if (i % 2 === 0) {
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(padding, y, width - padding*2, rowHeight);
        }
        ctx.fillStyle = '#333';
        ctx.font = `${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.textAlign = 'center';
        ctx.fillText(i + 1, padding + 30 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.font = `bold ${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.fillText(c.id, padding + 100 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
        ctx.fillRect(padding + 165 * DOWNLOAD_SCALE_FACTOR, y + 10 * DOWNLOAD_SCALE_FACTOR, 35 * DOWNLOAD_SCALE_FACTOR, 20 * DOWNLOAD_SCALE_FACTOR);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
        ctx.strokeRect(padding + 165 * DOWNLOAD_SCALE_FACTOR, y + 10 * DOWNLOAD_SCALE_FACTOR, 35 * DOWNLOAD_SCALE_FACTOR, 20 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillStyle = '#333';
        ctx.font = `${13 * DOWNLOAD_SCALE_FACTOR}px Arial`;
        ctx.fillText(c.count, padding + 300 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
        ctx.fillText((c.count / total * 100).toFixed(1) + '%', padding + 400 * DOWNLOAD_SCALE_FACTOR, y + 22 * DOWNLOAD_SCALE_FACTOR);
    });
    
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1 * DOWNLOAD_SCALE_FACTOR;
    ctx.strokeRect(padding, startY, width - padding*2, (colorStats.length + 1) * rowHeight);
}

function fitToScreen() {
    const canvas = document.getElementById('mainCanvas');
    const container = document.getElementById('previewArea');
    const scaleX = (container.clientWidth - 20) / canvas.width;
    const scaleY = (container.clientHeight - 20) / canvas.height;
    canvasScale = Math.min(scaleX, scaleY, 1);
    applyScale();
}

function zoomCanvas(delta) {
    canvasScale = Math.max(0.1, Math.min(3, canvasScale + delta));
    applyScale();
}

function applyScale() {
    const wrapper = document.getElementById('canvasWrapper');
    const canvas = document.getElementById('mainCanvas');
    wrapper.style.width = (canvas.width * canvasScale) + 'px';
    wrapper.style.height = (canvas.height * canvasScale) + 'px';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
}

function openDownloadModal() {
    if (!colorStats || colorStats.length === 0 || gridData.length === 0) {
        showToast('è¯·å…ˆç”Ÿæˆå›¾çº¸ï¼', 'error');
        return;
    }
    
    try {
        const canvas = document.getElementById('mainCanvas');
        if (canvas) {
            document.getElementById('downloadImage').src = canvas.toDataURL('image/png');
        }
        
        renderStatsCanvas();
        const statsCanvas = document.getElementById('statsCanvas');
        if (statsCanvas) {
            document.getElementById('downloadStatsImage').src = statsCanvas.toDataURL('image/png');
        }
        
        document.getElementById('downloadModal').classList.add('show');
        updateDownloadHint();
        switchTab(document.querySelector('.modal-tab'), 'pattern');
        showToast('ä¸‹è½½é¢„è§ˆå·²å‡†å¤‡å°±ç»ª', 'success');
    } catch (error) {
        console.error('æ‰“å¼€ä¸‹è½½æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
        showToast('æ‰“å¼€ä¸‹è½½çª—å£å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

function closeModal() {
    document.getElementById('downloadModal').classList.remove('show');
}

function switchTab(btn, tab) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tabPattern').style.display = tab === 'pattern' ? 'block' : 'none';
    document.getElementById('tabStats').style.display = tab === 'stats' ? 'block' : 'none';
}

function showDownloadOptions(type) {
    currentDownloadType = type;
    
    if (rememberedChoice && rememberChoiceChecked) {
        if (rememberedChoice === 'browser') {
            saveToBrowser();
        } else if (rememberedChoice === 'album') {
            saveToPhotoAlbum();
        } else if (rememberedChoice === 'manual') {
            manualSave();
        }
        return;
    }
    
    document.getElementById('downloadOptions').classList.add('show');
}

function hideDownloadOptions() {
    document.getElementById('downloadOptions').classList.remove('show');
}

function updateRememberChoice(choice) {
    rememberChoiceChecked = document.getElementById('rememberChoice').checked;
    
    if (rememberChoiceChecked) {
        rememberedChoice = choice;
        localStorage.setItem('rememberDownloadChoice', 'true');
        localStorage.setItem('downloadChoice', choice);
    }
}

function renderStatsCanvas() {
    const statsCanvas = document.getElementById('statsCanvas');
    if (!statsCanvas || !colorStats || colorStats.length === 0) return;
    
    const ctx = statsCanvas.getContext('2d');
    const padding = 30;
    const rowHeight = 35;
    const headerHeight = 90;
    const width = 500;
    const height = headerHeight + colorStats.length * rowHeight + padding * 2;
    
    statsCanvas.width = width;
    statsCanvas.height = height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.fillStyle = '#667eea';
    ctx.fillRect(0, 0, width, 60);
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('æ‹¼è±†è‰²å·ç»Ÿè®¡è¡¨', width/2, 35);
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    const total = gridWidth * gridHeight;
    ctx.fillText(`å°ºå¯¸: ${gridWidth}Ã—${gridHeight}  |  æ€»ç æ•°: ${total}é¢—  |  é¢œè‰²æ•°: ${colorStats.length}ç§`, padding, 80);
    
    const startY = headerHeight;
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(padding, startY, width - padding*2, rowHeight);
    ctx.fillStyle = '#333';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('åºå·', padding + 30, startY + 22);
    ctx.fillText('è‰²å·', padding + 100, startY + 22);
    ctx.fillText('é¢œè‰²', padding + 180, startY + 22);
    ctx.fillText('æ•°é‡', padding + 300, startY + 22);
    ctx.fillText('å æ¯”', padding + 400, startY + 22);
    
    colorStats.forEach((c, i) => {
        const y = startY + (i + 1) * rowHeight;
        if (i % 2 === 0) {
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(padding, y, width - padding*2, rowHeight);
        }
        ctx.fillStyle = '#333';
        ctx.font = '13px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(i + 1, padding + 30, y + 22);
        ctx.font = 'bold 13px Arial';
        ctx.fillText(c.id, padding + 100, y + 22);
        ctx.fillStyle = `rgb(${c.rgb[0]},${c.rgb[1]},${c.rgb[2]})`;
        ctx.fillRect(padding + 165, y + 10, 35, 20);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.strokeRect(padding + 165, y + 10, 35, 20);
        ctx.fillStyle = '#333';
        ctx.font = '13px Arial';
        ctx.fillText(c.count, padding + 300, y + 22);
        ctx.fillText((c.count / total * 100).toFixed(1) + '%', padding + 400, y + 22);
    });
    
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.strokeRect(padding, startY, width - padding*2, (colorStats.length + 1) * rowHeight);
}

function updateDownloadHint() {
    const hintText = isMobile() ? 
        'é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œï¼Œæˆ–ç‚¹å‡»ä¸‹è½½æŒ‰é’®é€‰æ‹©ä¿å­˜æ–¹å¼' : 
        'å³é”®å›¾ç‰‡é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"ï¼Œæˆ–ç‚¹å‡»ä¸‹è½½æŒ‰é’®é€‰æ‹©ä¿å­˜æ–¹å¼';
    
    document.getElementById('downloadHint').textContent = hintText;
    document.getElementById('downloadStatsHint').textContent = hintText;
}

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    updateDownloadHint();
    
    const downloadImage = document.getElementById('downloadImage');
    const downloadStatsImage = document.getElementById('downloadStatsImage');
    
    if (downloadImage) {
        downloadImage.addEventListener('touchstart', function() {
            if (isMobile()) {
                showToast('é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜é«˜æ¸…ç‰ˆæœ¬åˆ°æ‰‹æœºç›¸å†Œ', 'info');
            }
        }, { passive: true });
    }
    
    if (downloadStatsImage) {
        downloadStatsImage.addEventListener('touchstart', function() {
            if (isMobile()) {
                showToast('é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜é«˜æ¸…ç‰ˆæœ¬åˆ°æ‰‹æœºç›¸å†Œ', 'info');
            }
        }, { passive: true });
    }
    
    const downloadBtn = document.getElementById('downloadBtn');
    if (downloadBtn) {
        console.log('ä¸‹è½½æŒ‰é’®å·²æ‰¾åˆ°');
    }
    
    // æ·»åŠ ç”»å¸ƒç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
    const canvas = document.getElementById('mainCanvas');
    canvas.addEventListener('click', handleCanvasClick);
    
    // åˆå§‹åŒ–å¤§æ ¼å­è¾¹æ¡†æ»‘å—æè¿°æ–‡æœ¬
    updateBigGridSliderText();
    
    // ç›‘å¬å¤§æ ¼å­è¾¹æ¡†æ»‘å—å˜åŒ–
    document.getElementById('bigGridSlider').addEventListener('input', function() {
        updateBigGridSliderText();
        if (gridData.length > 0) {
            showLoading('æ­£åœ¨æ›´æ–°å›¾çº¸...');
            setTimeout(() => {
                renderCanvas();
                fitToScreen();
                hideLoading();
                showToast('å›¾çº¸å·²æ›´æ–°', 'success');
            }, 100);
        }
    });
});

function updateBigGridSliderText() {
    const value = document.getElementById('bigGridSlider').value;
    const label = document.getElementById('bigGridVal');
    label.textContent = value + ' æ ¼';
    
    // æ›´æ–°æè¿°æ–‡æœ¬
    const description = document.querySelector('#bigGridSlider').nextElementSibling;
    if (description) {
        description.textContent = `æ¯ ${value}Ã—${value} ä¸ªå°æ ¼å­ç»„æˆä¸€ä¸ªå¤§æ ¼å­å¹¶åŠ ç²—è¾¹æ¡†`;
    }
}

// ç›‘å¬æ˜¾ç¤ºé€‰é¡¹å˜åŒ–
['showGrid', 'showCode', 'showLegend', 'showRuler'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
        if (gridData.length > 0) {
            showLoading('æ­£åœ¨æ›´æ–°å›¾çº¸...');
            setTimeout(() => {
                renderCanvas();
                fitToScreen();
                hideLoading();
                showToast('å›¾çº¸å·²æ›´æ–°', 'success');
            }, 100);
        }
    });
});

window.addEventListener('resize', function() {
    if (colorStats.length > 0) {
        optimizeMobileStatsDisplay();
    }
});
</script>
</body>
</html>
